<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏õ‡∏µ {{ year }}</title>
    <script src="{{ url_for('static', filename='js/tailwind.min.js') }}"></script>
    <style>
        .btn-animate {
            transition: all 0.2s ease;
        }
        .btn-animate:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .btn-animate:active {
            transform: translateY(0);
        }
        .smooth-transition {
            transition: all 0.3s ease;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 min-h-screen">
    <!-- Mobile Header -->
    <div class="lg:hidden fixed top-0 left-0 w-full bg-white shadow-lg z-50">
        <div class="flex items-center justify-between p-4">
            <h1 class="text-xl font-bold text-gray-800">üìä ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö-‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ {{ year }}</h1>
            <button id="mobile-menu-btn" class="text-gray-600 hover:text-gray-800 focus:outline-none">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                </svg>
            </button>
        </div>
        
        <!-- Mobile Menu -->
        <div id="mobile-menu" class="hidden bg-white border-t">
            <nav class="py-2">
                <a href="/index" class="block px-4 py-3 text-gray-700 hover:bg-gray-100 border-b">üìÖ OT Records</a>
                <a href="/income-expense" class="block px-4 py-3 bg-green-100 text-green-700 font-medium border-b">üí∞ Income/Expense</a>
                <a href="/holidays" class="block px-4 py-3 text-gray-700 hover:bg-gray-100 border-b">üéâ Holidays</a>
                <a href="/import-csv" class="block px-4 py-3 text-gray-700 hover:bg-gray-100 border-b">üìä Import CSV</a>
                <a href="/import-ot-csv" class="block px-4 py-3 text-gray-700 hover:bg-gray-100 border-b">‚è∞ Import OT CSV</a>
                <div class="px-4 py-3 border-b">
                    <span class="text-sm text-gray-500">üë§ {{ session.user_email }}</span>
                </div>
                <a href="/logout" class="block px-4 py-3 text-red-600 hover:bg-red-50">üö™ Logout</a>
            </nav>
        </div>
    </div>

    <!-- Desktop Sidebar -->
    <div class="hidden lg:block fixed top-0 left-0 w-64 h-full bg-white shadow-lg z-40">
        <div class="p-6">
            <h1 class="text-2xl font-bold text-gray-800 mb-8">üìä ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</h1>
            <nav class="space-y-2">
                <a href="/index" class="block px-4 py-3 text-gray-700 hover:bg-gray-100 rounded-lg smooth-transition">üìÖ OT Records</a>
                <a href="/income-expense" class="block px-4 py-3 bg-green-100 text-green-700 font-medium rounded-lg">üí∞ Income/Expense</a>
                <a href="/holidays" class="block px-4 py-3 text-gray-700 hover:bg-gray-100 rounded-lg smooth-transition">üéâ Holidays</a>
                <a href="/import-csv" class="block px-4 py-3 text-gray-700 hover:bg-gray-100 rounded-lg smooth-transition">üìä Import CSV</a>
                <a href="/import-ot-csv" class="block px-4 py-3 text-gray-700 hover:bg-gray-100 rounded-lg smooth-transition">‚è∞ Import OT CSV</a>
            </nav>
            <div class="mt-8 pt-6 border-t">
                <div class="px-4 py-2">
                    <span class="text-sm text-gray-500">üë§ {{ session.user_email }}</span>
                </div>
                <a href="/logout" class="block px-4 py-3 text-red-600 hover:bg-red-50 rounded-lg smooth-transition">üö™ Logout</a>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="lg:ml-64 pt-20 lg:pt-6 p-4 lg:p-6">
        <!-- Page Header -->
        <div class="mb-6">
            <div class="flex items-center justify-between">
                <h1 class="text-2xl lg:text-3xl font-bold">üìä ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö-‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ ‡∏õ‡∏µ {{ year }}</h1>
                <a href="/income-expense" class="btn-animate bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg">
                    ‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
                </a>
            </div>
        </div>

        <!-- Yearly Summary Cards -->
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-4 mb-6">
            <div class="bg-green-100 p-4 rounded-lg text-center">
                <div class="text-green-800 font-bold text-xl">{{ "%.2f"|format(yearly_income) }}</div>
                <div class="text-green-600 text-sm">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏£‡∏ß‡∏° (‡∏ö‡∏≤‡∏ó)</div>
            </div>
            <div class="bg-red-100 p-4 rounded-lg text-center">
                <div class="text-red-800 font-bold text-xl">{{ "%.2f"|format(yearly_expense) }}</div>
                <div class="text-red-600 text-sm">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏ß‡∏° (‡∏ö‡∏≤‡∏ó)</div>
            </div>
            <div class="bg-blue-100 p-4 rounded-lg text-center">
                <div class="text-blue-800 font-bold text-xl">{{ "%.2f"|format(yearly_income - yearly_expense) }}</div>
                <div class="text-blue-600 text-sm">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ (‡∏ö‡∏≤‡∏ó)</div>
            </div>
            <div class="bg-purple-100 p-4 rounded-lg text-center">
                <div class="text-purple-800 font-bold text-xl">{{ records|length }}</div>
                <div class="text-purple-600 text-sm">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
            </div>
        </div>

        <!-- Export Buttons -->
        <div class="bg-white p-4 lg:p-6 rounded-lg shadow-md mb-6">
            <h2 class="text-lg lg:text-xl font-semibold mb-4">üìä Export ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏õ‡∏µ</h2>
            <div class="flex flex-wrap gap-2">
                <button onclick="exportYearData('all', '{{ year }}')" 
                        class="btn-animate bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm">
                    üìÑ Export ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                </button>
                <button onclick="exportYearData('income', '{{ year }}')" 
                        class="btn-animate bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg text-sm">
                    üí∞ Export ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö
                </button>
                <button onclick="exportYearData('expense', '{{ year }}')" 
                        class="btn-animate bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm">
                    üí∏ Export ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢
                </button>
                <button onclick="showYearlySummary()" 
                        class="btn-animate bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg text-sm">
                    üìã ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏õ‡∏µ
                </button>
            </div>
        </div>

        <!-- Monthly Breakdown -->
        <div class="bg-white rounded-lg shadow-md overflow-hidden mb-6">
            <div class="p-4 lg:p-6 border-b">
                <h2 class="text-lg lg:text-xl font-semibold">üìÖ ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</h2>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</th>
                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö (‡∏ö‡∏≤‡∏ó)</th>
                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ (‡∏ö‡∏≤‡∏ó)</th>
                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ (‡∏ö‡∏≤‡∏ó)</th>
                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if monthly_data %}
                            {% for month in monthly_data %}
                                {% set month_income = month.income or 0 %}
                                {% set month_expense = month.expense or 0 %}
                                {% set month_balance = month_income - month_expense %}
                                <tr class="border-b hover:bg-gray-50">
                                    <td class="px-4 py-3 text-sm font-medium">
                                        {% set month_name = month.month.split('-')[1] %}
                                        {% if month_name == '01' %}‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°
                                        {% elif month_name == '02' %}‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå
                                        {% elif month_name == '03' %}‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°
                                        {% elif month_name == '04' %}‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô
                                        {% elif month_name == '05' %}‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°
                                        {% elif month_name == '06' %}‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô
                                        {% elif month_name == '07' %}‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°
                                        {% elif month_name == '08' %}‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°
                                        {% elif month_name == '09' %}‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô
                                        {% elif month_name == '10' %}‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°
                                        {% elif month_name == '11' %}‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô
                                        {% elif month_name == '12' %}‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°
                                        {% endif %} {{ year }}
                                    </td>
                                    <td class="px-4 py-3 text-sm text-green-600 font-medium">{{ "%.2f"|format(month_income) }}</td>
                                    <td class="px-4 py-3 text-sm text-red-600 font-medium">{{ "%.2f"|format(month_expense) }}</td>
                                    <td class="px-4 py-3 text-sm font-medium {% if month_balance > 0 %}text-green-600{% elif month_balance < 0 %}text-red-600{% else %}text-gray-600{% endif %}">
                                        {{ "%.2f"|format(month_balance) }}
                                    </td>
                                    <td class="px-4 py-3 text-sm text-center">{{ month.count }}</td>
                                    <td class="px-4 py-3 text-sm">
                                        <a href="/income-expense?month={{ month.month }}" 
                                           class="text-blue-600 hover:text-blue-800">
                                            üëÅÔ∏è ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
                                        </a>
                                    </td>
                                </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="6" class="px-4 py-8 text-center text-gray-500">
                                    <div class="text-4xl mb-2">üì≠</div>
                                    <div>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏õ‡∏µ‡∏ô‡∏µ‡πâ</div>
                                </td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- All Records Table -->
        <div class="bg-white rounded-lg shadow-md overflow-hidden">
            <div class="p-4 lg:p-6 border-b">
                <h2 class="text-lg lg:text-xl font-semibold">üìä ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏õ‡∏µ {{ year }}</h2>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th>
                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if records %}
                            {% for record in records %}
                                <tr class="border-b hover:bg-gray-50">
                                    <td class="px-4 py-3 text-sm">{{ record.date }}</td>
                                    <td class="px-4 py-3 text-sm">{{ record.description }}</td>
                                    <td class="px-4 py-3 text-sm font-medium {% if record.category == 'income' %}text-green-600{% else %}text-red-600{% endif %}">
                                        {{ "%.2f"|format(record.amount) }}
                                    </td>
                                    <td class="px-4 py-3 text-sm">{{ record.vendor or '-' }}</td>
                                    <td class="px-4 py-3 text-sm">
                                        <span class="px-2 py-1 rounded-full text-xs {% if record.category == 'income' %}bg-green-100 text-green-700{% else %}bg-red-100 text-red-700{% endif %}">
                                            {% if record.category == 'income' %}üí∞ ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö{% else %}üí∏ ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢{% endif %}
                                        </span>
                                    </td>
                                    <td class="px-4 py-3 text-sm">
                                        <div class="flex gap-2">
                                            <a href="/edit-income-expense/{{ record.id }}" 
                                               class="text-blue-600 hover:text-blue-800 text-sm">
                                                ‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                                            </a>
                                            <form method="POST" action="/delete-income-expense/{{ record.id }}" 
                                                  class="inline" onsubmit="return confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')">
                                                <button type="submit" class="text-red-600 hover:text-red-800 text-sm">
                                                    üóëÔ∏è ‡∏•‡∏ö
                                                </button>
                                            </form>
                                        </div>
                                    </td>
                                </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="6" class="px-4 py-8 text-center text-gray-500">
                                    <div class="text-4xl mb-2">üì≠</div>
                                    <div>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏õ‡∏µ‡∏ô‡∏µ‡πâ</div>
                                </td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Mobile Menu Toggle
        const mobileMenuBtn = document.getElementById('mobile-menu-btn');
        const mobileMenu = document.getElementById('mobile-menu');
        
        mobileMenuBtn.addEventListener('click', () => {
            mobileMenu.classList.toggle('hidden');
        });

        // Close mobile menu when clicking outside
        document.addEventListener('click', (e) => {
            if (!mobileMenuBtn.contains(e.target) && !mobileMenu.contains(e.target)) {
                mobileMenu.classList.add('hidden');
            }
        });

        // Export Year Data Function
        function exportYearData(category, year) {
            const url = `/export-${category}/${year}`;
            window.open(url, '_blank');
        }

        // Show Yearly Summary Function
        function showYearlySummary() {
            const yearlyIncome = parseFloat('{{ yearly_income }}') || 0;
            const yearlyExpense = parseFloat('{{ yearly_expense }}') || 0;
            const balance = yearlyIncome - yearlyExpense;
            const totalRecords = parseInt('{{ records|length }}') || 0;
            
            let summary = `üìã ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏õ‡∏µ: {{ year }}\n\n`;
            summary += `üí∞ ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏£‡∏ß‡∏°: ${yearlyIncome.toFixed(2)} ‡∏ö‡∏≤‡∏ó\n`;
            summary += `üí∏ ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏ß‡∏°: ${yearlyExpense.toFixed(2)} ‡∏ö‡∏≤‡∏ó\n`;
            summary += `üìä ‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${balance.toFixed(2)} ‡∏ö‡∏≤‡∏ó\n`;
            summary += `üìù ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£: ${totalRecords} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£\n\n`;
            
            if (balance > 0) {
                summary += `‚úÖ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏°‡∏µ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏´‡∏•‡∏∑‡∏≠ (‡∏Å‡∏≥‡πÑ‡∏£)\n`;
            } else if (balance < 0) {
                summary += `‚ö†Ô∏è ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡πÉ‡∏ä‡πâ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô (‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô)\n`;
            } else {
                summary += `‚öñÔ∏è ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢\n`;
            }
            
            // Add percentage analysis
            if (yearlyIncome > 0) {
                const expensePercentage = ((yearlyExpense / yearlyIncome) * 100).toFixed(1);
                summary += `üìà ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏ï‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö: ${expensePercentage}%\n`;
            }
            
            // Add monthly average
            const monthlyIncome = (yearlyIncome / 12).toFixed(2);
            const monthlyExpense = (yearlyExpense / 12).toFixed(2);
            summary += `üìÖ ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô: ${monthlyIncome} ‡∏ö‡∏≤‡∏ó\n`;
            summary += `üìÖ ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô: ${monthlyExpense} ‡∏ö‡∏≤‡∏ó\n`;
            
            alert(summary);
        }
    </script>
</body>
</html> 