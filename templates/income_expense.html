<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>รายรับรายจ่าย</title>
    <script src="{{ url_for('static', filename='js/tailwind.min.js') }}"></script>
    <style>
        /* Custom styles for mobile responsiveness */
        @media (max-width: 768px) {
            .mobile-responsive {
                font-size: 14px;
            }
        }
        
        /* Animation for buttons */
        .btn-animate {
            transition: all 0.2s ease;
        }
        .btn-animate:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .btn-animate:active {
            transform: translateY(0);
        }
        
        /* Quick Add Button Animation */
        .quick-add-btn {
            transition: all 0.2s ease;
        }
        .quick-add-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .quick-add-btn:active {
            transform: translateY(0);
        }
        
        /* Modal Animation */
        .modal-enter {
            animation: modalEnter 0.3s ease-out;
        }
        
        @keyframes modalEnter {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }
        
        /* Smooth transitions */
        .smooth-transition {
            transition: all 0.3s ease;
        }
        
        /* Table styles */
        .items-table {
            border-collapse: collapse;
                width: 100%;
        }
        
        .items-table th {
            background-color: #f9fafb;
            border: 1px solid #e5e7eb;
            padding: 8px 12px;
            text-align: left;
            font-size: 12px;
                font-weight: 600;
            color: #374151;
        }
        
        .items-table td {
            border: 1px solid #e5e7eb;
            padding: 8px 12px;
            vertical-align: middle;
        }
        
        .items-table tr:hover {
            background-color: #f9fafb;
        }
        
        .items-table .total-row {
            background-color: #f3f4f6;
            font-weight: 600;
        }
        
        .items-table .total-row td {
            border-top: 2px solid #d1d5db;
        }
        
        /* Mobile table styles */
        .mobile-table {
            font-size: 10px;
        }
        
        .mobile-table th {
            padding: 4px 6px;
            font-size: 10px;
            white-space: nowrap;
        }
        
        .mobile-table td {
            padding: 4px 6px;
            font-size: 10px;
        }
        
        .mobile-table input,
        .mobile-table select {
            font-size: 10px;
            padding: 2px 4px;
            min-width: 40px;
        }
        
        .mobile-table button {
            font-size: 9px;
            padding: 1px 2px;
        }
        
        .mobile-table .w-5 {
            width: 1.25rem;
            height: 1.25rem;
        }
        
        /* Ensure table fits on mobile without horizontal scroll */
        @media (max-width: 768px) {
            .mobile-table {
                table-layout: fixed;
                width: 100%;
            }
            
            .mobile-table th:nth-child(1) { width: 8%; }  /* # */
            .mobile-table th:nth-child(2) { width: 20%; } /* ชื่อ */
            .mobile-table th:nth-child(3) { width: 15%; } /* แท็ก */
            .mobile-table th:nth-child(4) { width: 18%; } /* ราคา */
            .mobile-table th:nth-child(5) { width: 15%; } /* จำนวน */
            .mobile-table th:nth-child(6) { width: 12%; } /* รวม */
            .mobile-table th:nth-child(7) { width: 12%; } /* จัดการ */
        }
        
        /* Mobile responsive styles */
        @media (max-width: 768px) {
            .mobile-card {
                background: white;
                border-radius: 8px;
                padding: 12px;
                margin-bottom: 12px;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }
            
            .mobile-item-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 8px;
            }
            
            .mobile-item-number {
                background: #3b82f6;
                color: white;
                width: 24px;
                height: 24px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 12px;
                font-weight: bold;
            }
            
            .mobile-item-actions {
                display: flex;
                gap: 4px;
            }
            
            .mobile-item-field {
                margin-bottom: 8px;
            }
            
            .mobile-item-label {
                font-size: 11px;
                font-weight: 600;
                color: #6b7280;
                margin-bottom: 4px;
            }
            
            .mobile-item-input {
                width: 100%;
                border: 1px solid #d1d5db;
                border-radius: 4px;
                padding: 6px 8px;
                font-size: 14px;
            }
            
            .mobile-item-select {
                width: 100%;
                border: 1px solid #d1d5db;
                border-radius: 4px;
                padding: 6px 8px;
                font-size: 14px;
            }
            
            .mobile-controls {
                display: flex;
                gap: 4px;
                align-items: center;
            }
            
            .mobile-control-btn {
                background: #f3f4f6;
                border: 1px solid #d1d5db;
                border-radius: 4px;
                width: 24px;
                height: 24px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 12px;
                color: #6b7280;
            }
            
            .mobile-control-btn:hover {
                background: #e5e7eb;
            }
            
            .mobile-total {
                font-weight: 600;
                color: #059669;
                text-align: right;
            }
            
            .mobile-form-grid {
                display: grid;
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            .mobile-form-row {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 8px;
            }
            
            .mobile-form-full {
                grid-column: 1 / -1;
            }
            
            .mobile-button {
                width: 100%;
                padding: 12px;
                border-radius: 8px;
                font-weight: 600;
                font-size: 14px;
                border: none;
                cursor: pointer;
            }
            
            .mobile-button-primary {
                background: #3b82f6;
                color: white;
            }
            
            .mobile-button-secondary {
                background: #6b7280;
                color: white;
            }
            
            .mobile-button-success {
                background: #059669;
                color: white;
            }
            
            .mobile-button-danger {
                background: #dc2626;
                color: white;
            }
            
            .mobile-summary-cards {
                display: grid;
                grid-template-columns: 1fr;
                gap: 8px;
                margin-bottom: 16px;
            }
            
            .mobile-summary-card {
                padding: 12px;
                border-radius: 8px;
                text-align: center;
            }
            
            .mobile-summary-value {
                font-size: 18px;
                font-weight: bold;
                margin-bottom: 4px;
            }
            
            .mobile-summary-label {
                font-size: 12px;
                opacity: 0.8;
            }
            
            /* Mobile Items Display Optimization */
            .mobile-items-container {
                max-height: 60vh;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .mobile-item-card {
                transition: all 0.2s ease;
            }
            
            .mobile-item-card:focus-within {
                box-shadow: 0 0 0 2px #3b82f6;
            }
            
            .mobile-input-touch {
                min-height: 44px; /* iOS touch target minimum */
                font-size: 16px; /* Prevent zoom on iOS */
            }
            
            .mobile-button-touch {
                min-height: 44px;
                min-width: 44px;
                touch-action: manipulation;
            }
            
            /* Mobile table optimization */
            .mobile-table {
                font-size: 12px;
            }
            
            .mobile-table th,
            .mobile-table td {
                padding: 4px;
                vertical-align: middle;
            }
            
            .mobile-table input,
            .mobile-table select {
                font-size: 12px;
                padding: 2px 4px;
            }
            
            /* Desktop table optimization */
            .items-table {
                box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
                border-radius: 8px;
                overflow: hidden;
            }
            
            .items-table th {
                background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
                font-weight: 600;
                text-transform: uppercase;
                letter-spacing: 0.05em;
            }
            
            .items-table tr:hover {
                background-color: #f8fafc;
                transition: background-color 0.2s ease;
            }
            
            .items-table input:focus,
            .items-table select:focus {
                box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
                border-color: #3b82f6;
            }
            
            .items-table button {
                transition: all 0.2s ease;
            }
            
            .items-table button:hover {
                transform: translateY(-1px);
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            }
            
            /* Mobile table responsive */
            .mobile-table-responsive {
                display: block;
                overflow-x: auto;
                white-space: nowrap;
                -webkit-overflow-scrolling: touch;
            }
            
            .mobile-table-responsive table {
                min-width: 800px;
            }
            

            
        @media (max-width: 768px) {
                /* Make table responsive on mobile */
                .overflow-x-auto {
                    overflow-x: auto;
                    -webkit-overflow-scrolling: touch;
                }
                
                table {
                    min-width: 800px;
                }
                
                th, td {
                    padding: 8px 4px;
                    font-size: 12px;
                }
                
                .px-4 {
                    padding-left: 8px;
                    padding-right: 8px;
                }
                
                .py-4 {
                    padding-top: 8px;
                    padding-bottom: 8px;
                }
                
                /* Improve table readability on mobile */
                .bg-white {
                    border-radius: 8px;
                    margin: 8px;
                }
                
                /* Make buttons smaller on mobile */
                .bg-blue-500, .bg-red-500, .bg-gray-500 {
                    padding: 6px 8px;
                    font-size: 11px;
                }
                
                /* Adjust table header */
                th {
                    font-size: 11px;
                    font-weight: 600;
                    white-space: nowrap;
                }
                
                /* Make text smaller in cells */
                td {
                    font-size: 11px;
                }
                
                /* Improve spacing */
                .p-4 {
                    padding: 12px;
                }
                
                .lg\\:p-6 {
                    padding: 12px;
                }
            }
            

            
            /* Mobile form improvements */
            .mobile-form-section {
                background: white;
                border-radius: 12px;
                padding: 16px;
                margin-bottom: 16px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            }
            
            .mobile-form-label {
                display: block;
                font-size: 14px;
                font-weight: 600;
                color: #374151;
                margin-bottom: 8px;
            }
            
            .mobile-form-input {
                width: 100%;
                padding: 12px;
                border: 2px solid #e5e7eb;
                border-radius: 8px;
                font-size: 16px;
                transition: border-color 0.2s ease;
            }
            
            .mobile-form-input:focus {
                outline: none;
                border-color: #3b82f6;
                box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            }
            
            .mobile-form-select {
                width: 100%;
                padding: 12px;
                border: 2px solid #e5e7eb;
                border-radius: 8px;
                font-size: 16px;
                background-color: white;
                transition: border-color 0.2s ease;
            }
            
            .mobile-form-select:focus {
                outline: none;
                border-color: #3b82f6;
                box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            }
            
            .mobile-button {
                padding: 12px 16px;
                border-radius: 8px;
                font-size: 14px;
                font-weight: 600;
                border: none;
                cursor: pointer;
                transition: all 0.2s ease;
            }
            
            /* Mobile card animations and improvements */
            @media (max-width: 768px) {
                /* Card hover effects */
                .bg-white {
                    transition: all 0.2s ease-in-out;
                }
                
                .bg-white:hover {
                transform: translateY(-2px);
                    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
                }
                
                /* Larger touch targets for mobile */
                button {
                    min-height: 44px;
                    min-width: 44px;
                }
                
                /* Better spacing for mobile */
                .space-y-4 > * + * {
                    margin-top: 1rem;
                }
                
                /* Improved input styling */
                input[type="number"], input[type="text"], select {
                    font-size: 16px;
                    padding: 12px;
                    border-radius: 8px;
                }
                
                /* Better button styling */
                button {
                    border-radius: 8px;
                    font-weight: 500;
                }
                
                /* Card improvements */
                .rounded-xl {
                    border-radius: 12px;
                }
                
                /* Better shadows */
                .shadow-sm {
                    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
                }
                
                /* Improved gradients */
                .bg-gradient-to-r {
                    background: linear-gradient(to right, var(--tw-gradient-stops));
                }
            }
            
            .mobile-button-primary {
                background: #3b82f6;
                color: white;
            }
            
            .mobile-button-primary:hover {
                background: #2563eb;
                transform: translateY(-1px);
            }
            
            .mobile-button-success {
                background: #10b981;
                color: white;
            }
            
            .mobile-button-success:hover {
                background: #059669;
                transform: translateY(-1px);
            }
            
            .mobile-submit-btn {
                width: 100%;
                padding: 16px;
                background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
                color: white;
                border: none;
                border-radius: 12px;
                font-size: 16px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.2s ease;
                box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
            }
            
            .mobile-submit-btn:hover {
                transform: translateY(-2px);
                box-shadow: 0 6px 16px rgba(59, 130, 246, 0.4);
            }
            
            .mobile-submit-btn:active {
                transform: translateY(0);
            }
            
            .mobile-input-touch {
                -webkit-appearance: none;
                -moz-appearance: none;
                appearance: none;
            }
            
            .mobile-button-touch {
                -webkit-tap-highlight-color: transparent;
                touch-action: manipulation;
            }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 min-h-screen">
    <!-- Mobile Header -->
    <div class="lg:hidden fixed top-0 left-0 w-full bg-white shadow-lg z-50">
        <div class="flex items-center justify-between p-4">
            <h1 class="text-xl font-bold text-gray-800">💰 รายรับ-รายจ่าย</h1>
            <button id="mobile-menu-btn" class="text-gray-600 hover:text-gray-800 focus:outline-none">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                </svg>
            </button>
        </div>
        
        <!-- Mobile Menu -->
        <div id="mobile-menu" class="hidden bg-white border-t">
            <nav class="py-2">
                <a href="/index" class="block px-4 py-3 text-gray-700 hover:bg-gray-100 border-b">📅 บันทึกโอที</a>
                <a href="/income-expense" class="block px-4 py-3 bg-green-100 text-green-700 font-medium border-b">💰 รายรับ/รายจ่าย</a>
                <a href="/holidays" class="block px-4 py-3 text-gray-700 hover:bg-gray-100 border-b">🎉 วันหยุด</a>
                <a href="/import-csv" class="block px-4 py-3 text-gray-700 hover:bg-gray-100 border-b">📊 นำเข้า CSV รายรับ/รายจ่าย</a>
                <a href="/import-ot-csv" class="block px-4 py-3 text-gray-700 hover:bg-gray-100 border-b">⏰ นำเข้า CSV โอที</a>
                <a href="/settings" class="block px-4 py-3 text-gray-700 hover:bg-gray-100 border-b">⚙️ ตั้งค่า</a>
                <div class="px-4 py-3 border-b">
                    {% if session.user_picture %}
                        <div class="flex items-center gap-3">
                            <img src="{{ session.user_picture }}" alt="Profile" class="w-6 h-6 rounded-full">
                            <div>
                                <div class="text-sm font-medium text-gray-800">{{ session.user_name or session.user_email }}</div>
                                <div class="text-xs text-gray-500">{{ session.user_email }}</div>
                            </div>
                        </div>
                    {% else %}
                    <span class="text-sm text-gray-500">👤 {{ session.user_email }}</span>
                    {% endif %}
                </div>
                <a href="/logout" class="block px-4 py-3 text-red-600 hover:bg-red-50">🚪 ออกจากระบบ</a>
            </nav>
        </div>
    </div>

    <!-- Desktop Sidebar -->
    <div class="hidden lg:block fixed top-0 left-0 w-64 h-full bg-white shadow-lg z-40">
        <div class="p-6">
            <h1 class="text-2xl font-bold text-gray-800 mb-8">📊 ระบบจัดการ</h1>
            <nav class="space-y-2">
                <a href="/index" class="block px-4 py-3 text-gray-700 hover:bg-gray-100 rounded-lg smooth-transition">📅 บันทึกโอที</a>
                <a href="/income-expense" class="block px-4 py-3 bg-green-100 text-green-700 font-medium rounded-lg">💰 รายรับ/รายจ่าย</a>
                <a href="/holidays" class="block px-4 py-3 text-gray-700 hover:bg-gray-100 rounded-lg smooth-transition">🎉 วันหยุด</a>
                <a href="/import-csv" class="block px-4 py-3 text-gray-700 hover:bg-gray-100 rounded-lg smooth-transition">📊 นำเข้า CSV รายรับ/รายจ่าย</a>
                <a href="/import-ot-csv" class="block px-4 py-3 text-gray-700 hover:bg-gray-100 rounded-lg smooth-transition">⏰ นำเข้า CSV โอที</a>
                <a href="/settings" class="block px-4 py-3 text-gray-700 hover:bg-gray-100 rounded-lg smooth-transition">⚙️ ตั้งค่า</a>
            </nav>
            <div class="mt-8 pt-6 border-t">
                <div class="px-4 py-3">
                    {% if session.user_picture %}
                        <div class="flex items-center gap-3 mb-3">
                            <img src="{{ session.user_picture }}" alt="Profile" class="w-8 h-8 rounded-full">
                            <div>
                                <div class="text-sm font-medium text-gray-800">{{ session.user_name or session.user_email }}</div>
                                <div class="text-xs text-gray-500">{{ session.user_email }}</div>
                            </div>
                        </div>
                    {% else %}
                <div class="px-4 py-2">
                    <span class="text-sm text-gray-500">👤 {{ session.user_email }}</span>
                        </div>
                    {% endif %}
                </div>
                <a href="/logout" class="block px-4 py-3 text-red-600 hover:bg-red-50 rounded-lg smooth-transition">🚪 ออกจากระบบ</a>
            </div>
        </div>
    </div>

    <!-- Main Content -->
        <div class="lg:ml-64 pt-20 lg:pt-6 p-4 lg:p-6 min-h-screen">
            <!-- Flash Messages -->
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="mb-4 p-4 rounded-lg {% if category == 'success' %}bg-green-100 text-green-700 border border-green-200{% elif category == 'error' %}bg-red-100 text-red-700 border border-red-200{% else %}bg-blue-100 text-blue-700 border border-blue-200{% endif %}">
                            <div class="flex items-center">
                                <span class="mr-2">
                                    {% if category == 'success' %}✅{% elif category == 'error' %}❌{% else %}ℹ️{% endif %}
                                </span>
                                {{ message }}
            </div>
            </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}

            <!-- Quick Add Navigation -->
            <div class="bg-gradient-to-r from-blue-500 to-purple-600 rounded-lg shadow-md p-6 mb-6">
                <div class="flex flex-col lg:flex-row items-center justify-between">
                    <div class="text-white mb-4 lg:mb-0">
                        <h2 class="text-2xl font-bold mb-2">⚡ เพิ่มสินค้าด่วน</h2>
                        <p class="text-blue-100">เพิ่มสินค้าได้อย่างรวดเร็วด้วยปุ่มกดด่วน</p>
            </div>
                    <div class="flex gap-3">
                        <button onclick="showQuickAddModal()" 
                                class="bg-white text-blue-600 hover:bg-blue-50 px-6 py-3 rounded-lg font-medium transition-colors flex items-center gap-2">
                            ⚡ เพิ่มสินค้าด่วน
                        </button>
                        <button onclick="showQuickAddTips()" 
                                class="bg-blue-400 hover:bg-blue-300 text-white px-4 py-3 rounded-lg font-medium transition-colors">
                            💡 เคล็ดลับ
                        </button>
                    </div>
            </div>
        </div>

            <!-- Page Title -->
            <div class="mb-6">
                <h1 class="text-2xl lg:text-3xl font-bold text-center lg:text-left">📒 รายรับ - รายจ่าย</h1>
            </div>

        <!-- Add Transaction Form -->
        <div class="bg-white p-4 lg:p-6 rounded-lg shadow-md mb-6">
            <div class="p-4 lg:p-6 border-b">
                <h2 class="text-lg lg:text-xl font-semibold text-gray-800">➕ เพิ่มรายการใหม่</h2>
                <p class="text-sm text-gray-600 mt-1">บันทึกรายรับหรือรายจ่ายใหม่</p>
            </div>
            
            <form method="POST" action="/income-expense" class="p-4 lg:p-6 space-y-4 lg:space-y-6">
                <!-- Vendor Section -->
                <div id="vendor-section" class="mobile-form-section">
                    <label class="mobile-form-label">🏪 ร้านค้า</label>
                    <div class="space-y-3">
                        <select id="vendor-select" name="vendor" class="mobile-form-select mobile-input-touch w-full">
                            <option value="none">ไม่เลือก</option>
                        
                        </select>
                        <button type="button" id="add-vendor-btn" onclick="testVendorButton()" 
                                class="bg-green-500 hover:bg-green-600 text-white px-4 py-3 rounded-lg text-base font-medium w-full">
                            ➕ เพิ่มร้านค้าใหม่
                        </button>
                        <!-- Custom vendor input -->
                        <div id="custom-vendor-input" class="hidden space-y-3">
                            <input type="text" id="new-vendor" placeholder="พิมพ์ชื่อร้านค้าใหม่..." 
                                   class="border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white w-full" 
                                   onkeypress="if(event.key==='Enter') testAddVendor()">
                            <div class="text-sm text-green-600">💡 กด Enter เพื่อเพิ่มร้านค้าใหม่</div>
                            <button type="button" 
                                    class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium w-full">
                                เพิ่มร้านค้า
                            </button>
                        </div>
                    </div>
                </div>
                

                <!-- Date Input -->
                <div class="mobile-form-section">
                    <label class="mobile-form-label">📅 วันที่</label>
                    <input type="date" name="date" required 
                           class="mobile-form-input mobile-input-touch">
                </div>

                <!-- Transaction Type -->
                <div class="mobile-form-section">
                    <label class="mobile-form-label">📊 ประเภทรายการ</label>
                    <select id="transaction-type" name="category" required 
                            class="mobile-form-select mobile-input-touch">
                        <option value="">-- เลือกประเภทรายการ --</option>
                        <option value="income">💰 รายรับ</option>
                        <option value="expense">💸 รายจ่าย</option>
                    </select>
                </div>

                <!-- Category Selection -->
                <div class="mobile-form-section">
                    <label class="mobile-form-label">🏷️ ประเภทหลัก</label>
                    <select id="main-category" name="main_category" required 
                            class="mobile-form-select mobile-input-touch">
                        <option value="">-- เลือกประเภทหลัก --</option>
                    </select>
                </div>

                <div class="mobile-form-section">
                    <label class="mobile-form-label">📂 ประเภทย่อย</label>
                    <select id="sub-category" name="sub_category" required 
                            class="mobile-form-select mobile-input-touch">
                        <option value="">-- เลือกประเภทย่อย --</option>
                    </select>
                </div>

                <!-- Income Amount Section -->
                <div id="income-amount-section" class="mobile-form-section hidden">
                    <label class="mobile-form-label">💰 จำนวนเงิน (บาท)</label>
                    <input type="number" step="0.01" name="amount" 
                           class="mobile-form-input mobile-input-touch" placeholder="0.00">
                </div>

                <!-- Items Section (for expense) -->
                <div id="items-section" class="mobile-form-section hidden">
                    <label class="mobile-form-label">🛒 รายการสินค้า</label>
                    
                    <!-- Selected Items Display -->
                    <div class="space-y-4">
                        <div id="selected-items" class="space-y-3"></div>
                    </div>
                    
                    <!-- Summary -->
                    <div class="mt-6 p-4 bg-gray-50 rounded-lg border border-gray-200">
                        <div class="flex justify-between items-center mb-2">
                            <span class="font-semibold text-gray-700">📊 รวมทั้งหมด:</span>
                            <span id="total-items" class="text-gray-600 font-medium">0 รายการ</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="font-semibold text-gray-700">💰 ยอดรวม:</span>
                            <span id="total-amount" class="text-xl font-bold text-blue-600">0.00 บาท</span>
                        </div>
                    </div>
                </div>

                <!-- Quick Add Items -->
                <div class="mobile-form-section">
                    <label class="mobile-form-label">⚡ เพิ่มสินค้าด่วน</label>
                    <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                        <div id="items-data-display" class="text-sm text-gray-600">
                            <!-- Quick Add Input Row -->
                            <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 mb-4">
                                <input type="text" id="quick-item-name" placeholder="ชื่อสินค้า" 
                                       class="col-span-1 sm:col-span-2 border border-gray-300 rounded-lg px-4 py-3 text-base focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white">
                                <input type="number" id="quick-item-price" placeholder="ราคา" 
                                       class="col-span-1 border border-gray-300 rounded-lg px-4 py-3 text-base focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white">
                            </div>
                            <div class="flex justify-center mb-4">
                                <button type="button" onclick="addQuickItem()" 
                                        class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-lg text-base font-medium w-full sm:w-auto">
                                    ➕ เพิ่มสินค้า
                                </button>
                            </div>
                            
                            <!-- Quick Add Buttons Grid -->
                            <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-3">
                                <button type="button" onclick="quickAddItem('กาแฟ', 20)" 
                                        class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-3 rounded-lg text-sm font-medium transition-colors">
                                    ☕ กาแฟ<br><span class="text-xs">20฿</span>
                                </button>
                                <button type="button" onclick="quickAddItem('ข้าวผัด', 45)" 
                                        class="bg-green-500 hover:bg-green-600 text-white px-3 py-3 rounded-lg text-sm font-medium transition-colors">
                                    🍛 ข้าวผัด<br><span class="text-xs">45฿</span>
                                </button>
                                <button type="button" onclick="quickAddItem('น้ำส้ม', 30)" 
                                        class="bg-orange-500 hover:bg-orange-600 text-white px-3 py-3 rounded-lg text-sm font-medium transition-colors">
                                    🧃 น้ำส้ม<br><span class="text-xs">30฿</span>
                                </button>
                                <button type="button" onclick="quickAddItem('ขนม', 15)" 
                                        class="bg-purple-500 hover:bg-purple-600 text-white px-3 py-3 rounded-lg text-sm font-medium transition-colors">
                                    🍪 ขนม<br><span class="text-xs">15฿</span>
                                </button>
                                <button type="button" onclick="quickAddItem('น้ำเปล่า', 10)" 
                                        class="bg-cyan-500 hover:bg-cyan-600 text-white px-3 py-3 rounded-lg text-sm font-medium transition-colors">
                                    💧 น้ำเปล่า<br><span class="text-xs">10฿</span>
                                </button>
                                <button type="button" onclick="quickAddItem('ข้าวกะเพรา', 35)" 
                                        class="bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-3 rounded-lg text-sm font-medium transition-colors">
                                    🍚 ข้าวกะเพรา<br><span class="text-xs">35฿</span>
                                </button>
                                <button type="button" onclick="quickAddItem('ส้มตำ', 25)" 
                                        class="bg-red-500 hover:bg-red-600 text-white px-3 py-3 rounded-lg text-sm font-medium transition-colors">
                                    🥗 ส้มตำ<br><span class="text-xs">25฿</span>
                                </button>
                                <button type="button" onclick="quickAddItem('ไก่ทอด', 50)" 
                                        class="bg-amber-500 hover:bg-amber-600 text-white px-3 py-3 rounded-lg text-sm font-medium transition-colors">
                                    🍗 ไก่ทอด<br><span class="text-xs">50฿</span>
                                </button>
                                <button type="button" onclick="quickAddItem('น้ำอัดลม', 25)" 
                                        class="bg-pink-500 hover:bg-pink-600 text-white px-3 py-3 rounded-lg text-sm font-medium transition-colors">
                                    🥤 น้ำอัดลม<br><span class="text-xs">25฿</span>
                                </button>
                                <button type="button" onclick="quickAddItem('ไอศกรีม', 20)" 
                                        class="bg-indigo-500 hover:bg-indigo-600 text-white px-3 py-3 rounded-lg text-sm font-medium transition-colors">
                                    🍦 ไอศกรีม<br><span class="text-xs">20฿</span>
                                </button>
                                <button type="button" onclick="quickAddItem('ข้าวมันไก่', 40)" 
                                        class="bg-teal-500 hover:bg-teal-600 text-white px-3 py-3 rounded-lg text-sm font-medium transition-colors">
                                    🍗 ข้าวมันไก่<br><span class="text-xs">40฿</span>
                                </button>
                                <button type="button" onclick="quickAddItem('ก๋วยเตี๋ยว', 30)" 
                                        class="bg-lime-500 hover:bg-lime-600 text-white px-3 py-3 rounded-lg text-sm font-medium transition-colors">
                                    🍜 ก๋วยเตี๋ยว<br><span class="text-xs">30฿</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    <input type="hidden" name="description" id="description-input">
                </div>

                <!-- Hidden inputs for form submission -->
                <input type="hidden" id="items-data" name="items_data">
                <input type="hidden" id="calculated-total" name="calculated_amount">
                <input type="hidden" id="combined-category" name="combined_category">

                <!-- Submit Button -->
                <div class="pt-6">
                    <button type="submit" class="mobile-submit-btn w-full py-4 text-lg font-semibold">
                        <span class="text-2xl mr-3">💾</span>
                        บันทึกรายการ
                    </button>
                </div>
            </form>
        </div>

        <!-- Month Selection and Export -->
        <div class="bg-white p-4 lg:p-6 rounded-lg shadow-md mb-6">
            <div class="p-4 lg:p-6 border-b">
                <h2 class="text-lg lg:text-xl font-semibold text-gray-800 mb-2">📅 เลือกเดือนที่ต้องการดู</h2>
                <p class="text-sm text-gray-600">เลือกเดือนเพื่อดูข้อมูลรายรับ-รายจ่าย</p>
            </div>
            <div class="p-4 lg:p-6">
                <div class="flex flex-col lg:flex-row items-start lg:items-center gap-4 mb-6">
                    <div class="flex items-center gap-3">
                        <label class="font-semibold text-gray-700">📅 เดือน:</label>
                        <select id="month-select" class="border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white" onchange="changeMonth(this.value)">
                            {% for month in available_months %}
                                <option value="{{ month.month }}" {% if month.month == selected_month %}selected{% endif %}>
                                    {{ month.display }}
                                </option>
                            {% endfor %}
                </select>
            </div>
                    <div class="bg-gray-50 border border-gray-200 rounded-lg px-4 py-2">
                        <div class="text-sm text-gray-700">
                            <span class="font-medium">📊 สถานะ:</span> แสดงข้อมูล รายรับ-รายจ่าย ประจำเดือน 
                            <span class="font-bold text-gray-900">{{ selected_month.split('-')[1] }}/{{ selected_month.split('-')[0] }}</span>
                            <span class="text-gray-600">({{ total_records }} รายการ)</span>
                        </div>
            </div>
        </div>

            <!-- Export Buttons -->
            <div class="border-t pt-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">📊 ส่งออกข้อมูล</h3>
                <div class="flex flex-wrap gap-2">
                    <button onclick="exportData('all', '2025-07')" 
                            class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium">
                        📄 ส่งออกทั้งหมด
                    </button>
                    <button onclick="exportData('income', '2025-07')" 
                            class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-medium">
                        💰 ส่งออกรายรับ
                    </button>
                    <button onclick="exportData('expense', '2025-07')" 
                            class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm font-medium">
                        💸 ส่งออกรายจ่าย
                    </button>
                    <button onclick="showMonthlySummary()" 
                            class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg text-sm font-medium">
                        📋 สรุปประจำเดือน
                    </button>
                    <button onclick="showYearlyView()" 
                            class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-lg text-sm font-medium">
                        📅 ดูรายปี
                    </button>
                    <button onclick="exportYearData('2025')" 
                            class="bg-indigo-500 hover:bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-medium">
                        📊 ส่งออกรายปี
                    </button>
                    </div>
                    </div>
                </div>

        <!-- Summary Cards -->
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-4 mb-6">
            <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200">
                <div class="flex items-center justify-between mb-2">
                    <div class="text-green-600 text-xl">💰</div>
                    <div class="text-gray-600 text-sm">รายรับ</div>
                    </div>
                <div class="text-green-700 font-bold text-xl mb-1">{{ "%.2f"|format(monthly_total_income) }}</div>
                <div class="text-gray-500 text-sm">บาท</div>
                    </div>
            <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200">
                <div class="flex items-center justify-between mb-2">
                    <div class="text-red-600 text-xl">💸</div>
                    <div class="text-gray-600 text-sm">รายจ่าย</div>
                    </div>
                <div class="text-red-700 font-bold text-xl mb-1">{{ "%.2f"|format(monthly_total_expense) }}</div>
                <div class="text-gray-500 text-sm">บาท</div>
                </div>
            <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200">
                <div class="flex items-center justify-between mb-2">
                    <div class="text-blue-600 text-xl">📊</div>
                    <div class="text-gray-600 text-sm">คงเหลือ</div>
                    </div>
                <div class="text-blue-700 font-bold text-xl mb-1">{{ "%.2f"|format(monthly_total_income - monthly_total_expense) }}</div>
                <div class="text-gray-500 text-sm">บาท</div>
                    </div>
            <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200">
                <div class="flex items-center justify-between mb-2">
                    <div class="text-gray-600 text-xl">📝</div>
                    <div class="text-gray-600 text-sm">รายการ</div>
                    </div>
                <div class="text-gray-700 font-bold text-xl mb-1">{{ total_records }}</div>
                <div class="text-gray-500 text-sm">รายการ</div>
            </div>
        </div>

        <!-- Records Table -->
        <div class="bg-white rounded-lg shadow-md overflow-hidden">
            <div class="p-4 lg:p-6 border-b">
                <h2 class="text-lg lg:text-xl font-semibold text-gray-800">📊 รายการทั้งหมด</h2>
                <p class="text-sm text-gray-600 mt-1">แสดงรายการรายรับ-รายจ่ายทั้งหมดในเดือนที่เลือก</p>
            </div>
            
            <!-- Table View -->
            <div class="overflow-x-auto">
                <table class="w-full border-collapse">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700 border-b border-gray-200">📅 วันที่</th>
                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700 border-b border-gray-200">📝 รายละเอียด</th>
                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700 border-b border-gray-200">💰 จำนวน (บาท)</th>
                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700 border-b border-gray-200">🏪 ร้านค้า</th>
                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700 border-b border-gray-200">📊 ประเภทรายการ</th>
                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700 border-b border-gray-200">🏷️ ประเภทหลัก</th>
                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700 border-b border-gray-200">📂 ประเภทย่อย</th>
                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700 border-b border-gray-200">⚙️ จัดการ</th>
                        </tr>
                    </thead>
                    <tbody id="records-tbody">
                        {% if records %}
                            {% for record in records %}
                                <tr class="border-b border-gray-100 hover:bg-gray-50 transition-colors duration-200 cursor-pointer" 
                                    data-record-id="{{ record.id }}">
                                    <td class="px-4 py-4 text-sm text-gray-700 font-medium">
                                        <div class="flex items-center gap-2">
                                            <span class="text-gray-400">📅</span>
                                            {{ record.date }}
                                        </div>
                            </td>
                                    <td class="px-4 py-4 text-sm text-gray-800">
                                        <div class="max-w-xs truncate" title="{{ record.description }}">
                                            <!-- Debug: {{ record.items_data }} -->
                                            {% if record.items_data and record.items_data != '[]' and record.items_data != 'null' %}
                                                {% set items = record.items_data|from_json %}
                                                {% if items and items|length > 0 %}
                                                    {% for item in items %}
                                                        <div class="mb-1">
                                                            <span class="font-medium">{{ item.name }}</span> x <span class="text-blue-600">{{ item.quantity }}</span>
                                                        </div>
                                                    {% endfor %}
                                                {% else %}
                                                    {{ record.description or '-' }}
                                                {% endif %}
                                            {% else %}
                                                {{ record.description or '-' }}
                                            {% endif %}
                                        </div>
                                    </td>
                                    <td class="px-4 py-4 text-sm font-bold {% if record.category == 'income' %}text-green-600{% else %}text-red-600{% endif %}">
                                        <div class="flex items-center gap-1">
                                            <span>{% if record.category == 'income' %}💰{% else %}💸{% endif %}</span>
                                            {{ "%.2f"|format(record.amount) }}
                                        </div>
                                    </td>
                                    <td class="px-4 py-4 text-sm text-gray-600">
                                        <div class="flex items-center gap-1">
                                            <span class="text-gray-400">🏪</span>
                                            {{ record.vendor or '-' }}
                                        </div>
                                    </td>
                                    <td class="px-4 py-4 text-sm">
                                        <span class="px-3 py-1 rounded-full text-xs font-medium {% if record.category == 'income' %}bg-green-100 text-green-700 border border-green-200{% else %}bg-red-100 text-red-700 border border-red-200{% endif %}">
                                            {% if record.category == 'income' %}💰 รายรับ{% else %}💸 รายจ่าย{% endif %}
                                        </span>
                                    </td>
                                    <td class="px-4 py-4 text-sm">
                                        <span class="px-3 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-700 border border-blue-200">
                                            {{ record.main_category or '-' }}
                                        </span>
                                    </td>
                                    <td class="px-4 py-4 text-sm text-gray-600">
                                        <div class="flex items-center gap-1">
                                            <span class="text-gray-400">📂</span>
                                            {{ record.sub_category or '-' }}
                                        </div>
                                    </td>
                                    <td class="px-4 py-4 text-sm">
                                        <div class="flex gap-2" onclick="event.stopPropagation()">
                                            <a href="/edit-income-expense/{{ record.id }}" 
                                               class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded-lg text-xs font-medium transition-all duration-200 hover:shadow-md">
                                                ✏️ แก้ไข
                                            </a>
                                            <form method="POST" action="/delete-income-expense/{{ record.id }}" 
                                                  class="inline" onsubmit="return confirm('ต้องการลบรายการนี้หรือไม่?')">
                                                <button type="submit" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded-lg text-xs font-medium transition-all duration-200 hover:shadow-md">
                                                    🗑️ ลบ
                                                </button>
                                            </form>
                                </div>
                            </td>
                        </tr>
                                <!-- รายละเอียดเพิ่มเติม (ซ่อนไว้) -->
                                <tr id="details-{{ record.id }}" class="hidden bg-gray-50 border-b border-gray-100">
                                    <td colspan="8" class="px-4 py-4">
                                        <div class="bg-white rounded-lg p-4 shadow-sm border border-gray-200">
                                            <h4 class="font-semibold text-gray-800 mb-3">📋 รายละเอียดเพิ่มเติม</h4>
                                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                <div>
                                                    <label class="block text-sm font-medium text-gray-700 mb-1">📦 Items Data:</label>
                                                    {% if record.items_data and record.items_data != '[]' and record.items_data != 'null' %}
                                                        {% set items = record.items_data|from_json %}
                                                        {% if items and items|length > 0 %}
                                                            <div class="space-y-2">
                                                                {% for item in items %}
                                                                    <div class="bg-gray-50 p-2 rounded">
                                                                        <div class="text-sm">
                                                                            <span class="font-medium">{{ item.name }}</span> x <span class="text-blue-600 font-bold">{{ item.quantity }}</span>
            </div>
                                                                        <div class="text-xs text-gray-500 mt-1">
                                                                            Description: {{ item.name }} x{{ item.quantity }}
                                </div>
                            </div>
                                                                {% endfor %}
                                </div>
                                                        {% else %}
                                                            <p class="text-sm text-gray-800">{{ record.description or 'ไม่มีรายละเอียด' }}</p>
                                                        {% endif %}
                                                    {% else %}
                                                        <p class="text-sm text-gray-800">{{ record.description or 'ไม่มีรายละเอียด' }}</p>
                                                    {% endif %}
                                </div>
                                                <div>
                                                    <label class="block text-sm font-medium text-gray-700 mb-1">🏪 ร้านค้า:</label>
                                                    <p class="text-sm text-gray-800">{{ record.vendor or 'ไม่ระบุ' }}</p>
                                </div>
                                                <div>
                                                    <label class="block text-sm font-medium text-gray-700 mb-1">📊 ประเภทรายการ:</label>
                                                    <p class="text-sm text-gray-800">{% if record.category == 'income' %}💰 รายรับ{% else %}💸 รายจ่าย{% endif %}</p>
                                </div>
                                                <div>
                                                    <label class="block text-sm font-medium text-gray-700 mb-1">🏷️ ประเภทหลัก:</label>
                                                    <p class="text-sm text-gray-800">{{ record.main_category or 'ไม่ระบุ' }}</p>
                            </div>
                                                <div>
                                                    <label class="block text-sm font-medium text-gray-700 mb-1">📂 ประเภทย่อย:</label>
                                                    <p class="text-sm text-gray-800">{{ record.sub_category or 'ไม่ระบุ' }}</p>
                                                </div>
                                                <div>
                                                    <label class="block text-sm font-medium text-gray-700 mb-1">💰 จำนวน:</label>
                                                    <p class="text-sm font-bold {% if record.category == 'income' %}text-green-600{% else %}text-red-600{% endif %}">
                                                        {{ "%.2f"|format(record.amount) }} บาท
                                                    </p>
                                                </div>
                                                <div>
                                                    <label class="block text-sm font-medium text-gray-700 mb-1">📅 วันที่:</label>
                                                    <p class="text-sm text-gray-800">{{ record.date }}</p>
                                                </div>
                                            </div>
                                            <div class="mt-4 flex gap-2">
                                                <a href="/edit-income-expense/{{ record.id }}" 
                                                   class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-all duration-200">
                                                    ✏️ แก้ไขรายการ
                                                </a>
                                                <button data-hide-record-id="{{ record.id }}" 
                                                        class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-all duration-200">
                                                    ❌ ปิด
                                    </button>
                            </div>
                        </div>
                                    </td>
                                </tr>
                    {% endfor %}
                {% else %}
                            <tr>
                                <td colspan="8" class="px-4 py-12 text-center">
                                    <div class="flex flex-col items-center justify-center">
                        <div class="text-6xl mb-4 text-gray-300">📭</div>
                        <div class="text-lg font-medium text-gray-500 mb-2">ไม่มีข้อมูลในเดือนนี้</div>
                                        <div class="text-sm text-gray-400">ลองเพิ่มรายการใหม่หรือเลือกเดือนอื่น</div>
                                        <div class="mt-4 flex gap-2">
                            <button onclick="document.getElementById('transaction-type').focus()" 
                                                    class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-all duration-200">
                                ➕ เพิ่มรายการใหม่
                            </button>
                            <button onclick="document.getElementById('month-select').focus()" 
                                                    class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-all duration-200">
                                📅 เลือกเดือนอื่น
                            </button>
                        </div>
                    </div>
                                </td>
                            </tr>
                {% endif %}
                    </tbody>
                </table>
            </div>
            

            
            <!-- Table Footer -->
            {% if records %}
            <div class="p-4 lg:p-6 border-t bg-gray-50">
                <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-4">
                    <div class="text-sm text-gray-600">
                        แสดง {{ records|length }} รายการ จากทั้งหมด {{ total_records }} รายการ
                    </div>
                    <div class="flex gap-2">
                        <button onclick="exportData('all', '2025-07')" 
                                class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium">
                            📄 ส่งออกทั้งหมด
                        </button>
                        <button onclick="showMonthlySummary()" 
                                class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg text-sm font-medium">
                            📋 สรุปข้อมูล
                        </button>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Quick Add Modal -->
    <div id="quick-add-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                <!-- Modal Header -->
                <div class="bg-gradient-to-r from-blue-500 to-purple-600 text-white p-6 rounded-t-lg">
                    <div class="flex items-center justify-between">
                        <div>
                            <h2 class="text-2xl font-bold">⚡ เพิ่มสินค้าด่วน</h2>
                            <p class="text-blue-100 mt-1">เลือกสินค้าที่ต้องการเพิ่ม</p>
                        </div>
                        <button onclick="closeQuickAddModal()" class="text-white hover:text-gray-200 text-2xl">
                            ✕
                        </button>
                    </div>
                </div>

                <!-- Modal Body -->
                <div class="p-6">
                    <!-- Quick Add Form -->
                    <div class="bg-gray-50 rounded-lg p-4 mb-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-3">📝 เพิ่มสินค้าใหม่</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">ชื่อสินค้า</label>
                                <input type="text" id="modal-item-name" placeholder="เช่น ข้าวผัดกุ้ง" 
                                       class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">ราคา (บาท)</label>
                                <input type="number" id="modal-item-price" placeholder="45" step="0.01" min="0"
                                       class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>
                            <div class="flex items-end">
                                <button onclick="addModalQuickItem()" 
                                        class="w-full bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg font-medium transition-colors">
                                    ➕ เพิ่มสินค้า
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Saved Quick Items -->
                    <div class="mb-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold text-gray-800">💾 สินค้าที่บันทึกไว้</h3>
                            <button onclick="clearSavedItems()" 
                                    class="text-red-500 hover:text-red-700 text-sm font-medium">
                                🗑️ ล้างทั้งหมด
                            </button>
                        </div>
                        <div id="modal-saved-items" class="flex gap-2 flex-wrap">
                            <!-- Saved items will be populated here -->
                        </div>
                    </div>

                    <!-- Default Quick Items -->
                    <div>
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">🍽️ สินค้าด่วนเริ่มต้น</h3>
                        <div class="flex gap-2 flex-wrap">
                            <button type="button" onclick="modalQuickAddItem('กาแฟ', 20)" 
                                    class="quick-add-btn bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium">
                                ☕ กาแฟ 20฿
                            </button>
                            <button type="button" onclick="modalQuickAddItem('ข้าวผัด', 45)" 
                                    class="quick-add-btn bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-medium">
                                🍛 ข้าวผัด 45฿
                            </button>
                            <button type="button" onclick="modalQuickAddItem('น้ำส้ม', 30)" 
                                    class="quick-add-btn bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-lg text-sm font-medium">
                                🧃 น้ำส้ม 30฿
                            </button>
                            <button type="button" onclick="modalQuickAddItem('ขนม', 15)" 
                                    class="quick-add-btn bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg text-sm font-medium">
                                🍪 ขนม 15฿
                            </button>
                            <button type="button" onclick="modalQuickAddItem('น้ำเปล่า', 10)" 
                                    class="quick-add-btn bg-cyan-500 hover:bg-cyan-600 text-white px-4 py-2 rounded-lg text-sm font-medium">
                                💧 น้ำเปล่า 10฿
                            </button>
                            <button type="button" onclick="modalQuickAddItem('ข้าวกะเพรา', 35)" 
                                    class="quick-add-btn bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg text-sm font-medium">
                                🍚 ข้าวกะเพรา 35฿
                            </button>
                            <button type="button" onclick="modalQuickAddItem('ส้มตำ', 25)" 
                                    class="quick-add-btn bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm font-medium">
                                🥗 ส้มตำ 25฿
                            </button>
                            <button type="button" onclick="modalQuickAddItem('ไก่ทอด', 50)" 
                                    class="quick-add-btn bg-amber-500 hover:bg-amber-600 text-white px-4 py-2 rounded-lg text-sm font-medium">
                                🍗 ไก่ทอด 50฿
                            </button>
                            <button type="button" onclick="modalQuickAddItem('น้ำอัดลม', 25)" 
                                    class="quick-add-btn bg-pink-500 hover:bg-pink-600 text-white px-4 py-2 rounded-lg text-sm font-medium">
                                🥤 น้ำอัดลม 25฿
                            </button>
                            <button type="button" onclick="modalQuickAddItem('ไอศกรีม', 20)" 
                                    class="quick-add-btn bg-indigo-500 hover:bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-medium">
                                🍦 ไอศกรีม 20฿
                            </button>
                            <button type="button" onclick="modalQuickAddItem('ข้าวมันไก่', 40)" 
                                    class="quick-add-btn bg-teal-500 hover:bg-teal-600 text-white px-4 py-2 rounded-lg text-sm font-medium">
                                🍗 ข้าวมันไก่ 40฿
                            </button>
                            <button type="button" onclick="modalQuickAddItem('ก๋วยเตี๋ยว', 30)" 
                                    class="quick-add-btn bg-lime-500 hover:bg-lime-600 text-white px-4 py-2 rounded-lg text-sm font-medium">
                                🍜 ก๋วยเตี๋ยว 30฿
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Modal Footer -->
                <div class="bg-gray-50 p-6 rounded-b-lg border-t">
                    <div class="flex items-center justify-between">
                        <div class="text-sm text-gray-600">
                            💡 กดปุ่มสินค้าด่วนเพื่อเพิ่มสินค้าทันที
                        </div>
                        <div class="flex gap-3">
                            <button onclick="closeQuickAddModal()" 
                                    class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg font-medium transition-colors">
                                ปิด
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Application State
        let selectedItems = [];
        let itemCounter = 0;
        
        console.log('Application State initialized');
        console.log('selectedItems:', selectedItems);
        console.log('itemCounter:', itemCounter);
        let availableTags = [
            'อาหาร', 'เครื่องดื่ม', 'ของใช้', 'ยา', 'ขนม', 
            'ผลไม้', 'ผัก', 'เนื้อสัตว์', 'นม', 'ขนมปัง'
        ];
        
        // Emoji data
        const emojiData = {
            'อาหาร': ['🍽️', '🍜', '🍕', '🍔', '🍟', '🌮', '🌯', '🥪', '🍱', '🍛'],
            'เครื่องดื่ม': ['🥤', '☕', '🧃', '🍺', '🍷', '🥛', '🧋', '🍹', '🥤', '💧'],
            'ของใช้': ['🛍️', '🧴', '🧻', '🧽', '👕', '👖', '👟', '👜', '💄', '🪞'],
            'ยา': ['💊', '🏥', '🩺', '🩹', '🩻', '💉', '🩸', '🧬', '🔬', '📋'],
            'ขนม': ['🍪', '🍩', '🍰', '🧁', '🍦', '🍨', '🍭', '🍫', '🍬', '🍡'],
            'ผลไม้': ['🍎', '🍌', '🍊', '🍇', '🍓', '🍑', '🥭', '🍍', '🥥', '🥝'],
            'ผัก': ['🥬', '🥕', '🥦', '🥒', '🍅', '🌽', '🥑', '🥒', '🧅', '🧄'],
            'เนื้อสัตว์': ['🥩', '🍗', '🍖', '🥓', '🍖', '🐟', '🦐', '🦑', '🦞', '🦀'],
            'นม': ['🥛', '🧀', '🍦', '🍨', '🥛', '🧈', '🥛', '🍼', '🥛', '🥛'],
            'ขนมปัง': ['🍞', '🥖', '🥨', '🥯', '🥐', '🥪', '🍞', '🥖', '🥨', '🥯']
        };
        
        // Default emoji for each tag
        const defaultEmojis = {
            'อาหาร': '🍽️',
            'เครื่องดื่ม': '🥤',
            'ของใช้': '🛍️',
            'ยา': '💊',
            'ขนม': '🍪',
            'ผลไม้': '🍎',
            'ผัก': '🥬',
            'เนื้อสัตว์': '🥩',
            'นม': '🥛',
            'ขนมปัง': '🍞'
        };
        
        // Category data structure
        const categoryData = {
            income: {
                'เงินเดือน': ['เงินเดือนประจำ', 'โบนัส', 'ค่าล่วงเวลา', 'ค่าคอมมิชชั่น'],
                'รายได้เสริม': ['งานฟรีแลนซ์', 'ขายของออนไลน์', 'รับจ้างทั่วไป'],
                'เงินออม': ['ดอกเบี้ยเงินฝาก', 'เงินปันผล', 'เงินคืนภาษี'],
                'อื่นๆ': ['ของขวัญ', 'เงินกู้', 'รายได้อื่นๆ']
            },
            expense: {
                'อาหาร': ['อาหารเช้า', 'อาหารกลางวัน', 'อาหารเย็น', 'ของว่าง', 'เครื่องดื่ม'],
                'การเดินทาง': ['รถเมล์', 'รถไฟฟ้า', 'แท็กซี่', 'น้ำมันรถ', 'ค่าจอดรถ'],
                'ที่อยู่อาศัย': ['ค่าเช่า', 'ค่าน้ำ', 'ค่าไฟ', 'ค่าแก๊ส', 'ค่าอินเทอร์เน็ต'],
                'สุขภาพ': ['ยา', 'ตรวจสุขภาพ', 'ฟิตเนส', 'อาหารเสริม'],
                'การศึกษา': ['ค่าเล่าเรียน', 'หนังสือ', 'อุปกรณ์การเรียน', 'คอร์สออนไลน์'],
                'ความบันเทิง': ['ดูหนัง', 'ฟังเพลง', 'เกม', 'ท่องเที่ยว'],
                'เสื้อผ้า': ['เสื้อ', 'กางเกง', 'รองเท้า', 'กระเป๋า', 'เครื่องประดับ'],
                'ของใช้': ['เครื่องสำอาง', 'ของใช้ในบ้าน', 'อุปกรณ์อิเล็กทรอนิกส์'],
                'อื่นๆ': ['ค่าธรรมเนียม', 'ของขวัญ', 'บริจาค', 'รายจ่ายอื่นๆ']
            }
        };

        // DOM Elements
        const mobileMenuBtn = document.getElementById('mobile-menu-btn');
        const mobileMenu = document.getElementById('mobile-menu');
        const transactionTypeSelect = document.getElementById('transaction-type');
        const mainCategorySelect = document.getElementById('main-category');
        const subCategorySelect = document.getElementById('sub-category');
        const incomeAmountSection = document.getElementById('income-amount-section');
        const itemsSection = document.getElementById('items-section');
        const vendorSection = document.getElementById('vendor-section');
        const selectedItemsDiv = document.getElementById('selected-items');
        const totalItemsSpan = document.getElementById('total-items');
        const totalAmountSpan = document.getElementById('total-amount');

        // Mobile Menu Toggle
            mobileMenuBtn.addEventListener('click', () => {
                mobileMenu.classList.toggle('hidden');
            });

            // Close mobile menu when clicking outside
            document.addEventListener('click', (e) => {
                if (!mobileMenuBtn.contains(e.target) && !mobileMenu.contains(e.target)) {
                    mobileMenu.classList.add('hidden');
                }
            });

        // Transaction Type Change Handler
        transactionTypeSelect.addEventListener('change', function() {
            const type = this.value;
            
            // Clear category options
            mainCategorySelect.innerHTML = '<option value="">-- เลือกประเภทหลัก --</option>';
            subCategorySelect.innerHTML = '<option value="">-- เลือกประเภทย่อย --</option>';
            
            if (type === 'income') {
                // Show income amount section
                incomeAmountSection.classList.remove('hidden');
            itemsSection.classList.add('hidden');
            vendorSection.classList.add('hidden');
            
                // Add income main categories
                Object.keys(categoryData.income).forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    mainCategorySelect.appendChild(option);
                });
            } else if (type === 'expense') {
                // Show items section
                incomeAmountSection.classList.add('hidden');
                itemsSection.classList.remove('hidden');
                vendorSection.classList.remove('hidden');
                
                // Add expense main categories
                Object.keys(categoryData.expense).forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                    mainCategorySelect.appendChild(option);
                });
            } else {
                // Hide all conditional sections
                incomeAmountSection.classList.add('hidden');
                itemsSection.classList.add('hidden');
                vendorSection.classList.add('hidden');
            }
        });

        // Main Category Change Handler
        mainCategorySelect.addEventListener('change', function() {
            const mainCategory = this.value;
            const transactionType = transactionTypeSelect.value;
            
            // Clear sub category options
            subCategorySelect.innerHTML = '<option value="">-- เลือกประเภทย่อย --</option>';
            
            if (mainCategory && transactionType) {
                const subCategories = categoryData[transactionType][mainCategory] || [];
                subCategories.forEach(subCategory => {
                    const option = document.createElement('option');
                    option.value = subCategory;
                    option.textContent = subCategory;
                    subCategorySelect.appendChild(option);
                });
            }
        });

        // Sub Category Change Handler
        subCategorySelect.addEventListener('change', function() {
            // Update hidden category field for form submission
            const mainCategory = mainCategorySelect.value;
            const subCategory = this.value;
            
            if (mainCategory && subCategory) {
                // Create a hidden input for the combined category if it doesn't exist
                let combinedCategoryInput = document.getElementById('combined-category');
                if (!combinedCategoryInput) {
                    combinedCategoryInput = document.createElement('input');
                    combinedCategoryInput.type = 'hidden';
                    combinedCategoryInput.id = 'combined-category';
                    combinedCategoryInput.name = 'combined_category';
                    document.querySelector('form').appendChild(combinedCategoryInput);
                }
                combinedCategoryInput.value = `${mainCategory} > ${subCategory}`;
            }
        });

        // Add New Item Function (using form)
        function addNewItem() {
            const itemName = document.getElementById('item-name').value.trim();
            const itemPrice = document.getElementById('item-price').value;
            const itemQuantity = document.getElementById('item-quantity').value;
            const itemTag = document.getElementById('item-tag').value || 'ของใช้';
            
            // Validation
            if (!itemName) {
                alert('กรุณากรอกชื่อสินค้า');
                document.getElementById('item-name').focus();
                return;
            }
            
            if (!itemPrice || isNaN(itemPrice) || parseFloat(itemPrice) <= 0) {
                alert('กรุณากรอกราคาที่ถูกต้อง');
                document.getElementById('item-price').focus();
                return;
            }
            
            if (!itemQuantity || isNaN(itemQuantity) || parseInt(itemQuantity) <= 0) {
                alert('กรุณากรอกจำนวนที่ถูกต้อง');
                document.getElementById('item-quantity').focus();
                return;
            }
            
            // Get emoji based on tag
            const emoji = defaultEmojis[itemTag] || '😊';
            
            const item = {
                id: ++itemCounter,
                name: itemName,
                tag: itemTag,
                emoji: emoji,
                price: parseFloat(itemPrice),
                quantity: parseInt(itemQuantity),
                total: parseFloat(itemPrice) * parseInt(itemQuantity)
            };
            
            console.log('เพิ่มสินค้า:', item);
            selectedItems.push(item);
            console.log('รายการสินค้าทั้งหมด:', selectedItems);
            updateItemsDisplay();
            clearItemForm();
            
            // Update form data
            updateFormData();
        }

        // Clear Item Form Function
        function clearItemForm() {
            document.getElementById('item-name').value = '';
            document.getElementById('item-price').value = '';
            document.getElementById('item-quantity').value = '1';
            document.getElementById('item-tag').value = '';
            document.getElementById('item-name').focus();
        }

        // Legacy Add Item Function (for backward compatibility)
        function addItem() {
            addNewItem();
        }

        // Save Item Template Function
        function saveItemTemplate() {
            const itemName = document.getElementById('item-name').value.trim();
            const itemPrice = document.getElementById('item-price').value;
            const itemQuantity = document.getElementById('item-quantity').value;
            const itemTag = document.getElementById('item-tag').value;
            
            if (!itemName || !itemPrice || !itemTag) {
                alert('กรุณากรอกข้อมูลให้ครบก่อนบันทึกเทมเพลต');
                return;
            }
            
            const template = {
                name: itemName,
                price: parseFloat(itemPrice),
                quantity: parseInt(itemQuantity) || 1,
                tag: itemTag,
                emoji: defaultEmojis[itemTag] || '😊',
                timestamp: new Date().toISOString()
            };
            
            // Get existing templates from localStorage
            let savedTemplates = JSON.parse(localStorage.getItem('itemTemplates') || '[]');
            
            // Check if template already exists
            const exists = savedTemplates.some(t => t.name === itemName && t.price === template.price);
            if (exists) {
                alert('เทมเพลตนี้มีอยู่แล้ว');
                return;
            }
            
            // Add new template
            savedTemplates.push(template);
            localStorage.setItem('itemTemplates', JSON.stringify(savedTemplates));
            
            alert(`บันทึกเทมเพลต "${itemName}" เรียบร้อยแล้ว`);
            console.log('เทมเพลตที่บันทึก:', savedTemplates);
        }

        // Show Saved Items Function
        function showSavedItems() {
            const savedTemplates = JSON.parse(localStorage.getItem('itemTemplates') || '[]');
            
            if (savedTemplates.length === 0) {
                alert('ยังไม่มีเทมเพลตที่บันทึกไว้');
                return;
            }
            
            let message = '📚 เทมเพลตที่บันทึกไว้:\n\n';
            savedTemplates.forEach((template, index) => {
                message += `${index + 1}. ${template.emoji} ${template.name} - ${template.price} บาท (${template.tag})\n`;
            });
            
            message += '\nกรุณาเลือกหมายเลขเทมเพลตที่ต้องการ:';
            
            const choice = prompt(message);
            if (choice && !isNaN(choice) && choice > 0 && choice <= savedTemplates.length) {
                const selectedTemplate = savedTemplates[choice - 1];
                loadItemTemplate(selectedTemplate);
            }
        }

        // Load Item Template Function
        function loadItemTemplate(template) {
            document.getElementById('item-name').value = template.name;
            document.getElementById('item-price').value = template.price;
            document.getElementById('item-quantity').value = template.quantity;
            document.getElementById('item-tag').value = template.tag;
            
            console.log('โหลดเทมเพลต:', template);
        }

        // Quick Add Item Function
        function quickAddItem(name, price) {
            itemCounter++;
            const item = {
                id: itemCounter,
                name: name,
                tag: 'อาหาร',
                emoji: '🍽️',
                price: price,
                quantity: 1,
                total: price
            };
            
            console.log('เพิ่มสินค้าด่วน:', item);
            selectedItems.push(item);
            updateItemsDisplay();
            updateFormData();
            
            // บันทึกในรายการสินค้าด่วน
            saveToQuickItems(name, price);
        }

        // Add Quick Item from Input Function
        function addQuickItem() {
            const nameInput = document.getElementById('quick-item-name');
            const priceInput = document.getElementById('quick-item-price');
            
            const name = nameInput.value.trim();
            const price = parseFloat(priceInput.value);
            
            if (!name) {
                alert('กรุณากรอกชื่อสินค้า');
                nameInput.focus();
                return;
            }
            
            if (!price || price <= 0) {
                alert('กรุณากรอกราคาที่ถูกต้อง');
                priceInput.focus();
                return;
            }
            
            itemCounter++;
            const item = {
                id: itemCounter,
                name: name,
                tag: 'อาหาร',
                emoji: '🍽️',
                price: price,
                quantity: 1,
                total: price
            };
            
            console.log('เพิ่มสินค้าจากอินพุต:', item);
            selectedItems.push(item);
            updateItemsDisplay();
            updateFormData();
            
            // บันทึกในรายการสินค้าด่วน
            saveToQuickItems(name, price);
            
            // Clear inputs
            nameInput.value = '';
            priceInput.value = '';
            nameInput.focus();
        }

        // Save to Quick Items Function
        function saveToQuickItems(name, price) {
            console.log('saveToQuickItems ถูกเรียก:', name, price);
            
            // Get existing quick items from localStorage
            let quickItems = JSON.parse(localStorage.getItem('quickItems') || '[]');
            console.log('สินค้าด่วนเดิม:', quickItems);
            
            // Check if item already exists
            const exists = quickItems.some(item => item.name === name && item.price === price);
            console.log('สินค้ามีอยู่แล้ว:', exists);
            
            if (!exists) {
                // Add new quick item
                quickItems.push({
                    name: name,
                    price: price,
                    emoji: '🍽️',
                    timestamp: new Date().toISOString()
                });
                
                // Keep only last 10 items
                if (quickItems.length > 10) {
                    quickItems = quickItems.slice(-10);
                }
                
                localStorage.setItem('quickItems', JSON.stringify(quickItems));
                console.log('บันทึกสินค้าด่วน:', quickItems);
                
                // Update quick items display
                updateQuickItemsDisplay();
            } else {
                console.log('สินค้านี้มีอยู่แล้ว ไม่บันทึกซ้ำ');
            }
        }

        // Update Quick Items Display Function
        function updateQuickItemsDisplay() {
            const quickItems = JSON.parse(localStorage.getItem('quickItems') || '[]');
            const quickItemsContainer = document.querySelector('.flex.gap-2.flex-wrap');
            
            if (quickItemsContainer) {
                let html = '';
                
                // Add saved quick items first (with different color)
                quickItems.forEach(item => {
                    html += `
                        <button type="button" onclick="quickAddItem('${item.name}', ${item.price})" 
                                class="bg-indigo-500 hover:bg-indigo-600 text-white px-3 py-1 rounded text-xs font-medium">
                            ${item.emoji} ${item.name} ${item.price}฿
                        </button>
                    `;
                });
                
                // Add default items (keep existing ones)
                html += `
                    <button type="button" onclick="quickAddItem('กาแฟ', 20)" 
                            class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-xs font-medium">
                        ☕ กาแฟ 20฿
                    </button>
                    <button type="button" onclick="quickAddItem('ข้าวผัด', 45)" 
                            class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-xs font-medium">
                        🍛 ข้าวผัด 45฿
                    </button>
                    <button type="button" onclick="quickAddItem('น้ำส้ม', 30)" 
                            class="bg-orange-500 hover:bg-orange-600 text-white px-3 py-1 rounded text-xs font-medium">
                        🧃 น้ำส้ม 30฿
                    </button>
                    <button type="button" onclick="quickAddItem('ขนม', 15)" 
                            class="bg-purple-500 hover:bg-purple-600 text-white px-3 py-1 rounded text-xs font-medium">
                        🍪 ขนม 15฿
                    </button>
                    <button type="button" onclick="quickAddItem('น้ำเปล่า', 10)" 
                            class="bg-cyan-500 hover:bg-cyan-600 text-white px-3 py-1 rounded text-xs font-medium">
                        💧 น้ำเปล่า 10฿
                    </button>
                    <button type="button" onclick="quickAddItem('ข้าวกะเพรา', 35)" 
                            class="bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-1 rounded text-xs font-medium">
                        🍚 ข้าวกะเพรา 35฿
                    </button>
                    <button type="button" onclick="quickAddItem('ส้มตำ', 25)" 
                            class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-xs font-medium">
                        🥗 ส้มตำ 25฿
                    </button>
                    <button type="button" onclick="quickAddItem('ไก่ทอด', 50)" 
                            class="bg-amber-500 hover:bg-amber-600 text-white px-3 py-1 rounded text-xs font-medium">
                        🍗 ไก่ทอด 50฿
                    </button>
                    <button type="button" onclick="quickAddItem('น้ำอัดลม', 25)" 
                            class="bg-pink-500 hover:bg-pink-600 text-white px-3 py-1 rounded text-xs font-medium">
                        🥤 น้ำอัดลม 25฿
                    </button>
                    <button type="button" onclick="quickAddItem('ไอศกรีม', 20)" 
                            class="bg-indigo-500 hover:bg-indigo-600 text-white px-3 py-1 rounded text-xs font-medium">
                        🍦 ไอศกรีม 20฿
                    </button>
                    <button type="button" onclick="quickAddItem('ข้าวมันไก่', 40)" 
                            class="bg-teal-500 hover:bg-teal-600 text-white px-3 py-1 rounded text-xs font-medium">
                        🍗 ข้าวมันไก่ 40฿
                    </button>
                    <button type="button" onclick="quickAddItem('ก๋วยเตี๋ยว', 30)" 
                            class="bg-lime-500 hover:bg-lime-600 text-white px-3 py-1 rounded text-xs font-medium">
                        🍜 ก๋วยเตี๋ยว 30฿
                    </button>
                `;
                
                quickItemsContainer.innerHTML = html;
                console.log('อัปเดตปุ่มสินค้าด่วน:', quickItems.length, 'รายการที่บันทึก + ปุ่มเริ่มต้น');
            }
        }

        // Update Items Display
        function updateItemsDisplay() {
            console.log('updateItemsDisplay ถูกเรียก');
            console.log('selectedItems:', selectedItems);
            
            const selectedItemsDiv = document.getElementById('selected-items');
            const totalItemsSpan = document.getElementById('total-items');
            const totalAmountSpan = document.getElementById('total-amount');
            
            console.log('selectedItemsDiv:', selectedItemsDiv);
            console.log('totalItemsSpan:', totalItemsSpan);
            console.log('totalAmountSpan:', totalAmountSpan);
            
            if (selectedItems.length === 0) {
                selectedItemsDiv.innerHTML = '<div class="text-gray-500 text-center py-4">ยังไม่มีรายการสินค้า</div>';
                totalItemsSpan.textContent = '0';
                totalAmountSpan.textContent = '0.00';
                return;
            }
            
            let totalAmount = 0;
            let html = '<div class="space-y-2">';
            
            console.log('เริ่มสร้าง HTML สำหรับ', selectedItems.length, 'รายการ');
            
            selectedItems.forEach((item, index) => {
                console.log('สร้าง HTML สำหรับ item:', item);
                totalAmount += item.total;
                html += `
                    <div class="bg-gray-50 border rounded-lg p-3">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <span class="text-lg">${item.emoji}</span>
                                <span class="font-medium">${item.name}</span>
                                <span class="text-sm text-gray-600">x${item.quantity}</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="font-bold text-blue-600">${item.total.toFixed(2)}</span>
                                <button onclick="removeItem(${item.id})" class="text-red-500 hover:text-red-700">
                                    🗑️
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            console.log('HTML ที่สร้าง:', html);
            selectedItemsDiv.innerHTML = html;
            totalItemsSpan.textContent = selectedItems.length;
            totalAmountSpan.textContent = totalAmount.toFixed(2);
            
            // Update form data
            updateFormData();
        }

        // Remove Item Function
        function removeItem(itemId) {
            selectedItems = selectedItems.filter(item => item.id !== itemId);
            updateItemsDisplay();
        }

        // Update Form Data Function
        function updateFormData() {
            console.log('updateFormData ถูกเรียก');
            
            const itemsDataInput = document.getElementById('items-data');
            const calculatedTotalInput = document.getElementById('calculated-total');
            const descriptionInput = document.getElementById('description-input');
            const itemsDataDisplay = document.getElementById('items-data-display');
            
            console.log('itemsDataInput:', itemsDataInput);
            console.log('calculatedTotalInput:', calculatedTotalInput);
            console.log('descriptionInput:', descriptionInput);
            console.log('itemsDataDisplay:', itemsDataDisplay);
            
            // Update items data
            const itemsData = JSON.stringify(selectedItems);
            itemsDataInput.value = itemsData;
            console.log('บันทึก items_data:', itemsData);
            
            // Calculate total
            const total = selectedItems.reduce((sum, item) => sum + item.total, 0);
            calculatedTotalInput.value = total.toFixed(2);
            
            // Create description and display
            if (selectedItems.length === 0) {
                console.log('ไม่มีรายการสินค้า');
                descriptionInput.value = '';
                if (itemsDataDisplay) {
                    itemsDataDisplay.innerHTML = `
                        <div class="text-center py-4">
                            <div class="text-gray-400 text-4xl mb-2">🛒</div>
                            <div class="text-gray-500 mb-4">ยังไม่มีรายการสินค้า</div>
                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                <div class="text-sm text-blue-800 mb-3">💡 เริ่มต้นด้วยการเพิ่มสินค้าด่วน:</div>
                                <div class="flex gap-2 flex-wrap justify-center">
                                    <button type="button" onclick="quickAddItem('กาแฟ', 20)" 
                                            class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-xs font-medium">
                                        ☕ กาแฟ 20฿
                                    </button>
                                    <button type="button" onclick="quickAddItem('ข้าวผัด', 45)" 
                                            class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-xs font-medium">
                                        🍛 ข้าวผัด 45฿
                                    </button>
                                    <button type="button" onclick="quickAddItem('น้ำส้ม', 30)" 
                                            class="bg-orange-500 hover:bg-orange-600 text-white px-3 py-1 rounded text-xs font-medium">
                                        🧃 น้ำส้ม 30฿
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }
            } else {
                console.log('มีรายการสินค้า', selectedItems.length, 'รายการ');
            const description = selectedItems.map(item => `${item.name} x${item.quantity}`).join(', ');
            descriptionInput.value = description;
                
                // Create detailed display
                let displayHTML = '<div class="space-y-2">';
                selectedItems.forEach((item, index) => {
                    console.log('สร้าง display สำหรับ item:', item);
                    displayHTML += `
                        <div class="bg-white border border-gray-200 rounded-lg p-3 shadow-sm">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <span class="text-2xl">${item.emoji}</span>
                                    <div>
                                        <div class="font-medium text-gray-800">${item.name}</div>
                                        <div class="text-sm text-gray-500">${item.tag} • ${item.price}฿ x ${item.quantity}</div>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="font-bold text-green-600 text-lg">${item.total.toFixed(2)} ฿</div>
                                    <div class="text-xs text-gray-400">รายการที่ ${index + 1}</div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                displayHTML += '</div>';
                console.log('Display HTML ที่สร้าง:', displayHTML);
                
                if (itemsDataDisplay) {
                    itemsDataDisplay.innerHTML = displayHTML;
                    console.log('อัปเดต itemsDataDisplay แล้ว');
                } else {
                    console.error('ไม่พบ itemsDataDisplay element');
                }
            }
        }

        // Enter key handler for item inputs
        document.addEventListener('DOMContentLoaded', function() {
            const itemNameInput = document.getElementById('item-name');
            const itemPriceInput = document.getElementById('item-price');
            const itemQuantityInput = document.getElementById('item-quantity');
            const itemTagInput = document.getElementById('item-tag');
            
            if (itemNameInput) {
                itemNameInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                        itemPriceInput.focus();
            }
        });
            }

            if (itemPriceInput) {
                itemPriceInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                        itemQuantityInput.focus();
                    }
                });
            }
            
            if (itemQuantityInput) {
                itemQuantityInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        itemTagInput.focus();
                    }
                });
            }
            
            if (itemTagInput) {
                itemTagInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                addNewItem();
                    }
                });
                
                // Add change event to show preview emoji
                itemTagInput.addEventListener('change', function() {
                    const selectedTag = this.value;
                    const emoji = defaultEmojis[selectedTag] || '😊';
                    console.log('เลือกแท็ก:', selectedTag, 'emoji:', emoji);
                });
            }
        });

        // Update Items Display
        function updateItemsDisplay() {
            if (selectedItems.length === 0) {
                selectedItemsDiv.innerHTML = '<div class="text-gray-500 text-center py-4">ยังไม่มีรายการสินค้า</div>';
                totalItemsSpan.textContent = '0';
                totalAmountSpan.textContent = '0.00';
                return;
            }
            
            let totalAmount = 0;
            
            // Check if mobile view
            const isMobile = window.innerWidth <= 768;
            
            if (isMobile) {
                // Mobile card view - optimized for mobile
                let html = '<div class="space-y-4">';
                
                selectedItems.forEach((item, index) => {
                    totalAmount += item.total;
                    html += `
                        <div class="bg-white border border-gray-200 rounded-xl p-4 shadow-sm">
                            <!-- Item Header with Number and Actions -->
                            <div class="flex items-center justify-between mb-3">
                                <div class="flex items-center gap-3">
                                    <div class="w-8 h-8 bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-full flex items-center justify-center text-sm font-bold">
                                        ${index + 1}
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <span class="text-2xl">${item.emoji || '😊'}</span>
                                        <div>
                                            <div class="font-semibold text-gray-800 text-base">${item.name}</div>
                                            <div class="text-xs text-gray-500">${item.tag || 'ไม่มีแท็ก'}</div>
                                </div>
                                    </div>
                                </div>
                                <div class="flex items-center gap-1">
                                    <button onclick="moveItemUp(${item.id})" 
                                            class="w-8 h-8 bg-gray-100 hover:bg-blue-100 text-gray-600 hover:text-blue-600 rounded-lg flex items-center justify-center text-sm transition-colors ${index === 0 ? 'opacity-50 cursor-not-allowed' : ''}" 
                                            title="เลื่อนขึ้น" ${index === 0 ? 'disabled' : ''}>
                                        ⬆️
                                    </button>
                                    <button onclick="moveItemDown(${item.id})" 
                                            class="w-8 h-8 bg-gray-100 hover:bg-blue-100 text-gray-600 hover:text-blue-600 rounded-lg flex items-center justify-center text-sm transition-colors ${index === selectedItems.length - 1 ? 'opacity-50 cursor-not-allowed' : ''}" 
                                            title="เลื่อนลง" ${index === selectedItems.length - 1 ? 'disabled' : ''}>
                                        ⬇️
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Price and Quantity Controls -->
                            <div class="grid grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label class="block text-xs font-medium text-gray-700 mb-2">💰 ราคา (บาท)</label>
                                    <div class="flex items-center gap-2">
                                                                            <button onclick="decreasePrice(${item.id})" 
                                                class="w-10 h-10 bg-red-500 hover:bg-red-600 text-white rounded-lg flex items-center justify-center text-lg font-bold transition-colors">
                                            -
                                        </button>
                                        <input type="number" value="${item.price}" step="0.01" min="0"
                                               onchange="updateItemPrice(${item.id}, this.value)"
                                               class="flex-1 h-10 border border-gray-300 rounded-lg px-3 text-center text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                        <button onclick="increasePrice(${item.id})" 
                                                class="w-10 h-10 bg-green-500 hover:bg-green-600 text-white rounded-lg flex items-center justify-center text-lg font-bold transition-colors">
                                            +
                                        </button>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-700 mb-2">📊 จำนวน</label>
                                    <div class="flex items-center gap-2">
                                                                            <button onclick="decreaseQuantity(${item.id})" 
                                                class="w-10 h-10 bg-red-500 hover:bg-red-600 text-white rounded-lg flex items-center justify-center text-lg font-bold transition-colors">
                                            -
                                        </button>
                                        <input type="number" value="${item.quantity}" min="1"
                                               onchange="updateItemQuantity(${item.id}, this.value)"
                                               class="flex-1 h-10 border border-gray-300 rounded-lg px-3 text-center text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                        <button onclick="increaseQuantity(${item.id})" 
                                                class="w-10 h-10 bg-green-500 hover:bg-green-600 text-white rounded-lg flex items-center justify-center text-lg font-bold transition-colors">
                                            +
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Tag Selection -->
                            <div class="mb-4">
                                <label class="block text-xs font-medium text-gray-700 mb-2">🏷️ แท็ก</label>
                                <select onchange="updateItemTag(${item.id}, this.value)" 
                                        class="w-full h-10 border border-gray-300 rounded-lg px-3 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <option value="">--เลือกแท็ก--</option>
                                    <option value="อาหาร" ${item.tag === 'อาหาร' ? 'selected' : ''}>🍽️ อาหาร</option>
                                    <option value="เครื่องดื่ม" ${item.tag === 'เครื่องดื่ม' ? 'selected' : ''}>🥤 เครื่องดื่ม</option>
                                    <option value="ของใช้" ${item.tag === 'ของใช้' ? 'selected' : ''}>🛍️ ของใช้</option>
                                    <option value="ยา" ${item.tag === 'ยา' ? 'selected' : ''}>💊 ยา</option>
                                    <option value="ขนม" ${item.tag === 'ขนม' ? 'selected' : ''}>🍪 ขนม</option>
                                    <option value="ผลไม้" ${item.tag === 'ผลไม้' ? 'selected' : ''}>🍎 ผลไม้</option>
                                    <option value="ผัก" ${item.tag === 'ผัก' ? 'selected' : ''}>🥬 ผัก</option>
                                    <option value="เนื้อสัตว์" ${item.tag === 'เนื้อสัตว์' ? 'selected' : ''}>🥩 เนื้อสัตว์</option>
                                    <option value="นม" ${item.tag === 'นม' ? 'selected' : ''}>🥛 นม</option>
                                    <option value="ขนมปัง" ${item.tag === 'ขนมปัง' ? 'selected' : ''}>🍞 ขนมปัง</option>
                                </select>
                            </div>
                            
                            <!-- Item Total and Actions -->
                            <div class="flex items-center justify-between pt-3 border-t border-gray-200">
                                <div class="text-center">
                                    <div class="text-xs text-gray-500 mb-1">ยอดรวม</div>
                                    <div class="font-bold text-green-600 text-lg">${item.total.toFixed(2)} ฿</div>
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="duplicateItem(${item.id})" 
                                            class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors" title="คัดลอก">
                                        📋 คัดลอก
                                    </button>
                                    <button onclick="removeItem(${item.id})" 
                                            class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors" title="ลบรายการ">
                                        🗑️ ลบ
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                // Add total summary
                html += `
                    <div class="bg-gradient-to-r from-green-50 to-blue-50 border border-green-200 rounded-xl p-6 shadow-sm">
                        <div class="text-center">
                            <div class="text-sm text-gray-600 mb-2">📊 สรุปยอดรวม</div>
                            <div class="flex justify-between items-center mb-3">
                                <span class="text-gray-700">จำนวนรายการ:</span>
                                <span class="font-semibold text-blue-600">${selectedItems.length} รายการ</span>
                            </div>
                        <div class="flex justify-between items-center">
                                <span class="text-lg font-semibold text-gray-800">ยอดรวมทั้งหมด:</span>
                                <span class="text-2xl font-bold text-green-600">${totalAmount.toFixed(2)} ฿</span>
                            </div>
                        </div>
                    </div>
                </div>
                `;
                
                selectedItemsDiv.innerHTML = html;
            } else {
                // Desktop table view
                let html = `
                    <div class="overflow-x-auto">
                        <table class="items-table w-full border-collapse border border-gray-300">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="border border-gray-300 px-4 py-3 text-left text-sm font-semibold text-gray-700">ลำดับ</th>
                                    <th class="border border-gray-300 px-4 py-3 text-left text-sm font-semibold text-gray-700">ชื่อสินค้า</th>
                                    <th class="border border-gray-300 px-4 py-3 text-left text-sm font-semibold text-gray-700">แท็ก</th>
                                    <th class="border border-gray-300 px-4 py-3 text-left text-sm font-semibold text-gray-700">ราคา (บาท)</th>
                                    <th class="border border-gray-300 px-4 py-3 text-left text-sm font-semibold text-gray-700">จำนวน</th>
                                    <th class="border border-gray-300 px-4 py-3 text-left text-sm font-semibold text-gray-700">รวม (บาท)</th>
                                    <th class="border border-gray-300 px-4 py-3 text-left text-sm font-semibold text-gray-700">จัดการ</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                selectedItems.forEach((item, index) => {
                    totalAmount += item.total;
                    html += `
                        <tr class="hover:bg-gray-50">
                            <td class="border border-gray-300 px-4 py-3 text-center">
                                <div class="flex flex-col items-center gap-2">
                                    <div class="w-8 h-8 bg-blue-500 text-white rounded-full flex items-center justify-center text-sm font-bold">
                                        ${index + 1}
                                    </div>
                                    <div class="flex gap-1">
                                        <button onclick="moveItemUp(${item.id})" 
                                                class="text-gray-500 hover:text-blue-600 text-sm px-2 py-1 rounded hover:bg-blue-50 ${index === 0 ? 'opacity-50 cursor-not-allowed' : ''}" 
                                                title="เลื่อนขึ้น" ${index === 0 ? 'disabled' : ''}>
                                            ⬆️
                                        </button>
                                        <button onclick="moveItemDown(${item.id})" 
                                                class="text-gray-500 hover:text-blue-600 text-sm px-2 py-1 rounded hover:bg-blue-50 ${index === selectedItems.length - 1 ? 'opacity-50 cursor-not-allowed' : ''}" 
                                                title="เลื่อนลง" ${index === selectedItems.length - 1 ? 'disabled' : ''}>
                                            ⬇️
                                        </button>
                                    </div>
                                </div>
                            </td>
                            <td class="border border-gray-300 px-4 py-3">
                                <input type="text" value="${item.name}" 
                                       onchange="updateItemName(${item.id}, this.value)"
                                       class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </td>
                            <td class="border border-gray-300 px-4 py-3">
                                <div class="flex items-center gap-3">
                                    <span class="text-2xl">${item.emoji || '😊'}</span>
                                    <select onchange="updateItemTag(${item.id}, this.value)" 
                                            class="flex-1 border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                        <option value="">--เลือกแท็ก--</option>
                                        <option value="อาหาร" ${item.tag === 'อาหาร' ? 'selected' : ''}>🍽️ อาหาร</option>
                                        <option value="เครื่องดื่ม" ${item.tag === 'เครื่องดื่ม' ? 'selected' : ''}>🥤 เครื่องดื่ม</option>
                                        <option value="ของใช้" ${item.tag === 'ของใช้' ? 'selected' : ''}>🛍️ ของใช้</option>
                                        <option value="ยา" ${item.tag === 'ยา' ? 'selected' : ''}>💊 ยา</option>
                                        <option value="ขนม" ${item.tag === 'ขนม' ? 'selected' : ''}>🍪 ขนม</option>
                                        <option value="ผลไม้" ${item.tag === 'ผลไม้' ? 'selected' : ''}>🍎 ผลไม้</option>
                                        <option value="ผัก" ${item.tag === 'ผัก' ? 'selected' : ''}>🥬 ผัก</option>
                                        <option value="เนื้อสัตว์" ${item.tag === 'เนื้อสัตว์' ? 'selected' : ''}>🥩 เนื้อสัตว์</option>
                                        <option value="นม" ${item.tag === 'นม' ? 'selected' : ''}>🥛 นม</option>
                                        <option value="ขนมปัง" ${item.tag === 'ขนมปัง' ? 'selected' : ''}>🍞 ขนมปัง</option>
                                    </select>
                                </div>
                            </td>
                            <td class="border border-gray-300 px-4 py-3">
                                <div class="flex items-center gap-2">
                                    <button onclick="decreasePrice(${item.id})" 
                                            class="bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded-lg text-sm font-semibold">-</button>
                                    <input type="number" value="${item.price}" step="0.01" min="0"
                                           onchange="updateItemPrice(${item.id}, this.value)"
                                           class="flex-1 border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <button onclick="increasePrice(${item.id})" 
                                            class="bg-green-500 hover:bg-green-600 text-white px-3 py-2 rounded-lg text-sm font-semibold">+</button>
                                </div>
                            </td>
                            <td class="border border-gray-300 px-4 py-3">
                                <div class="flex items-center gap-2">
                                    <button onclick="decreaseQuantity(${item.id})" 
                                            class="bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded-lg text-sm font-semibold">-</button>
                                    <input type="number" value="${item.quantity}" min="1"
                                           onchange="updateItemQuantity(${item.id}, this.value)"
                                           class="flex-1 border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <button onclick="increaseQuantity(${item.id})" 
                                            class="bg-green-500 hover:bg-green-600 text-white px-3 py-2 rounded-lg text-sm font-semibold">+</button>
                                </div>
                            </td>
                            <td class="border border-gray-300 px-4 py-3 text-center">
                                <div class="text-lg font-bold text-green-600">${item.total.toFixed(2)}</div>
                            </td>
                            <td class="border border-gray-300 px-4 py-3 text-center">
                                <div class="flex gap-2 justify-center">
                                    <button onclick="duplicateItem(${item.id})" 
                                            class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-semibold" title="คัดลอก">
                                        📋 คัดลอก
                                    </button>
                                    <button onclick="removeItem(${item.id})" 
                                            class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm font-semibold" title="ลบรายการ">
                                        🗑️ ลบ
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
                
                // Add total row
                html += `
                            <tr class="bg-green-50">
                                <td colspan="5" class="border border-gray-300 px-4 py-3 text-right font-semibold text-gray-700">ยอดรวมทั้งหมด:</td>
                                <td class="border border-gray-300 px-4 py-3 text-center font-bold text-green-600 text-lg">${totalAmount.toFixed(2)}</td>
                                <td class="border border-gray-300 px-4 py-3"></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                `;
                
                selectedItemsDiv.innerHTML = html;
            }
            
            totalItemsSpan.textContent = selectedItems.length.toString();
            totalAmountSpan.textContent = totalAmount.toFixed(2);
            
            // Update hidden inputs
            document.getElementById('items-data').value = JSON.stringify(selectedItems);
            document.getElementById('calculated-total').value = totalAmount.toFixed(2);
            
            // Create description
            const descriptions = selectedItems.map(item => 
                `${item.name} x${item.quantity}`
            );
            document.getElementById('description').value = descriptions.join(', ');
        }

        // Update Item Name Function
        function updateItemName(itemId, newName) {
            const item = selectedItems.find(item => item.id === itemId);
            if (item && newName.trim()) {
                item.name = newName.trim();
            updateItemsDisplay();
        }
        }

        // Update Item Price Function
        function updateItemPrice(itemId, newPrice) {
            const item = selectedItems.find(item => item.id === itemId);
            const price = parseFloat(newPrice);
            if (item && !isNaN(price) && price >= 0) {
                item.price = price;
                item.total = item.price * item.quantity;
                updateItemsDisplay();
            }
        }

        // Update Item Quantity Function
        function updateItemQuantity(itemId, newQuantity) {
            const item = selectedItems.find(item => item.id === itemId);
            const quantity = parseInt(newQuantity);
            if (item && !isNaN(quantity) && quantity > 0) {
                item.quantity = quantity;
                item.total = item.price * item.quantity;
                updateItemsDisplay();
            }
        }

        // Increase/Decrease Price Functions
        function increasePrice(itemId) {
            const item = selectedItems.find(item => item.id === itemId);
            if (item) {
                item.price += 1;
                item.total = item.price * item.quantity;
                updateItemsDisplay();
            }
        }

        function decreasePrice(itemId) {
            const item = selectedItems.find(item => item.id === itemId);
            if (item && item.price > 0) {
                item.price = Math.max(0, item.price - 1);
                item.total = item.price * item.quantity;
                updateItemsDisplay();
            }
        }

        // Increase/Decrease Quantity Functions
        function increaseQuantity(itemId) {
            const item = selectedItems.find(item => item.id === itemId);
            if (item) {
                item.quantity += 1;
                item.total = item.price * item.quantity;
                updateItemsDisplay();
            }
        }

        function decreaseQuantity(itemId) {
            const item = selectedItems.find(item => item.id === itemId);
            if (item && item.quantity > 1) {
                item.quantity = Math.max(1, item.quantity - 1);
                item.total = item.price * item.quantity;
                updateItemsDisplay();
            }
        }

        // Duplicate Item Function
        function duplicateItem(itemId) {
            const originalItem = selectedItems.find(item => item.id === itemId);
            if (originalItem) {
                const newItem = {
                    id: ++itemCounter,
                    name: originalItem.name + ' (คัดลอก)',
                    tag: originalItem.tag,
                    emoji: originalItem.emoji,
                    price: originalItem.price,
                    quantity: originalItem.quantity,
                    total: originalItem.price * originalItem.quantity
                };
                
                selectedItems.push(newItem);
                updateItemsDisplay();
                
                // Show feedback
                const duplicateBtn = document.querySelector(`[data-item-id="${itemId}"][data-action="duplicate"]`);
                if (duplicateBtn) {
                    duplicateBtn.style.transform = 'scale(1.2)';
                    setTimeout(() => {
                        duplicateBtn.style.transform = 'scale(1)';
                    }, 200);
                }
            }
        }

        // Move Item Up Function
        function moveItemUp(itemId) {
            const index = selectedItems.findIndex(item => item.id === itemId);
            if (index > 0) {
                const temp = selectedItems[index];
                selectedItems[index] = selectedItems[index - 1];
                selectedItems[index - 1] = temp;
                updateItemsDisplay();
            }
        }

        // Move Item Down Function
        function moveItemDown(itemId) {
            const index = selectedItems.findIndex(item => item.id === itemId);
            if (index < selectedItems.length - 1) {
                const temp = selectedItems[index];
                selectedItems[index] = selectedItems[index + 1];
                selectedItems[index + 1] = temp;
                updateItemsDisplay();
            }
        }

        // Show Items Summary Function
        function showItemsSummary() {
                if (selectedItems.length === 0) {
                alert('ไม่มีรายการสินค้าให้แสดงสรุป');
                    return;
                }

            let summary = '📋 สรุปรายการสินค้า\n\n';
            let totalAmount = 0;

            selectedItems.forEach((item, index) => {
                summary += `${index + 1}. ${item.emoji || '😊'} ${item.name}`;
                if (item.tag) {
                    summary += ` [${item.tag}]`;
                }
                summary += `\n`;
                summary += `   ราคา: ${item.price.toFixed(2)} บาท × ${item.quantity} = ${item.total.toFixed(2)} บาท\n\n`;
                totalAmount += item.total;
            });

            summary += `💰 ยอดรวมทั้งหมด: ${totalAmount.toFixed(2)} บาท`;
            summary += `\n📊 จำนวนรายการ: ${selectedItems.length} รายการ`;

            alert(summary);
        }

        // Add Tag Button Handler
        document.getElementById('add-tag-btn').addEventListener('click', function() {
            const customInput = document.getElementById('custom-tag-input');
            const newTagInput = document.getElementById('new-tag');
            
            if (customInput.classList.contains('hidden')) {
                customInput.classList.remove('hidden');
                newTagInput.focus();
            } else {
                addCustomTag();
            }
        });

        // Add Custom Tag Function
        function addCustomTag() {
            const newTagInput = document.getElementById('new-tag');
            const tagName = newTagInput.value.trim();
            
            if (!tagName) {
                alert('กรุณาใส่ชื่อแท็ก');
                    return;
                }
            
            if (availableTags.includes(tagName)) {
                alert('แท็กนี้มีอยู่แล้ว');
                return;
            }
            
            // Add to available tags
            availableTags.push(tagName);
            
            // Add to select options
            const tagSelect = document.getElementById('item-tag');
            const option = document.createElement('option');
            option.value = tagName;
            option.textContent = tagName;
            tagSelect.appendChild(option);
            
            // Select the new tag
            tagSelect.value = tagName;
            
            // Hide input and clear
            document.getElementById('custom-tag-input').classList.add('hidden');
            newTagInput.value = '';
            
            alert(`เพิ่มแท็ก "${tagName}" เรียบร้อยแล้ว`);
        }

        // Cancel Add Tag Function
        function cancelAddTag() {
            document.getElementById('custom-tag-input').classList.add('hidden');
            document.getElementById('new-tag').value = '';
        }

        // Update Item Tag Function
        function updateItemTag(itemId, newTag) {
            const item = selectedItems.find(item => item.id === itemId);
            if (item) {
                item.tag = newTag;
                updateItemsDisplay();
            }
        }

        // Enter key handler for custom tag
        document.getElementById('new-tag').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                addCustomTag();
            }
        });

        // Show Emoji Picker Function
        function showEmojiPicker() {
            const modal = document.getElementById('emoji-picker-modal');
            const grid = document.getElementById('emoji-grid');
            const selectedTag = document.getElementById('item-tag').value;
            
            // Clear previous emojis
            grid.innerHTML = '';
            
            if (selectedTag && emojiData[selectedTag]) {
                // Show emojis for selected tag
                emojiData[selectedTag].forEach(emoji => {
                    const button = document.createElement('button');
                    button.className = 'text-2xl p-2 hover:bg-gray-100 rounded';
                    button.textContent = emoji;
                    button.onclick = () => selectEmoji(emoji);
                    grid.appendChild(button);
                });
            } else {
                // Show all emojis
                const allEmojis = [
                    '😀', '😃', '😄', '😁', '😆', '😅', '😂', '🤣', '😊', '😇',
                    '🙂', '🙃', '😉', '😌', '😍', '🥰', '😘', '😗', '😙', '😚',
                    '😋', '😛', '😝', '😜', '🤪', '🤨', '🧐', '🤓', '😎', '🤩',
                    '🥳', '😏', '😒', '😞', '😔', '😟', '😕', '🙁', '☹️', '😣',
                    '😖', '😫', '😩', '🥺', '😢', '😭', '😤', '😠', '😡', '🤬',
                    '🤯', '😳', '🥵', '🥶', '😱', '😨', '😰', '😥', '😓', '🤗',
                    '🤔', '🤭', '🤫', '🤥', '😶', '😐', '😑', '😯', '😦', '😧',
                    '😮', '😲', '🥱', '😴', '🤤', '😪', '😵', '🤐', '🥴', '🤢',
                    '🤮', '🤧', '😷', '🤒', '🤕', '🤑', '🤠', '💩', '🤡', '👹',
                    '👺', '👻', '👽', '👾', '🤖', '😺', '😸', '😹', '😻', '😼',
                    '😽', '🙀', '😿', '😾', '🙈', '🙉', '🙊', '💌', '💘', '💝',
                    '💖', '💗', '💓', '💞', '💕', '💟', '❣️', '💔', '❤️', '🧡',
                    '💛', '💚', '💙', '💜', '🖤', '🤍', '🤎', '💯', '💢', '💥',
                    '💫', '💦', '💨', '🕳️', '💬', '🗨️', '🗯️', '💭', '💤', '👋',
                    '🤚', '🖐️', '✋', '🖖', '👌', '🤌', '🤏', '✌️', '🤞', '🤟',
                    '🤘', '🤙', '👈', '👉', '👆', '🖕', '👇', '☝️', '👍', '👎',
                    '✊', '👊', '🤛', '🤜', '👏', '🙌', '👐', '🤲', '🤝', '🙏',
                    '✍️', '💪', '🦾', '🦿', '🦵', '🦶', '👂', '🦻', '👃', '🧠',
                    '🫀', '🫁', '🦷', '🦴', '👀', '👁️', '👅', '👄', '💋', '🩸',
                    '🍽️', '🍜', '🍕', '🍔', '🍟', '🌮', '🌯', '🥪', '🍱', '🍛',
                    '🥤', '☕', '🧃', '🍺', '🍷', '🥛', '🧋', '🍹', '🥤', '💧',
                    '🛍️', '🧴', '🧻', '🧽', '👕', '👖', '👟', '👜', '💄', '🪞',
                    '💊', '🏥', '🩺', '🩹', '🩻', '💉', '🩸', '🧬', '🔬', '📋',
                    '🍪', '🍩', '🍰', '🧁', '🍦', '🍨', '🍭', '🍫', '🍬', '🍡',
                    '🍎', '🍌', '🍊', '🍇', '🍓', '🍑', '🥭', '🍍', '🥥', '🥝',
                    '🥬', '🥕', '🥦', '🥒', '🍅', '🌽', '🥑', '🥒', '🧅', '🧄',
                    '🥩', '🍗', '🍖', '🥓', '🍖', '🐟', '🦐', '🦑', '🦞', '🦀',
                    '🥛', '🧀', '🍦', '🍨', '🥛', '🧈', '🥛', '🍼', '🥛', '🥛',
                    '🍞', '🥖', '🥨', '🥯', '🥐', '🥪', '🍞', '🥖', '🥨', '🥯'
                ];
                
                allEmojis.forEach(emoji => {
                    const button = document.createElement('button');
                    button.className = 'text-2xl p-2 hover:bg-gray-100 rounded';
                    button.textContent = emoji;
                    button.onclick = () => selectEmoji(emoji);
                    grid.appendChild(button);
                });
            }
            
            modal.classList.remove('hidden');
        }

        // Close Emoji Picker Function
        function closeEmojiPicker() {
            document.getElementById('emoji-picker-modal').classList.add('hidden');
        }

        // Select Emoji Function
        function selectEmoji(emoji) {
            const selectedTag = document.getElementById('item-tag').value;
            const emojiBtn = document.getElementById('emoji-picker-btn');
            
            // Update emoji button
            emojiBtn.textContent = emoji;
            
            // Store selected emoji for the current tag
            if (selectedTag) {
                if (!window.selectedEmojis) {
                    window.selectedEmojis = {};
                }
                window.selectedEmojis[selectedTag] = emoji;
            }
            
            closeEmojiPicker();
        }

        // Update Tag Emoji Function
        function updateTagEmoji() {
            const selectedTag = document.getElementById('item-tag').value;
            const emojiBtn = document.getElementById('emoji-picker-btn');
            
            if (selectedTag) {
                // Use stored emoji or default
                const storedEmoji = window.selectedEmojis && window.selectedEmojis[selectedTag];
                const defaultEmoji = defaultEmojis[selectedTag];
                emojiBtn.textContent = storedEmoji || defaultEmoji || '😊';
            } else {
                emojiBtn.textContent = '😊';
            }
        }

        // Show Tag Filter Function
        function showTagFilter() {
            if (selectedItems.length === 0) {
                alert('ไม่มีรายการสินค้าให้กรอง');
                return;
            }

            // Get unique tags from items
            const itemTags = selectedItems.map(item => item.tag).filter(tag => tag);
            const uniqueTags = [...new Set(itemTags)];

            if (uniqueTags.length === 0) {
                alert('ไม่มีแท็กในรายการสินค้า');
                return;
            }

            let filterOptions = '🏷️ เลือกแท็กที่ต้องการกรอง:\n\n';
            uniqueTags.forEach((tag, index) => {
                const count = selectedItems.filter(item => item.tag === tag).length;
                filterOptions += `${index + 1}. ${tag} (${count} รายการ)\n`;
            });
            filterOptions += '\n0. แสดงทั้งหมด';

            const choice = prompt(filterOptions + '\n\nกรุณาใส่หมายเลขที่ต้องการ:');
            
            if (choice === null) return; // User cancelled
            
            const choiceNum = parseInt(choice);
            if (choiceNum === 0) {
                // Show all items
            updateItemsDisplay();
                alert('แสดงรายการทั้งหมด');
            } else if (choiceNum >= 1 && choiceNum <= uniqueTags.length) {
                // Filter by selected tag
                const selectedTag = uniqueTags[choiceNum - 1];
                const filteredItems = selectedItems.filter(item => item.tag === selectedTag);
                
                if (filteredItems.length > 0) {
                    let summary = `🏷️ รายการสินค้าที่มีแท็ก "${selectedTag}":\n\n`;
                    let totalAmount = 0;

                    filteredItems.forEach((item, index) => {
                        summary += `${index + 1}. ${item.emoji || '😊'} ${item.name}\n`;
                        summary += `   ราคา: ${item.price.toFixed(2)} บาท × ${item.quantity} = ${item.total.toFixed(2)} บาท\n\n`;
                        totalAmount += item.total;
                    });

                    summary += `💰 ยอดรวม: ${totalAmount.toFixed(2)} บาท`;
                    summary += `\n📊 จำนวนรายการ: ${filteredItems.length} รายการ`;

                    alert(summary);
                }
            } else {
                alert('กรุณาเลือกหมายเลขที่ถูกต้อง');
            }
        }

        // Form Submit Handler
        document.getElementById('transaction-form').addEventListener('submit', function(e) {
            const transactionType = transactionTypeSelect.value;
            const mainCategory = mainCategorySelect.value;
            const subCategory = subCategorySelect.value;
            
            if (!transactionType) {
                e.preventDefault();
                alert('กรุณาเลือกประเภทรายการ');
                return;
            }
            
            if (!mainCategory) {
                e.preventDefault();
                alert('กรุณาเลือกประเภทหลัก');
                return;
            }
            
            if (!subCategory) {
                e.preventDefault();
                alert('กรุณาเลือกประเภทย่อย');
                return;
            }
            
            if (transactionType === 'income') {
                const incomeAmount = parseFloat(document.getElementById('income-amount').value) || 0;
                if (incomeAmount <= 0) {
                    e.preventDefault();
                    alert('กรุณากรอกจำนวนเงินสำหรับรายรับ');
                    return;
                }
                
                // Set values for income
                document.getElementById('calculated-total').value = incomeAmount.toFixed(2);
                document.getElementById('description').value = `รายรับ: ${mainCategory} > ${subCategory}`;
                document.getElementById('items-data').value = '';
                
            } else if (transactionType === 'expense') {
                if (selectedItems.length === 0) {
                    e.preventDefault();
                    alert('กรุณาเพิ่มรายการสินค้าอย่างน้อย 1 รายการ');
                    return;
                }
                
                const vendor = document.getElementById('vendor-select').value;
                if (!vendor) {
                    e.preventDefault();
                    alert('กรุณาเลือกร้านค้า');
                    return;
                }
            }
        });

        // Add Main Category Button Handler
        document.getElementById('add-main-category-btn').addEventListener('click', function() {
            const customInput = document.getElementById('custom-main-category-input');
            const newCategoryInput = document.getElementById('new-main-category');
            
            if (customInput.classList.contains('hidden')) {
                customInput.classList.remove('hidden');
                newCategoryInput.focus();
            } else {
                addCustomMainCategory();
            }
        });

        // Add Custom Main Category Function
        function addCustomMainCategory() {
            const newCategoryInput = document.getElementById('new-main-category');
            const categoryName = newCategoryInput.value.trim();
            const transactionType = transactionTypeSelect.value;
            
            if (!categoryName) {
                alert('กรุณาใส่ชื่อประเภทหลัก');
                return;
            }
            
            if (!transactionType) {
                    alert('กรุณาเลือกประเภทรายการก่อน');
                    return;
                }
                
            // Add to category data structure
            if (!categoryData[transactionType][categoryName]) {
                categoryData[transactionType][categoryName] = [];
            }
            
            // Add to select options
                const option = document.createElement('option');
                option.value = categoryName;
                option.textContent = categoryName;
            mainCategorySelect.appendChild(option);
            
            // Select the new category
            mainCategorySelect.value = categoryName;
            
            // Hide input and clear
            document.getElementById('custom-main-category-input').classList.add('hidden');
            newCategoryInput.value = '';
            
            // Clear sub categories
            subCategorySelect.innerHTML = '<option value="">--เลือกประเภทย่อย--</option>';
            updateCategoryDisplay();
                
                alert(`เพิ่มประเภทหลัก "${categoryName}" เรียบร้อยแล้ว`);
        }

        // Enter key handler for custom main category
        document.getElementById('new-main-category').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                addCustomMainCategory();
            }
        });

        // Add Sub Category Button Handler
        document.getElementById('add-sub-category-btn').addEventListener('click', function() {
            const customInput = document.getElementById('custom-sub-category-input');
            const newCategoryInput = document.getElementById('new-sub-category');
            
            if (customInput.classList.contains('hidden')) {
                customInput.classList.remove('hidden');
                newCategoryInput.focus();
            } else {
                addCustomSubCategory();
            }
        });

        // Add Custom Sub Category Function
        function addCustomSubCategory() {
            const newCategoryInput = document.getElementById('new-sub-category');
            const subCategoryName = newCategoryInput.value.trim();
            const mainCategory = mainCategorySelect.value;
            const transactionType = transactionTypeSelect.value;
            
            if (!subCategoryName) {
                alert('กรุณาใส่ชื่อประเภทย่อย');
                return;
            }
            
            if (!mainCategory) {
                alert('กรุณาเลือกประเภทหลักก่อน');
                return;
            }
            
            // Add to category data structure
            if (!categoryData[transactionType][mainCategory]) {
                categoryData[transactionType][mainCategory] = [];
            }
            
            if (categoryData[transactionType][mainCategory].includes(subCategoryName)) {
                alert('ประเภทย่อยนี้มีอยู่แล้ว');
                return;
            }
            
            categoryData[transactionType][mainCategory].push(subCategoryName);
            
            // Add to select options
                const option = document.createElement('option');
            option.value = subCategoryName;
            option.textContent = subCategoryName;
            subCategorySelect.appendChild(option);
            
            // Select the new sub category
            subCategorySelect.value = subCategoryName;
            
            // Hide input and clear
            document.getElementById('custom-sub-category-input').classList.add('hidden');
            newCategoryInput.value = '';
            
            updateCategoryDisplay();
            
            alert(`เพิ่มประเภทย่อย "${subCategoryName}" เรียบร้อยแล้ว`);
        }

        // Enter key handler for custom sub category
        document.getElementById('new-sub-category').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                addCustomSubCategory();
            }
        });

        // Add Vendor Button Handler
        document.addEventListener('DOMContentLoaded', function() {
            const addVendorBtn = document.getElementById('add-vendor-btn');
            if (addVendorBtn) {
                addVendorBtn.addEventListener('click', function() {
                    console.log('ปุ่มเพิ่มร้านค้าถูกคลิก');
                    const customInput = document.getElementById('custom-vendor-input');
                    const newVendorInput = document.getElementById('new-vendor');
                    
                    if (customInput.classList.contains('hidden')) {
                        customInput.classList.remove('hidden');
                        newVendorInput.focus();
                    } else {
                        addCustomVendor();
                    }
                });
            } else {
                console.error('ไม่พบปุ่ม add-vendor-btn');
            }
        });

        // Test Vendor Button Function
        function testVendorButton() {
            console.log('ปุ่มทดสอบถูกคลิก!');
            
            const customInput = document.getElementById('custom-vendor-input');
            const newVendorInput = document.getElementById('new-vendor');
            
            if (customInput.classList.contains('hidden')) {
                customInput.classList.remove('hidden');
                newVendorInput.focus();
                console.log('แสดง input field แล้ว');
            } else {
                testAddVendor();
            }
        }

        // Test Add Vendor Function
        function testAddVendor() {
            console.log('ฟังก์ชัน testAddVendor ถูกเรียก');
            const newVendorInput = document.getElementById('new-vendor');
            const vendorName = newVendorInput.value.trim();
            
            console.log('ชื่อร้านค้า:', vendorName);
            
            if (!vendorName) {
                alert('กรุณาใส่ชื่อร้านค้า');
                return;
            }
            
            const vendorSelect = document.getElementById('vendor-select');
                
                // Check if vendor already exists
                const existingOptions = Array.from(vendorSelect.options);
                const exists = existingOptions.some(option => option.value === vendorName);
                
                if (exists) {
                    alert('ร้านค้านี้มีอยู่แล้ว');
                    return;
                }
                
                // Add new option
                const option = document.createElement('option');
                option.value = vendorName;
                option.textContent = vendorName;
                vendorSelect.appendChild(option);
            
            // Select the new vendor
                vendorSelect.value = vendorName;
                
            // Hide input and clear
            document.getElementById('custom-vendor-input').classList.add('hidden');
            newVendorInput.value = '';
            
            console.log('เพิ่มร้านค้าเรียบร้อย:', vendorName);
                alert(`เพิ่มร้านค้า "${vendorName}" เรียบร้อยแล้ว`);
            }

        // Add Custom Vendor Function
        function addCustomVendor() {
            console.log('ฟังก์ชัน addCustomVendor ถูกเรียก');
            const newVendorInput = document.getElementById('new-vendor');
            const vendorName = newVendorInput.value.trim();
            
            console.log('ชื่อร้านค้า:', vendorName);
            
            if (!vendorName) {
                alert('กรุณาใส่ชื่อร้านค้า');
                return;
            }
            
            const vendorSelect = document.getElementById('vendor-select');
            
            // Check if vendor already exists
            const existingOptions = Array.from(vendorSelect.options);
            const exists = existingOptions.some(option => option.value === vendorName);
            
            if (exists) {
                alert('ร้านค้านี้มีอยู่แล้ว');
                return;
            }
            
            // Add new option
            const option = document.createElement('option');
            option.value = vendorName;
            option.textContent = vendorName;
            vendorSelect.appendChild(option);
            
            // Select the new vendor
            vendorSelect.value = vendorName;
            
            // Hide input and clear
            document.getElementById('custom-vendor-input').classList.add('hidden');
            newVendorInput.value = '';
            
            console.log('เพิ่มร้านค้าเรียบร้อย:', vendorName);
            alert(`เพิ่มร้านค้า "${vendorName}" เรียบร้อยแล้ว`);
        }

        // Enter key handler for custom vendor
        document.addEventListener('DOMContentLoaded', function() {
            const newVendorInput = document.getElementById('new-vendor');
            if (newVendorInput) {
                newVendorInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        addCustomVendor();
                    }
                });
            }
        });

        // Change Month Function
        function changeMonth(month) {
            window.location.href = `/income-expense?month=${month}`;
        }



        // Export Year Data Function
        function exportYearData(year) {
            const url = `/export-all/${year}`;
            window.open(url, '_blank');
        }

        // Show Monthly Summary Function
        function showMonthlySummary() {
            console.log('showMonthlySummary called');
            const selectedMonth = document.getElementById('month-select').value;
            const monthDisplay = document.getElementById('month-select').options[document.getElementById('month-select').selectedIndex].text;
            
            console.log('Selected month:', selectedMonth, 'Month display:', monthDisplay);
            
            // Get summary data from the page
            const totalIncome = parseFloat('{{ monthly_total_income }}') || 0;
            const totalExpense = parseFloat('{{ monthly_total_expense }}') || 0;
            const balance = totalIncome - totalExpense;
            const totalRecords = parseInt('{{ total_records }}') || 0;
            
            console.log('Summary data:', { totalIncome, totalExpense, balance, totalRecords });
            
            let summary = `📋 สรุปประจำเดือน: ${monthDisplay}\n\n`;
            summary += `💰 รายรับรวม: ${totalIncome.toFixed(2)} บาท\n`;
            summary += `💸 รายจ่ายรวม: ${totalExpense.toFixed(2)} บาท\n`;
            summary += `📊 ยอดคงเหลือ: ${balance.toFixed(2)} บาท\n`;
            summary += `📝 จำนวนรายการ: ${totalRecords} รายการ\n\n`;
            
            if (balance > 0) {
                summary += `✅ สถานะ: มีเงินเหลือ (กำไร)\n`;
            } else if (balance < 0) {
                summary += `⚠️ สถานะ: ใช้เงินเกิน (ขาดทุน)\n`;
            } else {
                summary += `⚖️ สถานะ: เงินเท่ากับรายจ่าย\n`;
            }
            
            // Add percentage analysis
            if (totalIncome > 0) {
                const expensePercentage = ((totalExpense / totalIncome) * 100).toFixed(1);
                summary += `📈 อัตราส่วนรายจ่ายต่อรายรับ: ${expensePercentage}%\n`;
            }
            
            console.log('Showing summary:', summary);
            alert(summary);
        }

        // Modal Quick Add Functions

        // Show Quick Add Modal Function
        function showQuickAddModal() {
            document.getElementById('quick-add-modal').classList.remove('hidden');
            loadModalSavedItems();
        }

        // Close Quick Add Modal Function
        function closeQuickAddModal() {
            document.getElementById('quick-add-modal').classList.add('hidden');
        }

        // Modal Quick Add Item Function
        function modalQuickAddItem(name, price) {
            // Add to main form immediately
            itemCounter++;
            const item = {
                id: itemCounter,
                name: name,
                tag: 'อาหาร',
                emoji: '🍽️',
                price: price,
                quantity: 1,
                total: price
            };
            
            selectedItems.push(item);
            updateItemsDisplay();
            updateFormData();
            
            // Save to quick items
            saveToQuickItems(name, price);
            
            // Show notification
            showModalNotification(`เพิ่ม ${name} ในรายการเรียบร้อย!`);
        }

        // Add Modal Quick Item from Input Function
        function addModalQuickItem() {
            const nameInput = document.getElementById('modal-item-name');
            const priceInput = document.getElementById('modal-item-price');
            
            const name = nameInput.value.trim();
            const price = parseFloat(priceInput.value);
            
            if (!name) {
                showModalNotification('กรุณากรอกชื่อสินค้า', 'error');
                nameInput.focus();
                return;
            }
            
            if (!price || price <= 0) {
                showModalNotification('กรุณากรอกราคาที่ถูกต้อง', 'error');
                priceInput.focus();
                return;
            }
            
            // Add to main form immediately
            itemCounter++;
            const item = {
                id: itemCounter,
                name: name,
                tag: 'อาหาร',
                emoji: '🍽️',
                price: price,
                quantity: 1,
                total: price
            };
            
            selectedItems.push(item);
            updateItemsDisplay();
            updateFormData();
            
            // Save to quick items
            saveToQuickItems(name, price);
            
            // Show notification
            showModalNotification(`เพิ่ม ${name} ในรายการเรียบร้อย!`);
            
            // Clear inputs
            nameInput.value = '';
            priceInput.value = '';
            nameInput.focus();
        }

        // Load Modal Saved Items Function
        function loadModalSavedItems() {
            const quickItems = JSON.parse(localStorage.getItem('quickItems') || '[]');
            const savedItemsContainer = document.getElementById('modal-saved-items');
            
            if (quickItems.length === 0) {
                savedItemsContainer.innerHTML = '<div class="text-gray-500 text-center py-4 w-full">ยังไม่มีสินค้าที่บันทึกไว้</div>';
                return;
            }
            
            let html = '';
            quickItems.forEach(item => {
                html += `
                    <button type="button" onclick="modalQuickAddItem('${item.name}', ${item.price})" 
                            class="saved-item quick-add-btn bg-indigo-500 hover:bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-medium">
                        ${item.emoji} ${item.name} ${item.price}฿
                    </button>
                `;
            });
            
            savedItemsContainer.innerHTML = html;
        }



        // Show Modal Notification Function
        function showModalNotification(message, type = 'success') {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 z-[60] px-6 py-3 rounded-lg text-white font-medium transform transition-all duration-300 ${
                type === 'error' ? 'bg-red-500' : 'bg-green-500'
            }`;
            notification.textContent = message;
            
            // Add to page
            document.body.appendChild(notification);
            
            // Remove after 3 seconds
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Show Quick Add Tips Function
        function showQuickAddTips() {
            const tips = `
💡 เคล็ดลับการใช้งานเพิ่มสินค้าด่วน:

1️⃣ **กดปุ่มสินค้าด่วน**
   • กดปุ่มสีต่างๆ เพื่อเพิ่มสินค้าทันที
   • สินค้าจะถูกเพิ่มในรายการทันที
   • สินค้าจะถูกบันทึกอัตโนมัติ

2️⃣ **กรอกสินค้าใหม่**
   • พิมพ์ชื่อสินค้าและราคา
   • กด Enter หรือปุ่มเพิ่ม
   • สินค้าจะถูกเพิ่มในรายการทันที

3️⃣ **ป็อปอัพเพิ่มสินค้าด่วน**
   • กด "⚡ เพิ่มสินค้าด่วน" ในหน้าจอหลัก
   • กดปุ่มสินค้าด่วนเพื่อเพิ่มทันที
   • สินค้าจะปรากฏในรายการทันที

4️⃣ **Keyboard Shortcuts**
   • Ctrl+Enter: เพิ่มสินค้าใหม่
   • ESC: ปิดป็อปอัพ
   • Enter: เลื่อนไปช่องถัดไป

5️⃣ **การบันทึก**
   • สินค้าด่วนจะถูกบันทึกใน localStorage
   • จำกัด 10 รายการล่าสุด
   • ไม่ซ้ำสินค้าที่มีอยู่แล้ว

6️⃣ **วิธีใช้งาน**
   • กดปุ่ม "⚡ เพิ่มสินค้าด่วน" เพื่อเปิดป็อปอัพ
   • กดปุ่มสินค้าด่วนเพื่อเพิ่มทันที
   • สินค้าจะปรากฏในรายการทันที
   • กด "ปิด" หรือ ESC เพื่อปิดป็อปอัพ
            `;
            alert(tips);
        }

        // Export Data Function
        function exportData(type, month) {
            console.log('exportData called with:', type, month);
            const url = `/export-${type}/${month}`;
            console.log('Exporting data:', url);
            
            // Show loading message
            const button = event.target;
            const originalText = button.innerHTML;
            button.innerHTML = '⏳ กำลังส่งออก...';
            button.disabled = true;
            
            // Open download in new window
            const downloadWindow = window.open(url, '_blank');
            
            // Reset button after a short delay
            setTimeout(() => {
                button.innerHTML = originalText;
                button.disabled = false;
            }, 2000);
            
            // Show success message
            setTimeout(() => {
                alert(`ส่งออกข้อมูล ${type === 'all' ? 'ทั้งหมด' : type === 'income' ? 'รายรับ' : 'รายจ่าย'} สำหรับเดือน ${month} เรียบร้อยแล้ว!`);
            }, 1000);
        }

        // Export Year Data Function
        function exportYearData(year) {
            console.log('exportYearData called with:', year);
            const url = `/export-all/${year}`;
            console.log('Exporting year data:', url);
            
            // Show loading message
            const button = event.target;
            const originalText = button.innerHTML;
            button.innerHTML = '⏳ กำลังส่งออก...';
            button.disabled = true;
            
            // Open download in new window
            const downloadWindow = window.open(url, '_blank');
            
            // Reset button after a short delay
            setTimeout(() => {
                button.innerHTML = originalText;
                button.disabled = false;
            }, 2000);
            
            // Show success message
            setTimeout(() => {
                alert(`ส่งออกข้อมูลรายปี ${year} เรียบร้อยแล้ว!`);
            }, 1000);
        }



        // Show Yearly View Function
        function showYearlyView() {
            console.log('showYearlyView called');
            const currentYear = new Date().getFullYear();
            const selectedMonth = document.getElementById('month-select').value;
            const year = selectedMonth.split('-')[0];
            
            console.log('Current year:', currentYear, 'Selected month:', selectedMonth, 'Year:', year);
            
            // Redirect to yearly view or show year selection
            const choice = confirm(`ต้องการดูข้อมูลรายปี ${year} หรือไม่?\n\nกด "ตกลง" เพื่อดูข้อมูลรายปี\nกด "ยกเลิก" เพื่อเลือกปีอื่น`);
            
            if (choice) {
                console.log('Redirecting to yearly view:', `/income-expense/year/${year}`);
                // Redirect to yearly view (you can create this route)
                window.location.href = `/income-expense/year/${year}`;
            } else {
                // Show year selection
                const newYear = prompt('กรุณาใส่ปีที่ต้องการดู (เช่น 2025):', year);
                if (newYear && /^\d{4}$/.test(newYear)) {
                    console.log('Redirecting to custom year:', `/income-expense/year/${newYear}`);
                    window.location.href = `/income-expense/year/${newYear}`;
                }
            }
        }

        // Show Record Details Function
        function showRecordDetails(recordId) {
            // ซ่อนรายละเอียดอื่นๆ ที่เปิดอยู่
            const allDetails = document.querySelectorAll('[id^="details-"]');
            allDetails.forEach(detail => {
                detail.classList.add('hidden');
            });
            
            // แสดงรายละเอียดของรายการที่เลือก
            const detailsElement = document.getElementById(`details-${recordId}`);
            if (detailsElement) {
                detailsElement.classList.remove('hidden');
                
                // เลื่อนไปยังรายละเอียดที่แสดง
                detailsElement.scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'nearest' 
                });
            }
        }



        // Hide Record Details Function
        function hideRecordDetails(recordId) {
            const detailsElement = document.getElementById(`details-${recordId}`);
            if (detailsElement) {
                detailsElement.classList.add('hidden');
            }
        }

        // Close all details when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('tr') && !e.target.closest('.bg-white')) {
                const allDetails = document.querySelectorAll('[id^="details-"]');
                allDetails.forEach(detail => {
                    detail.classList.add('hidden');
                });
            }
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Set today's date as default
            const today = new Date().toISOString().split('T')[0];
            document.querySelector('input[name="date"]').value = today;
            
            // Initialize items display
            updateFormData();
            
            // Initialize quick items display
            updateQuickItemsDisplay();
            
            // Add event listeners for quick add inputs
            const quickNameInput = document.getElementById('quick-item-name');
            const quickPriceInput = document.getElementById('quick-item-price');
            
            if (quickNameInput) {
                quickNameInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        quickPriceInput.focus();
                    }
                });
            }
            
            if (quickPriceInput) {
                quickPriceInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        addQuickItem();
                    }
                });
            }
            
            // Auto refresh after form submission
            if (window.location.search.includes('success=true')) {
                setTimeout(() => {
                    window.location.href = window.location.pathname;
                }, 2000);
            }
            
            // Handle window resize for responsive design
            window.addEventListener('resize', function() {
                if (selectedItems.length > 0) {
                    updateItemsDisplay();
                }
            });
            
            // Add event listeners for desktop table rows
            document.addEventListener('click', function(e) {
                const tableRow = e.target.closest('tr[data-record-id]');
                if (tableRow && !e.target.closest('td:last-child')) {
                    const recordId = tableRow.getAttribute('data-record-id');
                    if (recordId) {
                        showRecordDetails(recordId);
                    }
                }
            });
            
            // Add event listeners for hide buttons
            document.addEventListener('click', function(e) {
                const hideButton = e.target.closest('[data-hide-record-id]');
                if (hideButton) {
                    const recordId = hideButton.getAttribute('data-hide-record-id');
                    if (recordId) {
                        hideRecordDetails(recordId);
                    }
                }
            });
            
            // Add keyboard shortcuts
            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey && e.key === 'Enter') {
                    addNewItem();
                }
                
                // Modal keyboard shortcuts
                const modal = document.getElementById('quick-add-modal');
                if (modal && !modal.classList.contains('hidden')) {
                    if (e.key === 'Escape') {
                        closeQuickAddModal();
                    }
                    if (e.ctrlKey && e.key === 'Enter') {
                        addModalQuickItem();
                    }
                }
            });
        });


    </script>
</body>
</html>