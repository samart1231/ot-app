<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</title>
    <script src="{{ url_for('static', filename='js/tailwind.min.js') }}"></script>
    <style>
        /* Custom styles for mobile responsiveness */
        @media (max-width: 768px) {
            .mobile-responsive {
                font-size: 14px;
            }
        }
        
        /* Animation for buttons */
        .btn-animate {
            transition: all 0.2s ease;
        }
        .btn-animate:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .btn-animate:active {
            transform: translateY(0);
        }
        
        /* Smooth transitions */
        .smooth-transition {
            transition: all 0.3s ease;
        }
        
        /* Table styles */
        .items-table {
            border-collapse: collapse;
            width: 100%;
        }
        
        .items-table th {
            background-color: #f9fafb;
            border: 1px solid #e5e7eb;
            padding: 8px 12px;
            text-align: left;
            font-size: 12px;
            font-weight: 600;
            color: #374151;
        }
        
        .items-table td {
            border: 1px solid #e5e7eb;
            padding: 8px 12px;
            vertical-align: middle;
        }
        
        .items-table tr:hover {
            background-color: #f9fafb;
        }
        
        .items-table .total-row {
            background-color: #f3f4f6;
            font-weight: 600;
        }
        
        .items-table .total-row td {
            border-top: 2px solid #d1d5db;
        }
        
        /* Mobile table styles */
        .mobile-table {
            font-size: 10px;
        }
        
        .mobile-table th {
            padding: 4px 6px;
            font-size: 10px;
            white-space: nowrap;
        }
        
        .mobile-table td {
            padding: 4px 6px;
            font-size: 10px;
        }
        
        .mobile-table input,
        .mobile-table select {
            font-size: 10px;
            padding: 2px 4px;
            min-width: 40px;
        }
        
        .mobile-table button {
            font-size: 9px;
            padding: 1px 2px;
        }
        
        .mobile-table .w-5 {
            width: 1.25rem;
            height: 1.25rem;
        }
        
        /* Ensure table fits on mobile without horizontal scroll */
        @media (max-width: 768px) {
            .mobile-table {
                table-layout: fixed;
                width: 100%;
            }
            
            .mobile-table th:nth-child(1) { width: 8%; }  /* # */
            .mobile-table th:nth-child(2) { width: 20%; } /* ‡∏ä‡∏∑‡πà‡∏≠ */
            .mobile-table th:nth-child(3) { width: 15%; } /* ‡πÅ‡∏ó‡πá‡∏Å */
            .mobile-table th:nth-child(4) { width: 18%; } /* ‡∏£‡∏≤‡∏Ñ‡∏≤ */
            .mobile-table th:nth-child(5) { width: 15%; } /* ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô */
            .mobile-table th:nth-child(6) { width: 12%; } /* ‡∏£‡∏ß‡∏° */
            .mobile-table th:nth-child(7) { width: 12%; } /* ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ */
        }
        
        /* Mobile responsive styles */
        @media (max-width: 768px) {
            .mobile-card {
                background: white;
                border-radius: 8px;
                padding: 12px;
                margin-bottom: 12px;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }
            
            .mobile-item-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 8px;
            }
            
            .mobile-item-number {
                background: #3b82f6;
                color: white;
                width: 24px;
                height: 24px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 12px;
                font-weight: bold;
            }
            
            .mobile-item-actions {
                display: flex;
                gap: 4px;
            }
            
            .mobile-item-field {
                margin-bottom: 8px;
            }
            
            .mobile-item-label {
                font-size: 11px;
                font-weight: 600;
                color: #6b7280;
                margin-bottom: 4px;
            }
            
            .mobile-item-input {
                width: 100%;
                border: 1px solid #d1d5db;
                border-radius: 4px;
                padding: 6px 8px;
                font-size: 14px;
            }
            
            .mobile-item-select {
                width: 100%;
                border: 1px solid #d1d5db;
                border-radius: 4px;
                padding: 6px 8px;
                font-size: 14px;
            }
            
            .mobile-controls {
                display: flex;
                gap: 4px;
                align-items: center;
            }
            
            .mobile-control-btn {
                background: #f3f4f6;
                border: 1px solid #d1d5db;
                border-radius: 4px;
                width: 24px;
                height: 24px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 12px;
                color: #6b7280;
            }
            
            .mobile-control-btn:hover {
                background: #e5e7eb;
            }
            
            .mobile-total {
                font-weight: 600;
                color: #059669;
                text-align: right;
            }
            
            .mobile-form-grid {
                display: grid;
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            .mobile-form-row {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 8px;
            }
            
            .mobile-form-full {
                grid-column: 1 / -1;
            }
            
            .mobile-button {
                width: 100%;
                padding: 12px;
                border-radius: 8px;
                font-weight: 600;
                font-size: 14px;
                border: none;
                cursor: pointer;
            }
            
            .mobile-button-primary {
                background: #3b82f6;
                color: white;
            }
            
            .mobile-button-secondary {
                background: #6b7280;
                color: white;
            }
            
            .mobile-button-success {
                background: #059669;
                color: white;
            }
            
            .mobile-button-danger {
                background: #dc2626;
                color: white;
            }
            
            .mobile-summary-cards {
                display: grid;
                grid-template-columns: 1fr;
                gap: 8px;
                margin-bottom: 16px;
            }
            
            .mobile-summary-card {
                padding: 12px;
                border-radius: 8px;
                text-align: center;
            }
            
            .mobile-summary-value {
                font-size: 18px;
                font-weight: bold;
                margin-bottom: 4px;
            }
            
            .mobile-summary-label {
                font-size: 12px;
                opacity: 0.8;
            }
            
            /* Mobile Items Display Optimization */
            .mobile-items-container {
                max-height: 60vh;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .mobile-item-card {
                transition: all 0.2s ease;
            }
            
            .mobile-item-card:focus-within {
                box-shadow: 0 0 0 2px #3b82f6;
            }
            
            .mobile-input-touch {
                min-height: 44px; /* iOS touch target minimum */
                font-size: 16px; /* Prevent zoom on iOS */
            }
            
            .mobile-button-touch {
                min-height: 44px;
                min-width: 44px;
                touch-action: manipulation;
            }
            
            /* Mobile table optimization */
            .mobile-table {
                font-size: 12px;
            }
            
            .mobile-table th,
            .mobile-table td {
                padding: 4px;
                vertical-align: middle;
            }
            
            .mobile-table input,
            .mobile-table select {
                font-size: 12px;
                padding: 2px 4px;
            }
            
            /* Desktop table optimization */
            .items-table {
                box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
                border-radius: 8px;
                overflow: hidden;
            }
            
            .items-table th {
                background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
                font-weight: 600;
                text-transform: uppercase;
                letter-spacing: 0.05em;
            }
            
            .items-table tr:hover {
                background-color: #f8fafc;
                transition: background-color 0.2s ease;
            }
            
            .items-table input:focus,
            .items-table select:focus {
                box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
                border-color: #3b82f6;
            }
            
            .items-table button {
                transition: all 0.2s ease;
            }
            
            .items-table button:hover {
                transform: translateY(-1px);
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 min-h-screen">
    <!-- Mobile Header -->
    <div class="lg:hidden fixed top-0 left-0 w-full bg-white shadow-lg z-50">
        <div class="flex items-center justify-between p-4">
            <h1 class="text-xl font-bold text-gray-800">üí∞ ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö-‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</h1>
            <button id="mobile-menu-btn" class="text-gray-600 hover:text-gray-800 focus:outline-none">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                </svg>
            </button>
        </div>
        
        <!-- Mobile Menu -->
        <div id="mobile-menu" class="hidden bg-white border-t">
            <nav class="py-2">
                <a href="/index" class="block px-4 py-3 text-gray-700 hover:bg-gray-100 border-b">üìÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÇ‡∏≠‡∏ó‡∏µ</a>
                <a href="/income-expense" class="block px-4 py-3 bg-green-100 text-green-700 font-medium border-b">üí∞ ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö/‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</a>
                <a href="/holidays" class="block px-4 py-3 text-gray-700 hover:bg-gray-100 border-b">üéâ ‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î</a>
                <a href="/import-csv" class="block px-4 py-3 text-gray-700 hover:bg-gray-100 border-b">üìä ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ CSV ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö/‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</a>
                <a href="/import-ot-csv" class="block px-4 py-3 text-gray-700 hover:bg-gray-100 border-b">‚è∞ ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ CSV ‡πÇ‡∏≠‡∏ó‡∏µ</a>
                <a href="/settings" class="block px-4 py-3 text-gray-700 hover:bg-gray-100 border-b">‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</a>
                <div class="px-4 py-3 border-b">
                    {% if session.user_picture %}
                        <div class="flex items-center gap-3">
                            <img src="{{ session.user_picture }}" alt="Profile" class="w-6 h-6 rounded-full">
                            <div>
                                <div class="text-sm font-medium text-gray-800">{{ session.user_name or session.user_email }}</div>
                                <div class="text-xs text-gray-500">{{ session.user_email }}</div>
                            </div>
                        </div>
                    {% else %}
                    <span class="text-sm text-gray-500">üë§ {{ session.user_email }}</span>
                    {% endif %}
                </div>
                <a href="/logout" class="block px-4 py-3 text-red-600 hover:bg-red-50">üö™ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</a>
            </nav>
        </div>
    </div>

    <!-- Desktop Sidebar -->
    <div class="hidden lg:block fixed top-0 left-0 w-64 h-full bg-white shadow-lg z-40">
        <div class="p-6">
            <h1 class="text-2xl font-bold text-gray-800 mb-8">üìä ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</h1>
            <nav class="space-y-2">
                <a href="/index" class="block px-4 py-3 text-gray-700 hover:bg-gray-100 rounded-lg smooth-transition">üìÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÇ‡∏≠‡∏ó‡∏µ</a>
                <a href="/income-expense" class="block px-4 py-3 bg-green-100 text-green-700 font-medium rounded-lg">üí∞ ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö/‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</a>
                <a href="/holidays" class="block px-4 py-3 text-gray-700 hover:bg-gray-100 rounded-lg smooth-transition">üéâ ‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î</a>
                <a href="/import-csv" class="block px-4 py-3 text-gray-700 hover:bg-gray-100 rounded-lg smooth-transition">üìä ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ CSV ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö/‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</a>
                <a href="/import-ot-csv" class="block px-4 py-3 text-gray-700 hover:bg-gray-100 rounded-lg smooth-transition">‚è∞ ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ CSV ‡πÇ‡∏≠‡∏ó‡∏µ</a>
                <a href="/settings" class="block px-4 py-3 text-gray-700 hover:bg-gray-100 rounded-lg smooth-transition">‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</a>
            </nav>
            <div class="mt-8 pt-6 border-t">
                <div class="px-4 py-3">
                    {% if session.user_picture %}
                        <div class="flex items-center gap-3 mb-3">
                            <img src="{{ session.user_picture }}" alt="Profile" class="w-8 h-8 rounded-full">
                            <div>
                                <div class="text-sm font-medium text-gray-800">{{ session.user_name or session.user_email }}</div>
                                <div class="text-xs text-gray-500">{{ session.user_email }}</div>
                            </div>
                        </div>
                    {% else %}
                <div class="px-4 py-2">
                    <span class="text-sm text-gray-500">üë§ {{ session.user_email }}</span>
                        </div>
                    {% endif %}
                </div>
                <a href="/logout" class="block px-4 py-3 text-red-600 hover:bg-red-50 rounded-lg smooth-transition">üö™ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</a>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="lg:ml-64 pt-20 lg:pt-6 p-4 lg:p-6 min-h-screen">
        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="mb-4 p-4 rounded-lg {% if category == 'success' %}bg-green-100 text-green-700 border border-green-200{% elif category == 'error' %}bg-red-100 text-red-700 border border-red-200{% else %}bg-blue-100 text-blue-700 border border-blue-200{% endif %}">
                        <div class="flex items-center">
                            <span class="mr-2">
                                {% if category == 'success' %}‚úÖ{% elif category == 'error' %}‚ùå{% else %}‚ÑπÔ∏è{% endif %}
                            </span>
                            {{ message }}
                        </div>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <!-- Page Title -->
        <div class="mb-6">
            <h1 class="text-2xl lg:text-3xl font-bold text-center lg:text-left">üìí ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö - ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</h1>
        </div>

        <!-- Add Transaction Form -->
        <div class="bg-white p-4 lg:p-6 rounded-lg shadow-md mb-6">
            <form id="transaction-form" method="POST" class="space-y-4">
                <!-- Date and Transaction Type -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                    <div>
                        <label class="block font-semibold mb-2">üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                        <input type="date" name="date" required 
                               class="w-full border rounded-lg p-3 focus:ring-2 focus:ring-blue-400 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block font-semibold mb-2">üìä ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</label>
                        <select id="transaction-type" name="transaction_type" required 
                                class="w-full border rounded-lg p-3 focus:ring-2 focus:ring-blue-400 focus:border-transparent">
                            <option value="">--‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö/‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢--</option>
                            <option value="expense">üí∏ ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</option>
                            <option value="income">üí∞ ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</option>
                        </select>
                    </div>
                </div>

                <!-- Category Section -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                    <div>
                        <label class="block font-semibold mb-2">üìã ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏´‡∏•‡∏±‡∏Å</label>
                        <div class="flex gap-2">
                            <select id="main-category" name="main_category" required 
                                    class="flex-1 border rounded-lg p-3 focus:ring-2 focus:ring-blue-400 focus:border-transparent">
                                <option value="">--‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏´‡∏•‡∏±‡∏Å--</option>
                            </select>
                            <button type="button" id="add-main-category-btn"
                                    class="btn-animate bg-purple-500 hover:bg-purple-600 text-white px-3 py-2 rounded-lg text-sm">
                                ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°
                            </button>
                        </div>
                        <!-- Custom main category input -->
                        <div id="custom-main-category-input" class="mt-2 hidden">
                            <input type="text" id="new-main-category" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏´‡∏•‡∏±‡∏Å‡πÉ‡∏´‡∏°‡πà..."
                                   class="w-full border border-purple-300 rounded-lg p-2 focus:ring-2 focus:ring-purple-400">
                            <div class="text-xs text-purple-600 mt-1">üí° ‡∏Å‡∏î Enter ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏´‡∏•‡∏±‡∏Å‡πÉ‡∏´‡∏°‡πà</div>
                        </div>
                    </div>

                    <div>
                        <label class="block font-semibold mb-2">üìã ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏¢‡πà‡∏≠‡∏¢</label>
                        <div class="flex gap-2">
                            <select id="sub-category" name="sub_category" required 
                                    class="flex-1 border rounded-lg p-3 focus:ring-2 focus:ring-blue-400 focus:border-transparent">
                                <option value="">--‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏¢‡πà‡∏≠‡∏¢--</option>
                            </select>
                            <button type="button" id="add-sub-category-btn"
                                    class="btn-animate bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded-lg text-sm">
                                ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°
                            </button>
                        </div>
                        <!-- Custom sub category input -->
                        <div id="custom-sub-category-input" class="mt-2 hidden">
                            <input type="text" id="new-sub-category" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏¢‡πà‡∏≠‡∏¢‡πÉ‡∏´‡∏°‡πà..."
                                   class="w-full border border-blue-300 rounded-lg p-2 focus:ring-2 focus:ring-blue-400">
                            <div class="text-xs text-blue-600 mt-1">üí° ‡∏Å‡∏î Enter ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏¢‡πà‡∏≠‡∏¢‡πÉ‡∏´‡∏°‡πà</div>
                        </div>
                    </div>
                </div>

                <!-- Combined Category Display -->
                <div class="bg-gray-50 p-3 rounded-lg border">
                    <label class="block font-semibold mb-2">üìã ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</label>
                    <div class="flex items-center gap-2">
                        <span class="text-sm text-gray-600">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏´‡∏•‡∏±‡∏Å:</span>
                        <span id="selected-main-category" class="font-medium text-purple-600">-</span>
                        <span class="text-sm text-gray-600">|</span>
                        <span class="text-sm text-gray-600">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏¢‡πà‡∏≠‡∏¢:</span>
                        <span id="selected-sub-category" class="font-medium text-blue-600">-</span>
                    </div>
                    <input type="hidden" id="combined-category" name="category" value="">
                </div>

                <!-- Income Amount (for income transactions) -->
                <div id="income-amount-section" class="hidden">
                    <label class="block font-semibold mb-2">üí∞ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</label>
                    <input type="number" id="income-amount" name="income_amount" step="0.01" placeholder="0.00"
                           class="w-full border rounded-lg p-3 focus:ring-2 focus:ring-blue-400 focus:border-transparent">
                </div>

                <!-- Items Section (for expense transactions) -->
                <div id="items-section" class="hidden">
                    <label class="block font-semibold mb-2">üì¶ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
                    <div class="border rounded-lg p-4 bg-gray-50">
                        <!-- Selected Items Display -->
                        <div id="selected-items" class="mb-4 mobile-items-container">
                            <div class="text-gray-500 text-center py-4">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div>
                        </div>

                        <!-- Add New Item - Mobile Optimized -->
                        <div class="border-t pt-4">
                            <div class="space-y-4">
                                <!-- Item Name -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">üìù ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
                                    <input type="text" id="item-name" placeholder="‡πÄ‡∏ä‡πà‡∏ô: ‡∏Ç‡∏ô‡∏°‡∏õ‡∏±‡∏á, ‡∏ô‡∏°, ‡∏ú‡∏±‡∏Å‡∏Å‡∏≤‡∏î"
                                           class="w-full border border-gray-300 rounded-lg p-3 text-base focus:ring-2 focus:ring-blue-500 focus:border-transparent mobile-input-touch transition-all duration-200 hover:border-gray-400">
                                </div>
                                
                                <!-- Price and Quantity Row -->
                                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">üí∞ ‡∏£‡∏≤‡∏Ñ‡∏≤ (‡∏ö‡∏≤‡∏ó)</label>
                                        <div class="relative">
                                            <input type="number" id="item-price" step="0.01" placeholder="0.00"
                                                   class="w-full border border-gray-300 rounded-lg p-3 text-base focus:ring-2 focus:ring-blue-500 focus:border-transparent mobile-input-touch transition-all duration-200 hover:border-gray-400">
                                            <div class="absolute inset-y-0 right-0 flex items-center pr-3">
                                                <span class="text-gray-500 text-sm">‡∏ø</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">üìä ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</label>
                                        <input type="number" id="item-quantity" min="1" value="1"
                                               class="w-full border border-gray-300 rounded-lg p-3 text-base focus:ring-2 focus:ring-blue-500 focus:border-transparent mobile-input-touch transition-all duration-200 hover:border-gray-400">
                                    </div>
                                </div>
                                
                                <!-- Tag Selection -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">üè∑Ô∏è ‡πÅ‡∏ó‡πá‡∏Å</label>
                                    <div class="flex flex-col lg:flex-row gap-3">
                                        <select id="item-tag" class="flex-1 border border-gray-300 rounded-lg p-3 text-base focus:ring-2 focus:ring-blue-500 focus:border-transparent mobile-input-touch transition-all duration-200 hover:border-gray-400" onchange="updateTagEmoji()">
                                            <option value="">--‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ó‡πá‡∏Å--</option>
                                            <option value="‡∏≠‡∏≤‡∏´‡∏≤‡∏£">üçΩÔ∏è ‡∏≠‡∏≤‡∏´‡∏≤‡∏£</option>
                                            <option value="‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°">ü•§ ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°</option>
                                            <option value="‡∏Ç‡∏≠‡∏á‡πÉ‡∏ä‡πâ">üõçÔ∏è ‡∏Ç‡∏≠‡∏á‡πÉ‡∏ä‡πâ</option>
                                            <option value="‡∏¢‡∏≤">üíä ‡∏¢‡∏≤</option>
                                            <option value="‡∏Ç‡∏ô‡∏°">üç™ ‡∏Ç‡∏ô‡∏°</option>
                                            <option value="‡∏ú‡∏•‡πÑ‡∏°‡πâ">üçé ‡∏ú‡∏•‡πÑ‡∏°‡πâ</option>
                                            <option value="‡∏ú‡∏±‡∏Å">ü•¨ ‡∏ú‡∏±‡∏Å</option>
                                            <option value="‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏™‡∏±‡∏ï‡∏ß‡πå">ü•© ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏™‡∏±‡∏ï‡∏ß‡πå</option>
                                            <option value="‡∏ô‡∏°">ü•õ ‡∏ô‡∏°</option>
                                            <option value="‡∏Ç‡∏ô‡∏°‡∏õ‡∏±‡∏á">üçû ‡∏Ç‡∏ô‡∏°‡∏õ‡∏±‡∏á</option>
                                        </select>
                                        <div class="flex gap-2">
                                            <button type="button" id="emoji-picker-btn"
                                                    class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-3 rounded-lg text-lg mobile-button-touch transition-all duration-200 hover:shadow-lg" onclick="showEmojiPicker()">
                                                üòä
                                            </button>
                                            <button type="button" id="add-tag-btn"
                                                    class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-3 rounded-lg text-lg mobile-button-touch transition-all duration-200 hover:shadow-lg">
                                                ‚ûï
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Emoji Picker Modal -->
                                <div id="emoji-picker-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
                                    <div class="bg-white rounded-lg p-6 max-w-sm w-full max-h-96 overflow-y-auto">
                                        <div class="flex justify-between items-center mb-4">
                                            <h3 class="text-lg font-semibold">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏¥‡πÇ‡∏°‡∏à‡∏¥</h3>
                                            <button onclick="closeEmojiPicker()" class="text-gray-500 hover:text-gray-700 text-xl">
                                                ‚úï
                                            </button>
                                        </div>
                                        <div id="emoji-grid" class="grid grid-cols-8 gap-3">
                                            <!-- Emojis will be populated here -->
                                        </div>
                                        <div class="mt-4 text-center">
                                            <button onclick="closeEmojiPicker()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg">
                                                ‡∏õ‡∏¥‡∏î
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Add Item Button -->
                                <div>
                                    <button type="button" id="add-item-btn"
                                            class="w-full bg-green-500 hover:bg-green-600 text-white py-4 px-6 rounded-lg font-semibold text-lg mobile-button-touch transition-all duration-200 hover:shadow-lg transform hover:scale-105">
                                        ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Custom Tag Input -->
                            <div id="custom-tag-input" class="mt-2 hidden">
                                <div class="flex gap-2">
                                    <input type="text" id="new-tag" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡πÅ‡∏ó‡πá‡∏Å‡πÉ‡∏´‡∏°‡πà..."
                                           class="flex-1 border border-purple-300 rounded-lg p-2 focus:ring-2 focus:ring-purple-400">
                                    <button type="button" onclick="addCustomTag()"
                                            class="btn-animate bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg">
                                        ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ó‡πá‡∏Å
                                    </button>
                                    <button type="button" onclick="cancelAddTag()"
                                            class="btn-animate bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg">
                                        ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                                    </button>
                                </div>
                                <div class="text-xs text-purple-600 mt-1">üí° ‡∏Å‡∏î Enter ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ó‡πá‡∏Å‡πÉ‡∏´‡∏°‡πà</div>
                            </div>
                        </div>

                        <!-- Total Display -->
                        <div class="mt-4 pt-4 border-t">
                            <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-4">
                                <div class="flex flex-wrap gap-2">
                                    <span class="font-semibold text-gray-700">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£: <span id="total-items" class="text-blue-600">0</span></span>
                                    <button type="button" onclick="clearAllItems()" 
                                            class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm font-semibold transition-all duration-200 hover:shadow-lg">
                                        üóëÔ∏è ‡∏•‡πâ‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                                    </button>
                                    <button type="button" onclick="showItemsSummary()" 
                                            class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-semibold transition-all duration-200 hover:shadow-lg">
                                        üìã ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                                    </button>
                                    <button type="button" onclick="showTagFilter()" 
                                            class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg text-sm font-semibold transition-all duration-200 hover:shadow-lg">
                                        üè∑Ô∏è ‡∏Å‡∏£‡∏≠‡∏á‡πÅ‡∏ó‡πá‡∏Å
                                    </button>
                                </div>
                                <div class="bg-green-50 border border-green-200 rounded-lg px-6 py-3">
                                    <span class="font-bold text-lg text-green-800">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°: <span id="total-amount" class="text-green-600">0.00</span> ‡∏ö‡∏≤‡∏ó</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Vendor Section (for expense transactions) -->
                <div id="vendor-section" class="hidden">
                    <label class="block font-semibold mb-2">üè™ ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</label>
                    <div class="flex gap-2">
                        <select id="vendor-select" name="vendor" 
                                class="flex-1 border rounded-lg p-3 focus:ring-2 focus:ring-blue-400 focus:border-transparent">
                            <option value="">--‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤--</option>
                            <option value="‡∏£‡πâ‡∏≤‡∏ô‡∏¢‡∏≤‡∏¢‡∏à‡πà‡∏≠‡∏¢">‡∏£‡πâ‡∏≤‡∏ô‡∏¢‡∏≤‡∏¢‡∏à‡πà‡∏≠‡∏¢</option>
                            <option value="‡∏£‡πâ‡∏≤‡∏ô‡∏ú‡∏±‡∏Å">‡∏£‡πâ‡∏≤‡∏ô‡∏ú‡∏±‡∏Å</option>
                            <option value="‡πÄ‡∏à‡πâ‡∏ô‡∏±‡∏ô">‡πÄ‡∏à‡πâ‡∏ô‡∏±‡∏ô</option>
                            <option value="7-Eleven">7-Eleven</option>
                            <option value="‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î">‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</option>
<option value="none">‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</option>
                        </select>
                        <button type="button" id="add-vendor-btn"
                                class="btn-animate bg-green-500 hover:bg-green-600 text-white px-3 py-2 rounded-lg text-sm">
                            ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°
                        </button>
                    </div>
                    <!-- Custom vendor input -->
                    <div id="custom-vendor-input" class="mt-2 hidden">
                        <input type="text" id="new-vendor" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà..."
                               class="w-full border border-green-300 rounded-lg p-2 focus:ring-2 focus:ring-green-400">
                        <div class="text-xs text-green-600 mt-1">üí° ‡∏Å‡∏î Enter ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà</div>
                    </div>
                </div>

                <!-- Hidden inputs for form submission -->
                <input type="hidden" id="items-data" name="items_data">
                <input type="hidden" id="calculated-total" name="amount">
                <input type="hidden" id="description" name="description">

                <!-- Submit Button -->
                <div class="flex justify-center lg:justify-end pt-4">
                    <button type="submit" 
                            class="btn-animate bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white px-8 py-3 rounded-full font-semibold shadow-lg">
                        <span class="text-xl mr-2">üíæ</span>
                        ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                    </button>
                </div>
            </form>
        </div>

        <!-- Month Selection and Export -->
        <div class="bg-white p-4 lg:p-6 rounded-lg shadow-md mb-6">
            <div class="p-4 lg:p-6 border-b">
                <h2 class="text-lg lg:text-xl font-semibold text-gray-800 mb-2">üìÖ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏π</h2>
                <p class="text-sm text-gray-600">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö-‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</p>
            </div>
            <div class="p-4 lg:p-6">
                <div class="flex flex-col lg:flex-row items-start lg:items-center gap-4 mb-6">
                    <div class="flex items-center gap-3">
                        <label class="font-semibold text-gray-700">üìÖ ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô:</label>
                        <select id="month-select" class="border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white" onchange="changeMonth(this.value)">
                            {% for month in available_months %}
                                <option value="{{ month.month }}" {% if month.month == selected_month %}selected{% endif %}>
                                    {{ month.display }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="bg-gray-50 border border-gray-200 rounded-lg px-4 py-2">
                        <div class="text-sm text-gray-700">
                            <span class="font-medium">üìä ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</span> ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö-‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô 
                            <span class="font-bold text-gray-900">{{ selected_month.split('-')[1] }}/{{ selected_month.split('-')[0] }}</span>
                            <span class="text-gray-600">({{ total_records }} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)</span>
                        </div>
                    </div>
                </div>
            
            <!-- Export Buttons -->
            <div class="border-t pt-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">üìä ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3>
                <div class="flex flex-wrap gap-2">
                    <button onclick="exportData('all', '{{ selected_month }}')" 
                            class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium">
                        üìÑ ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                    </button>
                    <button onclick="exportData('income', '{{ selected_month }}')" 
                            class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-medium">
                        üí∞ ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö
                    </button>
                    <button onclick="exportData('expense', '{{ selected_month }}')" 
                            class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm font-medium">
                        üí∏ ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢
                    </button>
                    <button onclick="showMonthlySummary()" 
                            class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg text-sm font-medium">
                        üìã ‡∏™‡∏£‡∏∏‡∏õ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
                    </button>
                    <button onclick="showYearlyView()" 
                            class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-lg text-sm font-medium">
                        üìÖ ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏õ‡∏µ
                    </button>
                    <button onclick="exportYearData('{{ selected_month.split('-')[0] }}')" 
                            class="bg-indigo-500 hover:bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-medium">
                        üìä ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏õ‡∏µ
                    </button>
                </div>
            </div>
        </div>

        <!-- Summary Cards -->
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-4 mb-6">
            <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200">
                <div class="flex items-center justify-between mb-2">
                    <div class="text-green-600 text-xl">üí∞</div>
                    <div class="text-gray-600 text-sm">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</div>
                </div>
                <div class="text-green-700 font-bold text-xl mb-1">{{ "%.2f"|format(monthly_total_income) }}</div>
                <div class="text-gray-500 text-sm">‡∏ö‡∏≤‡∏ó</div>
            </div>
            <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200">
                <div class="flex items-center justify-between mb-2">
                    <div class="text-red-600 text-xl">üí∏</div>
                    <div class="text-gray-600 text-sm">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</div>
                </div>
                <div class="text-red-700 font-bold text-xl mb-1">{{ "%.2f"|format(monthly_total_expense) }}</div>
                <div class="text-gray-500 text-sm">‡∏ö‡∏≤‡∏ó</div>
            </div>
            <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200">
                <div class="flex items-center justify-between mb-2">
                    <div class="text-blue-600 text-xl">üìä</div>
                    <div class="text-gray-600 text-sm">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</div>
                </div>
                <div class="text-blue-700 font-bold text-xl mb-1">{{ "%.2f"|format(monthly_total_income - monthly_total_expense) }}</div>
                <div class="text-gray-500 text-sm">‡∏ö‡∏≤‡∏ó</div>
            </div>
            <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200">
                <div class="flex items-center justify-between mb-2">
                    <div class="text-gray-600 text-xl">üìù</div>
                    <div class="text-gray-600 text-sm">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
                </div>
                <div class="text-gray-700 font-bold text-xl mb-1">{{ total_records }}</div>
                <div class="text-gray-500 text-sm">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
            </div>
        </div>

        <!-- Records Table -->
        <div class="bg-white rounded-lg shadow-md overflow-hidden">
            <div class="p-4 lg:p-6 border-b">
                <h2 class="text-lg lg:text-xl font-semibold text-gray-800">üìä ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h2>
                <p class="text-sm text-gray-600 mt-1">‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö-‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</p>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full border-collapse">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700 border-b border-gray-200">üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700 border-b border-gray-200">üìù ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th>
                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700 border-b border-gray-200">üí∞ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô (‡∏ö‡∏≤‡∏ó)</th>
                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700 border-b border-gray-200">üè™ ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700 border-b border-gray-200">üè∑Ô∏è ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700 border-b border-gray-200">‚öôÔ∏è ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                        </tr>
                    </thead>
                    <tbody id="records-tbody">
                        {% if records %}
                            {% for record in records %}
                                <tr class="border-b border-gray-100 hover:bg-gray-50 transition-colors duration-200">
                                    <td class="px-4 py-4 text-sm text-gray-700 font-medium">
                                        <div class="flex items-center gap-2">
                                            <span class="text-gray-400">üìÖ</span>
                                            {{ record.date }}
                                        </div>
                                    </td>
                                    <td class="px-4 py-4 text-sm text-gray-800">
                                        <div class="max-w-xs truncate" title="{{ record.description }}">
                                            {{ record.description }}
                                        </div>
                                    </td>
                                    <td class="px-4 py-4 text-sm font-bold {% if record.category == 'income' %}text-green-600{% else %}text-red-600{% endif %}">
                                        <div class="flex items-center gap-1">
                                            <span>{% if record.category == 'income' %}üí∞{% else %}üí∏{% endif %}</span>
                                            {{ "%.2f"|format(record.amount) }}
                                        </div>
                                    </td>
                                    <td class="px-4 py-4 text-sm text-gray-600">
                                        <div class="flex items-center gap-1">
                                            <span class="text-gray-400">üè™</span>
                                            {{ record.vendor or '-' }}
                                        </div>
                                    </td>
                                    <td class="px-4 py-4 text-sm">
                                        <span class="px-3 py-1 rounded-full text-xs font-medium {% if record.category == 'income' %}bg-green-100 text-green-700 border border-green-200{% else %}bg-red-100 text-red-700 border border-red-200{% endif %}">
                                            {% if record.category == 'income' %}üí∞ ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö{% else %}üí∏ ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢{% endif %}
                                        </span>
                                    </td>
                                    <td class="px-4 py-4 text-sm">
                                        <div class="flex gap-2">
                                            <a href="/edit-income-expense/{{ record.id }}" 
                                               class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded-lg text-xs font-medium transition-all duration-200 hover:shadow-md">
                                                ‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                                            </a>
                                            <form method="POST" action="/delete-income-expense/{{ record.id }}" 
                                                  class="inline" onsubmit="return confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')">
                                                <button type="submit" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded-lg text-xs font-medium transition-all duration-200 hover:shadow-md">
                                                    üóëÔ∏è ‡∏•‡∏ö
                                                </button>
                                            </form>
                                        </div>
                                    </td>
                                </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="6" class="px-4 py-12 text-center">
                                    <div class="flex flex-col items-center justify-center">
                                        <div class="text-6xl mb-4 text-gray-300">üì≠</div>
                                        <div class="text-lg font-medium text-gray-500 mb-2">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</div>
                                        <div class="text-sm text-gray-400">‡∏•‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏≠‡∏∑‡πà‡∏ô</div>
                                        <div class="mt-4 flex gap-2">
                                            <button onclick="document.getElementById('transaction-type').focus()" 
                                                    class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-all duration-200">
                                                ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà
                                            </button>
                                            <button onclick="document.getElementById('month-select').focus()" 
                                                    class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-all duration-200">
                                                üìÖ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏≠‡∏∑‡πà‡∏ô
                                            </button>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
            
            <!-- Table Footer -->
            {% if records %}
            <div class="p-4 lg:p-6 border-t bg-gray-50">
                <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-4">
                    <div class="text-sm text-gray-600">
                        ‡πÅ‡∏™‡∏î‡∏á {{ records|length }} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡∏à‡∏≤‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î {{ total_records }} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                    </div>
                    <div class="flex gap-2">
                        <button onclick="exportData('all', '{{ selected_month }}')" 
                                class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium">
                            üìÑ ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                        </button>
                        <button onclick="showMonthlySummary()" 
                                class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg text-sm font-medium">
                            üìã ‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                        </button>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <script>
        // Application State
        let selectedItems = [];
        let itemCounter = 0;
        let availableTags = [
            '‡∏≠‡∏≤‡∏´‡∏≤‡∏£', '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°', '‡∏Ç‡∏≠‡∏á‡πÉ‡∏ä‡πâ', '‡∏¢‡∏≤', '‡∏Ç‡∏ô‡∏°', 
            '‡∏ú‡∏•‡πÑ‡∏°‡πâ', '‡∏ú‡∏±‡∏Å', '‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏™‡∏±‡∏ï‡∏ß‡πå', '‡∏ô‡∏°', '‡∏Ç‡∏ô‡∏°‡∏õ‡∏±‡∏á'
        ];
        
        // Emoji data
        const emojiData = {
            '‡∏≠‡∏≤‡∏´‡∏≤‡∏£': ['üçΩÔ∏è', 'üçú', 'üçï', 'üçî', 'üçü', 'üåÆ', 'üåØ', 'ü•™', 'üç±', 'üçõ'],
            '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°': ['ü•§', '‚òï', 'üßÉ', 'üç∫', 'üç∑', 'ü•õ', 'üßã', 'üçπ', 'ü•§', 'üíß'],
            '‡∏Ç‡∏≠‡∏á‡πÉ‡∏ä‡πâ': ['üõçÔ∏è', 'üß¥', 'üßª', 'üßΩ', 'üëï', 'üëñ', 'üëü', 'üëú', 'üíÑ', 'ü™û'],
            '‡∏¢‡∏≤': ['üíä', 'üè•', 'ü©∫', 'ü©π', 'ü©ª', 'üíâ', 'ü©∏', 'üß¨', 'üî¨', 'üìã'],
            '‡∏Ç‡∏ô‡∏°': ['üç™', 'üç©', 'üç∞', 'üßÅ', 'üç¶', 'üç®', 'üç≠', 'üç´', 'üç¨', 'üç°'],
            '‡∏ú‡∏•‡πÑ‡∏°‡πâ': ['üçé', 'üçå', 'üçä', 'üçá', 'üçì', 'üçë', 'ü•≠', 'üçç', 'ü••', 'ü•ù'],
            '‡∏ú‡∏±‡∏Å': ['ü•¨', 'ü•ï', 'ü•¶', 'ü•í', 'üçÖ', 'üåΩ', 'ü•ë', 'ü•í', 'üßÖ', 'üßÑ'],
            '‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏™‡∏±‡∏ï‡∏ß‡πå': ['ü•©', 'üçó', 'üçñ', 'ü•ì', 'üçñ', 'üêü', 'ü¶ê', 'ü¶ë', 'ü¶û', 'ü¶Ä'],
            '‡∏ô‡∏°': ['ü•õ', 'üßÄ', 'üç¶', 'üç®', 'ü•õ', 'üßà', 'ü•õ', 'üçº', 'ü•õ', 'ü•õ'],
            '‡∏Ç‡∏ô‡∏°‡∏õ‡∏±‡∏á': ['üçû', 'ü•ñ', 'ü•®', 'ü•Ø', 'ü•ê', 'ü•™', 'üçû', 'ü•ñ', 'ü•®', 'ü•Ø']
        };
        
        // Default emoji for each tag
        const defaultEmojis = {
            '‡∏≠‡∏≤‡∏´‡∏≤‡∏£': 'üçΩÔ∏è',
            '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°': 'ü•§',
            '‡∏Ç‡∏≠‡∏á‡πÉ‡∏ä‡πâ': 'üõçÔ∏è',
            '‡∏¢‡∏≤': 'üíä',
            '‡∏Ç‡∏ô‡∏°': 'üç™',
            '‡∏ú‡∏•‡πÑ‡∏°‡πâ': 'üçé',
            '‡∏ú‡∏±‡∏Å': 'ü•¨',
            '‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏™‡∏±‡∏ï‡∏ß‡πå': 'ü•©',
            '‡∏ô‡∏°': 'ü•õ',
            '‡∏Ç‡∏ô‡∏°‡∏õ‡∏±‡∏á': 'üçû'
        };
        
        // Category data structure
        const categoryData = {
            income: {
                'üí∞ ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô': ['üíº ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥', 'üéØ ‡πÇ‡∏ö‡∏ô‡∏±‡∏™', 'üìà ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°'],
                'üíº ‡∏á‡∏≤‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©': ['üñ•Ô∏è ‡∏á‡∏≤‡∏ô‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå', '‚úçÔ∏è ‡∏á‡∏≤‡∏ô‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô', 'üé® ‡∏á‡∏≤‡∏ô‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö'],
                'üéÅ ‡∏Ç‡∏≠‡∏á‡∏Ç‡∏ß‡∏±‡∏ç': ['üéÇ ‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î', 'üíù ‡∏ß‡∏±‡∏ô‡∏Ñ‡∏£‡∏¥‡∏™‡∏ï‡πå‡∏°‡∏≤‡∏™', 'üéä ‡∏ß‡∏±‡∏ô‡∏õ‡∏µ‡πÉ‡∏´‡∏°‡πà'],
                'üè¶ ‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢': ['üí∞ ‡πÄ‡∏á‡∏¥‡∏ô‡∏ù‡∏≤‡∏Å', 'üìä ‡πÄ‡∏á‡∏¥‡∏ô‡∏•‡∏á‡∏ó‡∏∏‡∏ô', 'üè† ‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏π‡πâ'],
                'üìà ‡πÄ‡∏á‡∏¥‡∏ô‡∏•‡∏á‡∏ó‡∏∏‡∏ô': ['üìä ‡∏´‡∏∏‡πâ‡∏ô', 'üè† ‡∏≠‡∏™‡∏±‡∏á‡∏´‡∏≤‡∏£‡∏¥‡∏°‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå', 'üí∞ ‡∏Ñ‡∏£‡∏¥‡∏õ‡πÇ‡∏ï'],
                'üîÑ ‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡∏∑‡∏ô': ['üõí ‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡∏∑‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', 'üí≥ ‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡∏∑‡∏ô‡∏ö‡∏±‡∏ï‡∏£', 'üè¶ ‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡∏∑‡∏ô‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£']
            },
            expense: {
                'üçΩÔ∏è ‡∏≠‡∏≤‡∏´‡∏≤‡∏£': ['üçö ‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏´‡∏•‡∏±‡∏Å', 'üçú ‡∏Å‡πã‡∏ß‡∏¢‡πÄ‡∏ï‡∏µ‡πã‡∏¢‡∏ß', 'üçï ‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ü‡∏≤‡∏™‡∏ï‡πå‡∏ü‡∏π‡πâ‡∏î', '‚òï ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°'],
                'üõçÔ∏è ‡∏Ç‡∏≠‡∏á‡πÉ‡∏ä‡πâ': ['üß¥ ‡∏™‡∏ö‡∏π‡πà/‡πÅ‡∏ä‡∏°‡∏û‡∏π', 'üßª ‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡∏ä‡∏≥‡∏£‡∏∞', 'üßΩ ‡∏Ç‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏ö‡πâ‡∏≤‡∏ô', 'üëï ‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏ú‡πâ‡∏≤'],
                'ü•§ ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°': ['‚òï ‡∏Å‡∏≤‡πÅ‡∏ü', 'ü•§ ‡∏ô‡πâ‡∏≥‡∏≠‡∏±‡∏î‡∏•‡∏°', 'üßÉ ‡∏ô‡πâ‡∏≥‡∏ú‡∏•‡πÑ‡∏°‡πâ', 'üç∫ ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°‡πÅ‡∏≠‡∏•‡∏Å‡∏≠‡∏Æ‡∏≠‡∏•‡πå'],
                'üöó ‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á': ['‚õΩ ‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô', 'üöå ‡∏£‡∏ñ‡πÄ‡∏°‡∏•‡πå', 'üöï ‡πÅ‡∏ó‡πá‡∏Å‡∏ã‡∏µ‡πà', 'üöá ‡∏£‡∏ñ‡πÑ‡∏ü‡∏ü‡πâ‡∏≤'],
                'üíä ‡∏¢‡∏≤': ['üíä ‡∏¢‡∏≤‡∏£‡∏±‡∏Å‡∏©‡∏≤‡πÇ‡∏£‡∏Ñ', 'üíä ‡∏¢‡∏≤‡πÄ‡∏™‡∏£‡∏¥‡∏°', 'üè• ‡∏Ñ‡πà‡∏≤‡∏´‡∏°‡∏≠', 'üíä ‡∏¢‡∏≤‡πÅ‡∏Å‡πâ‡∏õ‡∏ß‡∏î'],
                'üéÆ ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ö‡∏±‡∏ô‡πÄ‡∏ó‡∏¥‡∏á': ['üé¨ ‡∏î‡∏π‡∏´‡∏ô‡∏±‡∏á', 'üéÆ ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏Å‡∏°', 'üéµ ‡∏ü‡∏±‡∏á‡πÄ‡∏û‡∏•‡∏á', 'üìö ‡∏≠‡πà‡∏≤‡∏ô‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠']
            }
        };
        
        // DOM Elements
        const mobileMenuBtn = document.getElementById('mobile-menu-btn');
        const mobileMenu = document.getElementById('mobile-menu');
        const transactionTypeSelect = document.getElementById('transaction-type');
        const mainCategorySelect = document.getElementById('main-category');
        const subCategorySelect = document.getElementById('sub-category');
        const incomeAmountSection = document.getElementById('income-amount-section');
        const itemsSection = document.getElementById('items-section');
        const vendorSection = document.getElementById('vendor-section');
        const selectedItemsDiv = document.getElementById('selected-items');
        const totalItemsSpan = document.getElementById('total-items');
        const totalAmountSpan = document.getElementById('total-amount');

        // Mobile Menu Toggle
        mobileMenuBtn.addEventListener('click', () => {
            mobileMenu.classList.toggle('hidden');
        });

        // Close mobile menu when clicking outside
        document.addEventListener('click', (e) => {
            if (!mobileMenuBtn.contains(e.target) && !mobileMenu.contains(e.target)) {
                mobileMenu.classList.add('hidden');
            }
        });

        // Transaction Type Change Handler
        transactionTypeSelect.addEventListener('change', function() {
            const type = this.value;
            
            // Clear category options
            mainCategorySelect.innerHTML = '<option value="">--‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏´‡∏•‡∏±‡∏Å--</option>';
            subCategorySelect.innerHTML = '<option value="">--‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏¢‡πà‡∏≠‡∏¢--</option>';
            updateCategoryDisplay();
            
            if (type === 'income') {
                // Show income amount section, hide items and vendor sections
                incomeAmountSection.classList.remove('hidden');
                itemsSection.classList.add('hidden');
                vendorSection.classList.add('hidden');
                
                // Add income main categories
                Object.keys(categoryData.income).forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    mainCategorySelect.appendChild(option);
                });
                
            } else if (type === 'expense') {
                // Show items and vendor sections, hide income amount section
                incomeAmountSection.classList.add('hidden');
                itemsSection.classList.remove('hidden');
                vendorSection.classList.remove('hidden');
                
                // Add expense main categories
                Object.keys(categoryData.expense).forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    mainCategorySelect.appendChild(option);
                });
            } else {
                // Hide all conditional sections
                incomeAmountSection.classList.add('hidden');
                itemsSection.classList.add('hidden');
                vendorSection.classList.add('hidden');
            }
        });

        // Main Category Change Handler
        mainCategorySelect.addEventListener('change', function() {
            const mainCategory = this.value;
            const transactionType = transactionTypeSelect.value;
            
            // Clear sub category options
            subCategorySelect.innerHTML = '<option value="">--‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏¢‡πà‡∏≠‡∏¢--</option>';
            
            if (mainCategory && transactionType) {
                const subCategories = categoryData[transactionType][mainCategory] || [];
                subCategories.forEach(subCategory => {
                    const option = document.createElement('option');
                    option.value = subCategory;
                    option.textContent = subCategory;
                    subCategorySelect.appendChild(option);
                });
            }
            
            updateCategoryDisplay();
        });

        // Sub Category Change Handler
        subCategorySelect.addEventListener('change', function() {
            updateCategoryDisplay();
        });

        // Update Category Display Function
        function updateCategoryDisplay() {
            const mainCategory = mainCategorySelect.value;
            const subCategory = subCategorySelect.value;
            
            document.getElementById('selected-main-category').textContent = mainCategory || '-';
            document.getElementById('selected-sub-category').textContent = subCategory || '-';
            
            // Update combined category for form submission
            const combinedCategory = mainCategory && subCategory ? `${mainCategory} > ${subCategory}` : '';
            document.getElementById('combined-category').value = combinedCategory;
        }

        // Add Item Function
        document.getElementById('add-item-btn').addEventListener('click', function() {
            addNewItem();
        });

                // Add New Item Function
        function addNewItem() {
            const name = document.getElementById('item-name').value.trim();
            const price = parseFloat(document.getElementById('item-price').value) || 0;
            const quantity = parseInt(document.getElementById('item-quantity').value) || 1;
            const tag = document.getElementById('item-tag').value;
            const emojiBtn = document.getElementById('emoji-picker-btn');
            const emoji = emojiBtn.textContent;
            
            if (!name) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤');
                document.getElementById('item-name').focus();
                return;
            }

            if (price <= 0) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 0');
                document.getElementById('item-price').focus();
                return;
            }
            
            const item = {
                id: ++itemCounter,
                name: name,
                tag: tag,
                emoji: emoji,
                price: price,
                quantity: quantity,
                total: price * quantity
            };
            
            selectedItems.push(item);
            updateItemsDisplay();
            
            // Clear inputs
            document.getElementById('item-name').value = '';
            document.getElementById('item-price').value = '';
            document.getElementById('item-quantity').value = '1';
            document.getElementById('item-tag').value = '';
            emojiBtn.textContent = 'üòä';
            
            // Focus back to item name for next entry
            document.getElementById('item-name').focus();
            
            // Show success feedback
            const addBtn = document.getElementById('add-item-btn');
            const originalText = addBtn.innerHTML;
            addBtn.innerHTML = '‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏•‡πâ‡∏ß';
            addBtn.classList.add('bg-green-600');
            setTimeout(() => {
                addBtn.innerHTML = originalText;
                addBtn.classList.remove('bg-green-600');
            }, 1000);
        }

        // Enter key handler for item inputs
        document.getElementById('item-name').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                document.getElementById('item-price').focus();
            }
        });

        document.getElementById('item-price').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                document.getElementById('item-quantity').focus();
            }
        });

        document.getElementById('item-quantity').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                addNewItem();
            }
        });

        // Update Items Display
        function updateItemsDisplay() {
            if (selectedItems.length === 0) {
                selectedItemsDiv.innerHTML = '<div class="text-gray-500 text-center py-4">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div>';
                totalItemsSpan.textContent = '0';
                totalAmountSpan.textContent = '0.00';
                return;
            }
            
            let totalAmount = 0;
            
            // Check if mobile view
            const isMobile = window.innerWidth <= 768;
            
            if (isMobile) {
                // Mobile card view - easier to edit on mobile
                let html = '<div class="space-y-3">';
                
                selectedItems.forEach((item, index) => {
                    totalAmount += item.total;
                    html += `
                        <div class="bg-white border rounded-lg p-4 shadow-sm">
                            <!-- Item Header -->
                            <div class="flex items-center justify-between mb-3">
                                <div class="flex items-center gap-2">
                                    <div class="w-6 h-6 bg-blue-500 text-white rounded-full flex items-center justify-center text-xs font-bold">
                                        ${index + 1}
                                    </div>
                                    <span class="text-lg">${item.emoji || 'üòä'}</span>
                                    <span class="font-medium text-gray-800">${item.name}</span>
                                </div>
                                <div class="flex gap-1">
                                    <button onclick="moveItemUp(${item.id})" 
                                            class="text-gray-500 hover:text-blue-600 p-1 ${index === 0 ? 'opacity-50 cursor-not-allowed' : ''}" 
                                            title="‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô" ${index === 0 ? 'disabled' : ''}>
                                        ‚¨ÜÔ∏è
                                    </button>
                                    <button onclick="moveItemDown(${item.id})" 
                                            class="text-gray-500 hover:text-blue-600 p-1 ${index === selectedItems.length - 1 ? 'opacity-50 cursor-not-allowed' : ''}" 
                                            title="‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏•‡∏á" ${index === selectedItems.length - 1 ? 'disabled' : ''}>
                                        ‚¨áÔ∏è
                                    </button>
                                </div>
                            </div>
                            
                                                            <!-- Item Name -->
                                <div class="mb-3">
                                    <label class="block text-xs font-medium text-gray-700 mb-1">üìù ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
                                    <input type="text" value="${item.name}" 
                                           onchange="updateItemName(${item.id}, this.value)"
                                           class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent mobile-input-touch">
                                </div>
                            
                            <!-- Price and Quantity Row -->
                            <div class="grid grid-cols-2 gap-3 mb-3">
                                <div>
                                    <label class="block text-xs font-medium text-gray-700 mb-1">üí∞ ‡∏£‡∏≤‡∏Ñ‡∏≤ (‡∏ö‡∏≤‡∏ó)</label>
                                    <div class="flex items-center gap-1">
                                                                            <button onclick="decreasePrice(${item.id})" 
                                            class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-sm mobile-button-touch">-</button>
                                        <input type="number" value="${item.price}" step="0.01" min="0"
                                               onchange="updateItemPrice(${item.id}, this.value)"
                                               class="flex-1 border border-gray-300 rounded-lg p-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent mobile-input-touch">
                                        <button onclick="increasePrice(${item.id})" 
                                                class="bg-green-500 hover:bg-green-600 text-white px-2 py-1 rounded text-sm mobile-button-touch">+</button>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-700 mb-1">üìä ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</label>
                                    <div class="flex items-center gap-1">
                                                                            <button onclick="decreaseQuantity(${item.id})" 
                                            class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-sm mobile-button-touch">-</button>
                                        <input type="number" value="${item.quantity}" min="1"
                                               onchange="updateItemQuantity(${item.id}, this.value)"
                                               class="flex-1 border border-gray-300 rounded-lg p-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent mobile-input-touch">
                                        <button onclick="increaseQuantity(${item.id})" 
                                                class="bg-green-500 hover:bg-green-600 text-white px-2 py-1 rounded text-sm mobile-button-touch">+</button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Tag Selection -->
                            <div class="mb-3">
                                <label class="block text-xs font-medium text-gray-700 mb-1">üè∑Ô∏è ‡πÅ‡∏ó‡πá‡∏Å</label>
                                <select onchange="updateItemTag(${item.id}, this.value)" 
                                        class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent mobile-input-touch">
                                    <option value="">--‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ó‡πá‡∏Å--</option>
                                    <option value="‡∏≠‡∏≤‡∏´‡∏≤‡∏£" ${item.tag === '‡∏≠‡∏≤‡∏´‡∏≤‡∏£' ? 'selected' : ''}>üçΩÔ∏è ‡∏≠‡∏≤‡∏´‡∏≤‡∏£</option>
                                    <option value="‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°" ${item.tag === '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°' ? 'selected' : ''}>ü•§ ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°</option>
                                    <option value="‡∏Ç‡∏≠‡∏á‡πÉ‡∏ä‡πâ" ${item.tag === '‡∏Ç‡∏≠‡∏á‡πÉ‡∏ä‡πâ' ? 'selected' : ''}>üõçÔ∏è ‡∏Ç‡∏≠‡∏á‡πÉ‡∏ä‡πâ</option>
                                    <option value="‡∏¢‡∏≤" ${item.tag === '‡∏¢‡∏≤' ? 'selected' : ''}>üíä ‡∏¢‡∏≤</option>
                                    <option value="‡∏Ç‡∏ô‡∏°" ${item.tag === '‡∏Ç‡∏ô‡∏°' ? 'selected' : ''}>üç™ ‡∏Ç‡∏ô‡∏°</option>
                                    <option value="‡∏ú‡∏•‡πÑ‡∏°‡πâ" ${item.tag === '‡∏ú‡∏•‡πÑ‡∏°‡πâ' ? 'selected' : ''}>üçé ‡∏ú‡∏•‡πÑ‡∏°‡πâ</option>
                                    <option value="‡∏ú‡∏±‡∏Å" ${item.tag === '‡∏ú‡∏±‡∏Å' ? 'selected' : ''}>ü•¨ ‡∏ú‡∏±‡∏Å</option>
                                    <option value="‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏™‡∏±‡∏ï‡∏ß‡πå" ${item.tag === '‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏™‡∏±‡∏ï‡∏ß‡πå' ? 'selected' : ''}>ü•© ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏™‡∏±‡∏ï‡∏ß‡πå</option>
                                    <option value="‡∏ô‡∏°" ${item.tag === '‡∏ô‡∏°' ? 'selected' : ''}>ü•õ ‡∏ô‡∏°</option>
                                    <option value="‡∏Ç‡∏ô‡∏°‡∏õ‡∏±‡∏á" ${item.tag === '‡∏Ç‡∏ô‡∏°‡∏õ‡∏±‡∏á' ? 'selected' : ''}>üçû ‡∏Ç‡∏ô‡∏°‡∏õ‡∏±‡∏á</option>
                                </select>
                            </div>
                            
                            <!-- Item Total and Actions -->
                            <div class="flex items-center justify-between pt-2 border-t">
                                <div class="text-sm">
                                    <span class="text-gray-600">‡∏£‡∏ß‡∏°:</span>
                                    <span class="font-bold text-green-600 ml-1">${item.total.toFixed(2)} ‡∏ö‡∏≤‡∏ó</span>
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="duplicateItem(${item.id})" 
                                            class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm mobile-button-touch" title="‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å">
                                        üìã ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å
                                    </button>
                                    <button onclick="removeItem(${item.id})" 
                                            class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm mobile-button-touch" title="‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£">
                                        üóëÔ∏è ‡∏•‡∏ö
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                // Add total summary
                html += `
                    <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                        <div class="flex justify-between items-center">
                            <span class="font-semibold text-green-800">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:</span>
                            <span class="font-bold text-green-600 text-lg">${totalAmount.toFixed(2)} ‡∏ö‡∏≤‡∏ó</span>
                        </div>
                    </div>
                </div>
                `;
                
                selectedItemsDiv.innerHTML = html;
            } else {
                // Desktop table view
                let html = `
                    <div class="overflow-x-auto">
                        <table class="items-table w-full border-collapse border border-gray-300">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="border border-gray-300 px-4 py-3 text-left text-sm font-semibold text-gray-700">‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
                                    <th class="border border-gray-300 px-4 py-3 text-left text-sm font-semibold text-gray-700">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                                    <th class="border border-gray-300 px-4 py-3 text-left text-sm font-semibold text-gray-700">‡πÅ‡∏ó‡πá‡∏Å</th>
                                    <th class="border border-gray-300 px-4 py-3 text-left text-sm font-semibold text-gray-700">‡∏£‡∏≤‡∏Ñ‡∏≤ (‡∏ö‡∏≤‡∏ó)</th>
                                    <th class="border border-gray-300 px-4 py-3 text-left text-sm font-semibold text-gray-700">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                                    <th class="border border-gray-300 px-4 py-3 text-left text-sm font-semibold text-gray-700">‡∏£‡∏ß‡∏° (‡∏ö‡∏≤‡∏ó)</th>
                                    <th class="border border-gray-300 px-4 py-3 text-left text-sm font-semibold text-gray-700">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                selectedItems.forEach((item, index) => {
                    totalAmount += item.total;
                    html += `
                        <tr class="hover:bg-gray-50">
                            <td class="border border-gray-300 px-4 py-3 text-center">
                                <div class="flex flex-col items-center gap-2">
                                    <div class="w-8 h-8 bg-blue-500 text-white rounded-full flex items-center justify-center text-sm font-bold">
                                        ${index + 1}
                                    </div>
                                    <div class="flex gap-1">
                                        <button onclick="moveItemUp(${item.id})" 
                                                class="text-gray-500 hover:text-blue-600 text-sm px-2 py-1 rounded hover:bg-blue-50 ${index === 0 ? 'opacity-50 cursor-not-allowed' : ''}" 
                                                title="‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô" ${index === 0 ? 'disabled' : ''}>
                                            ‚¨ÜÔ∏è
                                        </button>
                                        <button onclick="moveItemDown(${item.id})" 
                                                class="text-gray-500 hover:text-blue-600 text-sm px-2 py-1 rounded hover:bg-blue-50 ${index === selectedItems.length - 1 ? 'opacity-50 cursor-not-allowed' : ''}" 
                                                title="‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏•‡∏á" ${index === selectedItems.length - 1 ? 'disabled' : ''}>
                                            ‚¨áÔ∏è
                                        </button>
                                    </div>
                                </div>
                            </td>
                            <td class="border border-gray-300 px-4 py-3">
                                <input type="text" value="${item.name}" 
                                       onchange="updateItemName(${item.id}, this.value)"
                                       class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </td>
                            <td class="border border-gray-300 px-4 py-3">
                                <div class="flex items-center gap-3">
                                    <span class="text-2xl">${item.emoji || 'üòä'}</span>
                                    <select onchange="updateItemTag(${item.id}, this.value)" 
                                            class="flex-1 border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                        <option value="">--‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ó‡πá‡∏Å--</option>
                                        <option value="‡∏≠‡∏≤‡∏´‡∏≤‡∏£" ${item.tag === '‡∏≠‡∏≤‡∏´‡∏≤‡∏£' ? 'selected' : ''}>üçΩÔ∏è ‡∏≠‡∏≤‡∏´‡∏≤‡∏£</option>
                                        <option value="‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°" ${item.tag === '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°' ? 'selected' : ''}>ü•§ ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°</option>
                                        <option value="‡∏Ç‡∏≠‡∏á‡πÉ‡∏ä‡πâ" ${item.tag === '‡∏Ç‡∏≠‡∏á‡πÉ‡∏ä‡πâ' ? 'selected' : ''}>üõçÔ∏è ‡∏Ç‡∏≠‡∏á‡πÉ‡∏ä‡πâ</option>
                                        <option value="‡∏¢‡∏≤" ${item.tag === '‡∏¢‡∏≤' ? 'selected' : ''}>üíä ‡∏¢‡∏≤</option>
                                        <option value="‡∏Ç‡∏ô‡∏°" ${item.tag === '‡∏Ç‡∏ô‡∏°' ? 'selected' : ''}>üç™ ‡∏Ç‡∏ô‡∏°</option>
                                        <option value="‡∏ú‡∏•‡πÑ‡∏°‡πâ" ${item.tag === '‡∏ú‡∏•‡πÑ‡∏°‡πâ' ? 'selected' : ''}>üçé ‡∏ú‡∏•‡πÑ‡∏°‡πâ</option>
                                        <option value="‡∏ú‡∏±‡∏Å" ${item.tag === '‡∏ú‡∏±‡∏Å' ? 'selected' : ''}>ü•¨ ‡∏ú‡∏±‡∏Å</option>
                                        <option value="‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏™‡∏±‡∏ï‡∏ß‡πå" ${item.tag === '‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏™‡∏±‡∏ï‡∏ß‡πå' ? 'selected' : ''}>ü•© ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏™‡∏±‡∏ï‡∏ß‡πå</option>
                                        <option value="‡∏ô‡∏°" ${item.tag === '‡∏ô‡∏°' ? 'selected' : ''}>ü•õ ‡∏ô‡∏°</option>
                                        <option value="‡∏Ç‡∏ô‡∏°‡∏õ‡∏±‡∏á" ${item.tag === '‡∏Ç‡∏ô‡∏°‡∏õ‡∏±‡∏á' ? 'selected' : ''}>üçû ‡∏Ç‡∏ô‡∏°‡∏õ‡∏±‡∏á</option>
                                    </select>
                                </div>
                            </td>
                            <td class="border border-gray-300 px-4 py-3">
                                <div class="flex items-center gap-2">
                                    <button onclick="decreasePrice(${item.id})" 
                                            class="bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded-lg text-sm font-semibold">-</button>
                                    <input type="number" value="${item.price}" step="0.01" min="0"
                                           onchange="updateItemPrice(${item.id}, this.value)"
                                           class="flex-1 border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <button onclick="increasePrice(${item.id})" 
                                            class="bg-green-500 hover:bg-green-600 text-white px-3 py-2 rounded-lg text-sm font-semibold">+</button>
                                </div>
                            </td>
                            <td class="border border-gray-300 px-4 py-3">
                                <div class="flex items-center gap-2">
                                    <button onclick="decreaseQuantity(${item.id})" 
                                            class="bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded-lg text-sm font-semibold">-</button>
                                    <input type="number" value="${item.quantity}" min="1"
                                           onchange="updateItemQuantity(${item.id}, this.value)"
                                           class="flex-1 border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <button onclick="increaseQuantity(${item.id})" 
                                            class="bg-green-500 hover:bg-green-600 text-white px-3 py-2 rounded-lg text-sm font-semibold">+</button>
                                </div>
                            </td>
                            <td class="border border-gray-300 px-4 py-3 text-center">
                                <div class="text-lg font-bold text-green-600">${item.total.toFixed(2)}</div>
                            </td>
                            <td class="border border-gray-300 px-4 py-3 text-center">
                                <div class="flex gap-2 justify-center">
                                    <button onclick="duplicateItem(${item.id})" 
                                            class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-semibold" title="‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å">
                                        üìã ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å
                                    </button>
                                    <button onclick="removeItem(${item.id})" 
                                            class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm font-semibold" title="‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£">
                                        üóëÔ∏è ‡∏•‡∏ö
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
                
                // Add total row
                html += `
                            <tr class="bg-green-50">
                                <td colspan="5" class="border border-gray-300 px-4 py-3 text-right font-semibold text-gray-700">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:</td>
                                <td class="border border-gray-300 px-4 py-3 text-center font-bold text-green-600 text-lg">${totalAmount.toFixed(2)}</td>
                                <td class="border border-gray-300 px-4 py-3"></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                `;
                
                selectedItemsDiv.innerHTML = html;
            }
            
            totalItemsSpan.textContent = selectedItems.length.toString();
            totalAmountSpan.textContent = totalAmount.toFixed(2);
            
            // Update hidden inputs
            document.getElementById('items-data').value = JSON.stringify(selectedItems);
            document.getElementById('calculated-total').value = totalAmount.toFixed(2);
            
            // Create description
            const descriptions = selectedItems.map(item => 
                `${item.name} x${item.quantity}`
            );
            document.getElementById('description').value = descriptions.join(', ');
        }

        // Update Item Name Function
        function updateItemName(itemId, newName) {
            const item = selectedItems.find(item => item.id === itemId);
            if (item && newName.trim()) {
                item.name = newName.trim();
                updateItemsDisplay();
            }
        }

        // Update Item Price Function
        function updateItemPrice(itemId, newPrice) {
            const item = selectedItems.find(item => item.id === itemId);
            const price = parseFloat(newPrice);
            if (item && !isNaN(price) && price >= 0) {
                item.price = price;
                item.total = item.price * item.quantity;
                updateItemsDisplay();
            }
        }

        // Update Item Quantity Function
        function updateItemQuantity(itemId, newQuantity) {
            const item = selectedItems.find(item => item.id === itemId);
            const quantity = parseInt(newQuantity);
            if (item && !isNaN(quantity) && quantity > 0) {
                item.quantity = quantity;
                item.total = item.price * item.quantity;
                updateItemsDisplay();
            }
        }

        // Increase/Decrease Price Functions
        function increasePrice(itemId) {
            const item = selectedItems.find(item => item.id === itemId);
            if (item) {
                item.price += 1;
                item.total = item.price * item.quantity;
                updateItemsDisplay();
            }
        }

        function decreasePrice(itemId) {
            const item = selectedItems.find(item => item.id === itemId);
            if (item && item.price > 0) {
                item.price = Math.max(0, item.price - 1);
                item.total = item.price * item.quantity;
                updateItemsDisplay();
            }
        }

        // Increase/Decrease Quantity Functions
        function increaseQuantity(itemId) {
            const item = selectedItems.find(item => item.id === itemId);
            if (item) {
                item.quantity += 1;
                item.total = item.price * item.quantity;
                updateItemsDisplay();
            }
        }

        function decreaseQuantity(itemId) {
            const item = selectedItems.find(item => item.id === itemId);
            if (item && item.quantity > 1) {
                item.quantity = Math.max(1, item.quantity - 1);
                item.total = item.price * item.quantity;
                updateItemsDisplay();
            }
        }

        // Duplicate Item Function
        function duplicateItem(itemId) {
            const originalItem = selectedItems.find(item => item.id === itemId);
            if (originalItem) {
                const newItem = {
                    id: ++itemCounter,
                    name: originalItem.name + ' (‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å)',
                    tag: originalItem.tag,
                    emoji: originalItem.emoji,
                    price: originalItem.price,
                    quantity: originalItem.quantity,
                    total: originalItem.price * originalItem.quantity
                };
                
                selectedItems.push(newItem);
                updateItemsDisplay();
                
                // Show feedback
                const duplicateBtn = document.querySelector(`[onclick="duplicateItem(${itemId})"]`);
                if (duplicateBtn) {
                    duplicateBtn.style.transform = 'scale(1.2)';
                    setTimeout(() => {
                        duplicateBtn.style.transform = 'scale(1)';
                    }, 200);
                }
            }
        }

        // Remove Item Function
        function removeItem(itemId) {
            if (confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
                selectedItems = selectedItems.filter(item => item.id !== itemId);
                updateItemsDisplay();
                
                // Show feedback
                const itemElement = document.querySelector(`[onclick="removeItem(${itemId})"]`);
                if (itemElement) {
                    itemElement.style.backgroundColor = '#fef2f2';
                    itemElement.style.borderColor = '#ef4444';
                    setTimeout(() => {
                        itemElement.style.backgroundColor = '';
                        itemElement.style.borderColor = '';
                    }, 300);
                }
            }
        }

        // Clear All Items Function
        function clearAllItems() {
            if (selectedItems.length > 0 && confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
                selectedItems = [];
                updateItemsDisplay();
                alert('‡∏•‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
            }
        }

        // Move Item Up Function
        function moveItemUp(itemId) {
            const index = selectedItems.findIndex(item => item.id === itemId);
            if (index > 0) {
                const temp = selectedItems[index];
                selectedItems[index] = selectedItems[index - 1];
                selectedItems[index - 1] = temp;
                updateItemsDisplay();
            }
        }

        // Move Item Down Function
        function moveItemDown(itemId) {
            const index = selectedItems.findIndex(item => item.id === itemId);
            if (index < selectedItems.length - 1) {
                const temp = selectedItems[index];
                selectedItems[index] = selectedItems[index + 1];
                selectedItems[index + 1] = temp;
                updateItemsDisplay();
            }
        }

        // Show Items Summary Function
        function showItemsSummary() {
            if (selectedItems.length === 0) {
                alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏£‡∏∏‡∏õ');
                return;
            }

            let summary = 'üìã ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤\n\n';
            let totalAmount = 0;

            selectedItems.forEach((item, index) => {
                summary += `${index + 1}. ${item.emoji || 'üòä'} ${item.name}`;
                if (item.tag) {
                    summary += ` [${item.tag}]`;
                }
                summary += `\n`;
                summary += `   ‡∏£‡∏≤‡∏Ñ‡∏≤: ${item.price.toFixed(2)} ‡∏ö‡∏≤‡∏ó √ó ${item.quantity} = ${item.total.toFixed(2)} ‡∏ö‡∏≤‡∏ó\n\n`;
                totalAmount += item.total;
            });

            summary += `üí∞ ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${totalAmount.toFixed(2)} ‡∏ö‡∏≤‡∏ó`;
            summary += `\nüìä ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£: ${selectedItems.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;

            alert(summary);
        }

        // Add Tag Button Handler
        document.getElementById('add-tag-btn').addEventListener('click', function() {
            const customInput = document.getElementById('custom-tag-input');
            const newTagInput = document.getElementById('new-tag');
            
            if (customInput.classList.contains('hidden')) {
                customInput.classList.remove('hidden');
                newTagInput.focus();
            } else {
                addCustomTag();
            }
        });

        // Add Custom Tag Function
        function addCustomTag() {
            const newTagInput = document.getElementById('new-tag');
            const tagName = newTagInput.value.trim();
            
            if (!tagName) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏ó‡πá‡∏Å');
                return;
            }
            
            if (availableTags.includes(tagName)) {
                alert('‡πÅ‡∏ó‡πá‡∏Å‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß');
                return;
            }
            
            // Add to available tags
            availableTags.push(tagName);
            
            // Add to select options
            const tagSelect = document.getElementById('item-tag');
            const option = document.createElement('option');
            option.value = tagName;
            option.textContent = tagName;
            tagSelect.appendChild(option);
            
            // Select the new tag
            tagSelect.value = tagName;
            
            // Hide input and clear
            document.getElementById('custom-tag-input').classList.add('hidden');
            newTagInput.value = '';
            
            alert(`‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ó‡πá‡∏Å "${tagName}" ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`);
        }

        // Cancel Add Tag Function
        function cancelAddTag() {
            document.getElementById('custom-tag-input').classList.add('hidden');
            document.getElementById('new-tag').value = '';
        }

        // Update Item Tag Function
        function updateItemTag(itemId, newTag) {
            const item = selectedItems.find(item => item.id === itemId);
            if (item) {
                item.tag = newTag;
                updateItemsDisplay();
            }
        }

        // Enter key handler for custom tag
        document.getElementById('new-tag').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                addCustomTag();
            }
        });

        // Show Emoji Picker Function
        function showEmojiPicker() {
            const modal = document.getElementById('emoji-picker-modal');
            const grid = document.getElementById('emoji-grid');
            const selectedTag = document.getElementById('item-tag').value;
            
            // Clear previous emojis
            grid.innerHTML = '';
            
            if (selectedTag && emojiData[selectedTag]) {
                // Show emojis for selected tag
                emojiData[selectedTag].forEach(emoji => {
                    const button = document.createElement('button');
                    button.className = 'text-2xl p-2 hover:bg-gray-100 rounded';
                    button.textContent = emoji;
                    button.onclick = () => selectEmoji(emoji);
                    grid.appendChild(button);
                });
            } else {
                // Show all emojis
                const allEmojis = [
                    'üòÄ', 'üòÉ', 'üòÑ', 'üòÅ', 'üòÜ', 'üòÖ', 'üòÇ', 'ü§£', 'üòä', 'üòá',
                    'üôÇ', 'üôÉ', 'üòâ', 'üòå', 'üòç', 'ü•∞', 'üòò', 'üòó', 'üòô', 'üòö',
                    'üòã', 'üòõ', 'üòù', 'üòú', 'ü§™', 'ü§®', 'üßê', 'ü§ì', 'üòé', 'ü§©',
                    'ü•≥', 'üòè', 'üòí', 'üòû', 'üòî', 'üòü', 'üòï', 'üôÅ', '‚òπÔ∏è', 'üò£',
                    'üòñ', 'üò´', 'üò©', 'ü•∫', 'üò¢', 'üò≠', 'üò§', 'üò†', 'üò°', 'ü§¨',
                    'ü§Ø', 'üò≥', 'ü•µ', 'ü•∂', 'üò±', 'üò®', 'üò∞', 'üò•', 'üòì', 'ü§ó',
                    'ü§î', 'ü§≠', 'ü§´', 'ü§•', 'üò∂', 'üòê', 'üòë', 'üòØ', 'üò¶', 'üòß',
                    'üòÆ', 'üò≤', 'ü•±', 'üò¥', 'ü§§', 'üò™', 'üòµ', 'ü§ê', 'ü•¥', 'ü§¢',
                    'ü§Æ', 'ü§ß', 'üò∑', 'ü§í', 'ü§ï', 'ü§ë', 'ü§†', 'üí©', 'ü§°', 'üëπ',
                    'üë∫', 'üëª', 'üëΩ', 'üëæ', 'ü§ñ', 'üò∫', 'üò∏', 'üòπ', 'üòª', 'üòº',
                    'üòΩ', 'üôÄ', 'üòø', 'üòæ', 'üôà', 'üôâ', 'üôä', 'üíå', 'üíò', 'üíù',
                    'üíñ', 'üíó', 'üíì', 'üíû', 'üíï', 'üíü', '‚ù£Ô∏è', 'üíî', '‚ù§Ô∏è', 'üß°',
                    'üíõ', 'üíö', 'üíô', 'üíú', 'üñ§', 'ü§ç', 'ü§é', 'üíØ', 'üí¢', 'üí•',
                    'üí´', 'üí¶', 'üí®', 'üï≥Ô∏è', 'üí¨', 'üó®Ô∏è', 'üóØÔ∏è', 'üí≠', 'üí§', 'üëã',
                    'ü§ö', 'üñêÔ∏è', '‚úã', 'üññ', 'üëå', 'ü§å', 'ü§è', '‚úåÔ∏è', 'ü§û', 'ü§ü',
                    'ü§ò', 'ü§ô', 'üëà', 'üëâ', 'üëÜ', 'üñï', 'üëá', '‚òùÔ∏è', 'üëç', 'üëé',
                    '‚úä', 'üëä', 'ü§õ', 'ü§ú', 'üëè', 'üôå', 'üëê', 'ü§≤', 'ü§ù', 'üôè',
                    '‚úçÔ∏è', 'üí™', 'ü¶æ', 'ü¶ø', 'ü¶µ', 'ü¶∂', 'üëÇ', 'ü¶ª', 'üëÉ', 'üß†',
                    'ü´Ä', 'ü´Å', 'ü¶∑', 'ü¶¥', 'üëÄ', 'üëÅÔ∏è', 'üëÖ', 'üëÑ', 'üíã', 'ü©∏',
                    'üçΩÔ∏è', 'üçú', 'üçï', 'üçî', 'üçü', 'üåÆ', 'üåØ', 'ü•™', 'üç±', 'üçõ',
                    'ü•§', '‚òï', 'üßÉ', 'üç∫', 'üç∑', 'ü•õ', 'üßã', 'üçπ', 'ü•§', 'üíß',
                    'üõçÔ∏è', 'üß¥', 'üßª', 'üßΩ', 'üëï', 'üëñ', 'üëü', 'üëú', 'üíÑ', 'ü™û',
                    'üíä', 'üè•', 'ü©∫', 'ü©π', 'ü©ª', 'üíâ', 'ü©∏', 'üß¨', 'üî¨', 'üìã',
                    'üç™', 'üç©', 'üç∞', 'üßÅ', 'üç¶', 'üç®', 'üç≠', 'üç´', 'üç¨', 'üç°',
                    'üçé', 'üçå', 'üçä', 'üçá', 'üçì', 'üçë', 'ü•≠', 'üçç', 'ü••', 'ü•ù',
                    'ü•¨', 'ü•ï', 'ü•¶', 'ü•í', 'üçÖ', 'üåΩ', 'ü•ë', 'ü•í', 'üßÖ', 'üßÑ',
                    'ü•©', 'üçó', 'üçñ', 'ü•ì', 'üçñ', 'üêü', 'ü¶ê', 'ü¶ë', 'ü¶û', 'ü¶Ä',
                    'ü•õ', 'üßÄ', 'üç¶', 'üç®', 'ü•õ', 'üßà', 'ü•õ', 'üçº', 'ü•õ', 'ü•õ',
                    'üçû', 'ü•ñ', 'ü•®', 'ü•Ø', 'ü•ê', 'ü•™', 'üçû', 'ü•ñ', 'ü•®', 'ü•Ø'
                ];
                
                allEmojis.forEach(emoji => {
                    const button = document.createElement('button');
                    button.className = 'text-2xl p-2 hover:bg-gray-100 rounded';
                    button.textContent = emoji;
                    button.onclick = () => selectEmoji(emoji);
                    grid.appendChild(button);
                });
            }
            
            modal.classList.remove('hidden');
        }

        // Close Emoji Picker Function
        function closeEmojiPicker() {
            document.getElementById('emoji-picker-modal').classList.add('hidden');
        }

        // Select Emoji Function
        function selectEmoji(emoji) {
            const selectedTag = document.getElementById('item-tag').value;
            const emojiBtn = document.getElementById('emoji-picker-btn');
            
            // Update emoji button
            emojiBtn.textContent = emoji;
            
            // Store selected emoji for the current tag
            if (selectedTag) {
                if (!window.selectedEmojis) {
                    window.selectedEmojis = {};
                }
                window.selectedEmojis[selectedTag] = emoji;
            }
            
            closeEmojiPicker();
        }

        // Update Tag Emoji Function
        function updateTagEmoji() {
            const selectedTag = document.getElementById('item-tag').value;
            const emojiBtn = document.getElementById('emoji-picker-btn');
            
            if (selectedTag) {
                // Use stored emoji or default
                const storedEmoji = window.selectedEmojis && window.selectedEmojis[selectedTag];
                const defaultEmoji = defaultEmojis[selectedTag];
                emojiBtn.textContent = storedEmoji || defaultEmoji || 'üòä';
            } else {
                emojiBtn.textContent = 'üòä';
            }
        }

        // Show Tag Filter Function
        function showTagFilter() {
            if (selectedItems.length === 0) {
                alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡πâ‡∏Å‡∏£‡∏≠‡∏á');
                return;
            }

            // Get unique tags from items
            const itemTags = selectedItems.map(item => item.tag).filter(tag => tag);
            const uniqueTags = [...new Set(itemTags)];

            if (uniqueTags.length === 0) {
                alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÅ‡∏ó‡πá‡∏Å‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤');
                return;
            }

            let filterOptions = 'üè∑Ô∏è ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ó‡πá‡∏Å‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏á:\n\n';
            uniqueTags.forEach((tag, index) => {
                const count = selectedItems.filter(item => item.tag === tag).length;
                filterOptions += `${index + 1}. ${tag} (${count} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)\n`;
            });
            filterOptions += '\n0. ‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î';

            const choice = prompt(filterOptions + '\n\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£:');
            
            if (choice === null) return; // User cancelled
            
            const choiceNum = parseInt(choice);
            if (choiceNum === 0) {
                // Show all items
                updateItemsDisplay();
                alert('‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î');
            } else if (choiceNum >= 1 && choiceNum <= uniqueTags.length) {
                // Filter by selected tag
                const selectedTag = uniqueTags[choiceNum - 1];
                const filteredItems = selectedItems.filter(item => item.tag === selectedTag);
                
                if (filteredItems.length > 0) {
                    let summary = `üè∑Ô∏è ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÅ‡∏ó‡πá‡∏Å "${selectedTag}":\n\n`;
                    let totalAmount = 0;

                    filteredItems.forEach((item, index) => {
                        summary += `${index + 1}. ${item.emoji || 'üòä'} ${item.name}\n`;
                        summary += `   ‡∏£‡∏≤‡∏Ñ‡∏≤: ${item.price.toFixed(2)} ‡∏ö‡∏≤‡∏ó √ó ${item.quantity} = ${item.total.toFixed(2)} ‡∏ö‡∏≤‡∏ó\n\n`;
                        totalAmount += item.total;
                    });

                    summary += `üí∞ ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°: ${totalAmount.toFixed(2)} ‡∏ö‡∏≤‡∏ó`;
                    summary += `\nüìä ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£: ${filteredItems.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;

                    alert(summary);
                }
            } else {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
            }
        }

        // Form Submit Handler
        document.getElementById('transaction-form').addEventListener('submit', function(e) {
            const transactionType = transactionTypeSelect.value;
            const mainCategory = mainCategorySelect.value;
            const subCategory = subCategorySelect.value;
            
            if (!transactionType) {
                e.preventDefault();
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');
                return;
            }
            
            if (!mainCategory) {
                e.preventDefault();
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏´‡∏•‡∏±‡∏Å');
                return;
            }
            
            if (!subCategory) {
                e.preventDefault();
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏¢‡πà‡∏≠‡∏¢');
                return;
            }
            
            if (transactionType === 'income') {
                const incomeAmount = parseFloat(document.getElementById('income-amount').value) || 0;
                if (incomeAmount <= 0) {
                    e.preventDefault();
                    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö');
                    return;
                }
                
                // Set values for income
                document.getElementById('calculated-total').value = incomeAmount.toFixed(2);
                document.getElementById('description').value = `‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö: ${mainCategory} > ${subCategory}`;
                document.getElementById('items-data').value = '';
                
            } else if (transactionType === 'expense') {
                if (selectedItems.length === 0) {
                    e.preventDefault();
                    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');
                    return;
                }
                
                const vendor = document.getElementById('vendor-select').value;
                if (!vendor) {
                    e.preventDefault();
                    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤');
                    return;
                }
            }
        });

        // Add Main Category Button Handler
        document.getElementById('add-main-category-btn').addEventListener('click', function() {
            const customInput = document.getElementById('custom-main-category-input');
            const newCategoryInput = document.getElementById('new-main-category');
            
            if (customInput.classList.contains('hidden')) {
                customInput.classList.remove('hidden');
                newCategoryInput.focus();
            } else {
                addCustomMainCategory();
            }
        });

        // Add Custom Main Category Function
        function addCustomMainCategory() {
            const newCategoryInput = document.getElementById('new-main-category');
            const categoryName = newCategoryInput.value.trim();
            const transactionType = transactionTypeSelect.value;
            
            if (!categoryName) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏´‡∏•‡∏±‡∏Å');
                return;
            }
            
            if (!transactionType) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Å‡πà‡∏≠‡∏ô');
                return;
            }
            
            // Add to category data structure
            if (!categoryData[transactionType][categoryName]) {
                categoryData[transactionType][categoryName] = [];
            }
            
            // Add to select options
            const option = document.createElement('option');
            option.value = categoryName;
            option.textContent = categoryName;
            mainCategorySelect.appendChild(option);
            
            // Select the new category
            mainCategorySelect.value = categoryName;
            
            // Hide input and clear
            document.getElementById('custom-main-category-input').classList.add('hidden');
            newCategoryInput.value = '';
            
            // Clear sub categories
            subCategorySelect.innerHTML = '<option value="">--‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏¢‡πà‡∏≠‡∏¢--</option>';
            updateCategoryDisplay();
            
            alert(`‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏´‡∏•‡∏±‡∏Å "${categoryName}" ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`);
        }

        // Enter key handler for custom main category
        document.getElementById('new-main-category').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                addCustomMainCategory();
            }
        });

        // Add Sub Category Button Handler
        document.getElementById('add-sub-category-btn').addEventListener('click', function() {
            const customInput = document.getElementById('custom-sub-category-input');
            const newCategoryInput = document.getElementById('new-sub-category');
            
            if (customInput.classList.contains('hidden')) {
                customInput.classList.remove('hidden');
                newCategoryInput.focus();
            } else {
                addCustomSubCategory();
            }
        });

        // Add Custom Sub Category Function
        function addCustomSubCategory() {
            const newCategoryInput = document.getElementById('new-sub-category');
            const subCategoryName = newCategoryInput.value.trim();
            const mainCategory = mainCategorySelect.value;
            const transactionType = transactionTypeSelect.value;
            
            if (!subCategoryName) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏¢‡πà‡∏≠‡∏¢');
                return;
            }
            
            if (!mainCategory) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏´‡∏•‡∏±‡∏Å‡∏Å‡πà‡∏≠‡∏ô');
                return;
            }
            
            // Add to category data structure
            if (!categoryData[transactionType][mainCategory]) {
                categoryData[transactionType][mainCategory] = [];
            }
            
            if (categoryData[transactionType][mainCategory].includes(subCategoryName)) {
                alert('‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏¢‡πà‡∏≠‡∏¢‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß');
                return;
            }
            
            categoryData[transactionType][mainCategory].push(subCategoryName);
            
            // Add to select options
            const option = document.createElement('option');
            option.value = subCategoryName;
            option.textContent = subCategoryName;
            subCategorySelect.appendChild(option);
            
            // Select the new sub category
            subCategorySelect.value = subCategoryName;
            
            // Hide input and clear
            document.getElementById('custom-sub-category-input').classList.add('hidden');
            newCategoryInput.value = '';
            
            updateCategoryDisplay();
            
            alert(`‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏¢‡πà‡∏≠‡∏¢ "${subCategoryName}" ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`);
        }

        // Enter key handler for custom sub category
        document.getElementById('new-sub-category').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                addCustomSubCategory();
            }
        });

        // Add Vendor Button Handler
        document.getElementById('add-vendor-btn').addEventListener('click', function() {
            const customInput = document.getElementById('custom-vendor-input');
            const newVendorInput = document.getElementById('new-vendor');
            
            if (customInput.classList.contains('hidden')) {
                customInput.classList.remove('hidden');
                newVendorInput.focus();
            } else {
                addCustomVendor();
            }
        });

        // Add Custom Vendor Function
        function addCustomVendor() {
            const newVendorInput = document.getElementById('new-vendor');
            const vendorName = newVendorInput.value.trim();
            
            if (!vendorName) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤');
                return;
            }
            
            const vendorSelect = document.getElementById('vendor-select');
            
            // Check if vendor already exists
            const existingOptions = Array.from(vendorSelect.options);
            const exists = existingOptions.some(option => option.value === vendorName);
            
            if (exists) {
                alert('‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß');
                return;
            }
            
            // Add new option
            const option = document.createElement('option');
            option.value = vendorName;
            option.textContent = vendorName;
            vendorSelect.appendChild(option);
            
            // Select the new vendor
            vendorSelect.value = vendorName;
            
            // Hide input and clear
            document.getElementById('custom-vendor-input').classList.add('hidden');
            newVendorInput.value = '';
            
            alert(`‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤ "${vendorName}" ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`);
        }

        // Enter key handler for custom vendor
        document.getElementById('new-vendor').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                addCustomVendor();
            }
        });

        // Change Month Function
        function changeMonth(month) {
            window.location.href = `/income-expense?month=${month}`;
        }

        // Export Data Function
        function exportData(category, yearMonth) {
            const url = `/export-${category}/${yearMonth}`;
            window.open(url, '_blank');
        }

        // Export Year Data Function
        function exportYearData(year) {
            const url = `/export-all/${year}`;
            window.open(url, '_blank');
        }

        // Show Monthly Summary Function
        function showMonthlySummary() {
            const selectedMonth = document.getElementById('month-select').value;
            const monthDisplay = document.getElementById('month-select').options[document.getElementById('month-select').selectedIndex].text;
            
            // Get summary data from the page
            const totalIncome = parseFloat('{{ monthly_total_income }}') || 0;
            const totalExpense = parseFloat('{{ monthly_total_expense }}') || 0;
            const balance = totalIncome - totalExpense;
            const totalRecords = parseInt('{{ total_records }}') || 0;
            
            let summary = `üìã ‡∏™‡∏£‡∏∏‡∏õ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô: ${monthDisplay}\n\n`;
            summary += `üí∞ ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏£‡∏ß‡∏°: ${totalIncome.toFixed(2)} ‡∏ö‡∏≤‡∏ó\n`;
            summary += `üí∏ ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏ß‡∏°: ${totalExpense.toFixed(2)} ‡∏ö‡∏≤‡∏ó\n`;
            summary += `üìä ‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${balance.toFixed(2)} ‡∏ö‡∏≤‡∏ó\n`;
            summary += `üìù ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£: ${totalRecords} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£\n\n`;
            
            if (balance > 0) {
                summary += `‚úÖ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏°‡∏µ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏´‡∏•‡∏∑‡∏≠ (‡∏Å‡∏≥‡πÑ‡∏£)\n`;
            } else if (balance < 0) {
                summary += `‚ö†Ô∏è ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡πÉ‡∏ä‡πâ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô (‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô)\n`;
            } else {
                summary += `‚öñÔ∏è ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢\n`;
            }
            
            // Add percentage analysis
            if (totalIncome > 0) {
                const expensePercentage = ((totalExpense / totalIncome) * 100).toFixed(1);
                summary += `üìà ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏ï‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö: ${expensePercentage}%\n`;
            }
            
            alert(summary);
        }

        // Show Yearly View Function
        function showYearlyView() {
            const currentYear = new Date().getFullYear();
            const selectedMonth = document.getElementById('month-select').value;
            const year = selectedMonth.split('-')[0];
            
            // Redirect to yearly view or show year selection
            const choice = confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏õ‡∏µ ${year} ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?\n\n‡∏Å‡∏î "‡∏ï‡∏Å‡∏•‡∏á" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏õ‡∏µ\n‡∏Å‡∏î "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏µ‡∏≠‡∏∑‡πà‡∏ô`);
            
            if (choice) {
                // Redirect to yearly view (you can create this route)
                window.location.href = `/income-expense/year/${year}`;
            } else {
                // Show year selection
                const newYear = prompt('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏õ‡∏µ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏π (‡πÄ‡∏ä‡πà‡∏ô 2025):', year);
                if (newYear && /^\d{4}$/.test(newYear)) {
                    window.location.href = `/income-expense/year/${newYear}`;
                }
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Set today's date as default
            const today = new Date().toISOString().split('T')[0];
            document.querySelector('input[name="date"]').value = today;
            
            // Auto refresh after form submission
            if (window.location.search.includes('success=true')) {
                setTimeout(() => {
                    window.location.href = window.location.pathname;
                }, 2000);
            }
            
            // Handle window resize for responsive design
            window.addEventListener('resize', function() {
                if (selectedItems.length > 0) {
                    updateItemsDisplay();
                }
            });
        });
    </script>
</body>
</html>