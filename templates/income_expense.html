<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>รายรับรายจ่าย</title>
    <script src="{{ url_for('static', filename='js/tailwind.min.js') }}"></script>
    <style>
        /* Custom styles for mobile responsiveness */
        @media (max-width: 768px) {
            .mobile-responsive {
                font-size: 14px;
            }
        }
        
        /* Animation for buttons */
        .btn-animate {
            transition: all 0.2s ease;
        }
        .btn-animate:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .btn-animate:active {
            transform: translateY(0);
        }
        
        /* Smooth transitions */
        .smooth-transition {
            transition: all 0.3s ease;
        }
        
        /* Table styles */
        .items-table {
            border-collapse: collapse;
            width: 100%;
        }
        
        .items-table th {
            background-color: #f9fafb;
            border: 1px solid #e5e7eb;
            padding: 8px 12px;
            text-align: left;
            font-size: 12px;
            font-weight: 600;
            color: #374151;
        }
        
        .items-table td {
            border: 1px solid #e5e7eb;
            padding: 8px 12px;
            vertical-align: middle;
        }
        
        .items-table tr:hover {
            background-color: #f9fafb;
        }
        
        .items-table .total-row {
            background-color: #f3f4f6;
            font-weight: 600;
        }
        
        .items-table .total-row td {
            border-top: 2px solid #d1d5db;
        }
        
        /* Mobile table styles */
        .mobile-table {
            font-size: 10px;
        }
        
        .mobile-table th {
            padding: 4px 6px;
            font-size: 10px;
            white-space: nowrap;
        }
        
        .mobile-table td {
            padding: 4px 6px;
            font-size: 10px;
        }
        
        .mobile-table input,
        .mobile-table select {
            font-size: 10px;
            padding: 2px 4px;
            min-width: 40px;
        }
        
        .mobile-table button {
            font-size: 9px;
            padding: 1px 2px;
        }
        
        .mobile-table .w-5 {
            width: 1.25rem;
            height: 1.25rem;
        }
        
        /* Ensure table fits on mobile without horizontal scroll */
        @media (max-width: 768px) {
            .mobile-table {
                table-layout: fixed;
                width: 100%;
            }
            
            .mobile-table th:nth-child(1) { width: 8%; }  /* # */
            .mobile-table th:nth-child(2) { width: 20%; } /* ชื่อ */
            .mobile-table th:nth-child(3) { width: 15%; } /* แท็ก */
            .mobile-table th:nth-child(4) { width: 18%; } /* ราคา */
            .mobile-table th:nth-child(5) { width: 15%; } /* จำนวน */
            .mobile-table th:nth-child(6) { width: 12%; } /* รวม */
            .mobile-table th:nth-child(7) { width: 12%; } /* จัดการ */
        }
        
        /* Mobile responsive styles */
        @media (max-width: 768px) {
            .mobile-card {
                background: white;
                border-radius: 8px;
                padding: 12px;
                margin-bottom: 12px;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }
            
            .mobile-item-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 8px;
            }
            
            .mobile-item-number {
                background: #3b82f6;
                color: white;
                width: 24px;
                height: 24px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 12px;
                font-weight: bold;
            }
            
            .mobile-item-actions {
                display: flex;
                gap: 4px;
            }
            
            .mobile-item-field {
                margin-bottom: 8px;
            }
            
            .mobile-item-label {
                font-size: 11px;
                font-weight: 600;
                color: #6b7280;
                margin-bottom: 4px;
            }
            
            .mobile-item-input {
                width: 100%;
                border: 1px solid #d1d5db;
                border-radius: 4px;
                padding: 6px 8px;
                font-size: 14px;
            }
            
            .mobile-item-select {
                width: 100%;
                border: 1px solid #d1d5db;
                border-radius: 4px;
                padding: 6px 8px;
                font-size: 14px;
            }
            
            .mobile-controls {
                display: flex;
                gap: 4px;
                align-items: center;
            }
            
            .mobile-control-btn {
                background: #f3f4f6;
                border: 1px solid #d1d5db;
                border-radius: 4px;
                width: 24px;
                height: 24px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 12px;
                color: #6b7280;
            }
            
            .mobile-control-btn:hover {
                background: #e5e7eb;
            }
            
            .mobile-total {
                font-weight: 600;
                color: #059669;
                text-align: right;
            }
            
            .mobile-form-grid {
                display: grid;
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            .mobile-form-row {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 8px;
            }
            
            .mobile-form-full {
                grid-column: 1 / -1;
            }
            
            .mobile-button {
                width: 100%;
                padding: 12px;
                border-radius: 8px;
                font-weight: 600;
                font-size: 14px;
                border: none;
                cursor: pointer;
            }
            
            .mobile-button-primary {
                background: #3b82f6;
                color: white;
            }
            
            .mobile-button-secondary {
                background: #6b7280;
                color: white;
            }
            
            .mobile-button-success {
                background: #059669;
                color: white;
            }
            
            .mobile-button-danger {
                background: #dc2626;
                color: white;
            }
            
            .mobile-summary-cards {
                display: grid;
                grid-template-columns: 1fr;
                gap: 8px;
                margin-bottom: 16px;
            }
            
            .mobile-summary-card {
                padding: 12px;
                border-radius: 8px;
                text-align: center;
            }
            
            .mobile-summary-value {
                font-size: 18px;
                font-weight: bold;
                margin-bottom: 4px;
            }
            
            .mobile-summary-label {
                font-size: 12px;
                opacity: 0.8;
            }
            
            /* Mobile Items Display Optimization */
            .mobile-items-container {
                max-height: 60vh;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .mobile-item-card {
                transition: all 0.2s ease;
            }
            
            .mobile-item-card:focus-within {
                box-shadow: 0 0 0 2px #3b82f6;
            }
            
            .mobile-input-touch {
                min-height: 44px; /* iOS touch target minimum */
                font-size: 16px; /* Prevent zoom on iOS */
            }
            
            .mobile-button-touch {
                min-height: 44px;
                min-width: 44px;
                touch-action: manipulation;
            }
            
            /* Mobile table optimization */
            .mobile-table {
                font-size: 12px;
            }
            
            .mobile-table th,
            .mobile-table td {
                padding: 4px;
                vertical-align: middle;
            }
            
            .mobile-table input,
            .mobile-table select {
                font-size: 12px;
                padding: 2px 4px;
            }
            
            /* Desktop table optimization */
            .items-table {
                box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
                border-radius: 8px;
                overflow: hidden;
            }
            
            .items-table th {
                background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
                font-weight: 600;
                text-transform: uppercase;
                letter-spacing: 0.05em;
            }
            
            .items-table tr:hover {
                background-color: #f8fafc;
                transition: background-color 0.2s ease;
            }
            
            .items-table input:focus,
            .items-table select:focus {
                box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
                border-color: #3b82f6;
            }
            
            .items-table button {
                transition: all 0.2s ease;
            }
            
            .items-table button:hover {
                transform: translateY(-1px);
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 min-h-screen">
    <!-- Mobile Header -->
    <div class="lg:hidden fixed top-0 left-0 w-full bg-white shadow-lg z-50">
        <div class="flex items-center justify-between p-4">
            <h1 class="text-xl font-bold text-gray-800">💰 รายรับ-รายจ่าย</h1>
            <button id="mobile-menu-btn" class="text-gray-600 hover:text-gray-800 focus:outline-none">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                </svg>
            </button>
        </div>
        
        <!-- Mobile Menu -->
        <div id="mobile-menu" class="hidden bg-white border-t">
            <nav class="py-2">
                <a href="/index" class="block px-4 py-3 text-gray-700 hover:bg-gray-100 border-b">📅 บันทึกโอที</a>
                <a href="/income-expense" class="block px-4 py-3 bg-green-100 text-green-700 font-medium border-b">💰 รายรับ/รายจ่าย</a>
                <a href="/holidays" class="block px-4 py-3 text-gray-700 hover:bg-gray-100 border-b">🎉 วันหยุด</a>
                <a href="/import-csv" class="block px-4 py-3 text-gray-700 hover:bg-gray-100 border-b">📊 นำเข้า CSV รายรับ/รายจ่าย</a>
                <a href="/import-ot-csv" class="block px-4 py-3 text-gray-700 hover:bg-gray-100 border-b">⏰ นำเข้า CSV โอที</a>
                <a href="/settings" class="block px-4 py-3 text-gray-700 hover:bg-gray-100 border-b">⚙️ ตั้งค่า</a>
                <div class="px-4 py-3 border-b">
                    {% if session.user_picture %}
                        <div class="flex items-center gap-3">
                            <img src="{{ session.user_picture }}" alt="Profile" class="w-6 h-6 rounded-full">
                            <div>
                                <div class="text-sm font-medium text-gray-800">{{ session.user_name or session.user_email }}</div>
                                <div class="text-xs text-gray-500">{{ session.user_email }}</div>
                            </div>
                        </div>
                    {% else %}
                    <span class="text-sm text-gray-500">👤 {{ session.user_email }}</span>
                    {% endif %}
                </div>
                <a href="/logout" class="block px-4 py-3 text-red-600 hover:bg-red-50">🚪 ออกจากระบบ</a>
            </nav>
        </div>
    </div>

    <!-- Desktop Sidebar -->
    <div class="hidden lg:block fixed top-0 left-0 w-64 h-full bg-white shadow-lg z-40">
        <div class="p-6">
            <h1 class="text-2xl font-bold text-gray-800 mb-8">📊 ระบบจัดการ</h1>
            <nav class="space-y-2">
                <a href="/index" class="block px-4 py-3 text-gray-700 hover:bg-gray-100 rounded-lg smooth-transition">📅 บันทึกโอที</a>
                <a href="/income-expense" class="block px-4 py-3 bg-green-100 text-green-700 font-medium rounded-lg">💰 รายรับ/รายจ่าย</a>
                <a href="/holidays" class="block px-4 py-3 text-gray-700 hover:bg-gray-100 rounded-lg smooth-transition">🎉 วันหยุด</a>
                <a href="/import-csv" class="block px-4 py-3 text-gray-700 hover:bg-gray-100 rounded-lg smooth-transition">📊 นำเข้า CSV รายรับ/รายจ่าย</a>
                <a href="/import-ot-csv" class="block px-4 py-3 text-gray-700 hover:bg-gray-100 rounded-lg smooth-transition">⏰ นำเข้า CSV โอที</a>
                <a href="/settings" class="block px-4 py-3 text-gray-700 hover:bg-gray-100 rounded-lg smooth-transition">⚙️ ตั้งค่า</a>
            </nav>
            <div class="mt-8 pt-6 border-t">
                <div class="px-4 py-3">
                    {% if session.user_picture %}
                        <div class="flex items-center gap-3 mb-3">
                            <img src="{{ session.user_picture }}" alt="Profile" class="w-8 h-8 rounded-full">
                            <div>
                                <div class="text-sm font-medium text-gray-800">{{ session.user_name or session.user_email }}</div>
                                <div class="text-xs text-gray-500">{{ session.user_email }}</div>
                            </div>
                        </div>
                    {% else %}
                <div class="px-4 py-2">
                    <span class="text-sm text-gray-500">👤 {{ session.user_email }}</span>
                        </div>
                    {% endif %}
                </div>
                <a href="/logout" class="block px-4 py-3 text-red-600 hover:bg-red-50 rounded-lg smooth-transition">🚪 ออกจากระบบ</a>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="lg:ml-64 pt-20 lg:pt-6 p-4 lg:p-6 min-h-screen">
        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="mb-4 p-4 rounded-lg {% if category == 'success' %}bg-green-100 text-green-700 border border-green-200{% elif category == 'error' %}bg-red-100 text-red-700 border border-red-200{% else %}bg-blue-100 text-blue-700 border border-blue-200{% endif %}">
                        <div class="flex items-center">
                            <span class="mr-2">
                                {% if category == 'success' %}✅{% elif category == 'error' %}❌{% else %}ℹ️{% endif %}
                            </span>
                            {{ message }}
                        </div>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <!-- Page Title -->
        <div class="mb-6">
            <h1 class="text-2xl lg:text-3xl font-bold text-center lg:text-left">📒 รายรับ - รายจ่าย</h1>
        </div>

        <!-- Add Transaction Form -->
        <div class="bg-white p-4 lg:p-6 rounded-lg shadow-md mb-6">
            <form id="transaction-form" method="POST" class="space-y-4">
                <!-- Date and Transaction Type -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                    <div>
                        <label class="block font-semibold mb-2">📅 วันที่</label>
                        <input type="date" name="date" required 
                               class="w-full border rounded-lg p-3 focus:ring-2 focus:ring-blue-400 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block font-semibold mb-2">📊 ประเภทรายการ</label>
                        <select id="transaction-type" name="transaction_type" required 
                                class="w-full border rounded-lg p-3 focus:ring-2 focus:ring-blue-400 focus:border-transparent">
                            <option value="">--เลือกรายรับ/รายจ่าย--</option>
                            <option value="expense">💸 รายจ่าย</option>
                            <option value="income">💰 รายรับ</option>
                        </select>
                    </div>
                </div>

                <!-- Category Section -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                    <div>
                        <label class="block font-semibold mb-2">📋 ประเภทหลัก</label>
                        <div class="flex gap-2">
                            <select id="main-category" name="main_category" required 
                                    class="flex-1 border rounded-lg p-3 focus:ring-2 focus:ring-blue-400 focus:border-transparent">
                                <option value="">--เลือกประเภทหลัก--</option>
                            </select>
                            <button type="button" id="add-main-category-btn"
                                    class="btn-animate bg-purple-500 hover:bg-purple-600 text-white px-3 py-2 rounded-lg text-sm">
                                ➕ เพิ่ม
                            </button>
                        </div>
                        <!-- Custom main category input -->
                        <div id="custom-main-category-input" class="mt-2 hidden">
                            <input type="text" id="new-main-category" placeholder="พิมพ์ประเภทหลักใหม่..."
                                   class="w-full border border-purple-300 rounded-lg p-2 focus:ring-2 focus:ring-purple-400">
                            <div class="text-xs text-purple-600 mt-1">💡 กด Enter เพื่อเพิ่มประเภทหลักใหม่</div>
                        </div>
                    </div>

                    <div>
                        <label class="block font-semibold mb-2">📋 ประเภทย่อย</label>
                        <div class="flex gap-2">
                            <select id="sub-category" name="sub_category" required 
                                    class="flex-1 border rounded-lg p-3 focus:ring-2 focus:ring-blue-400 focus:border-transparent">
                                <option value="">--เลือกประเภทย่อย--</option>
                            </select>
                            <button type="button" id="add-sub-category-btn"
                                    class="btn-animate bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded-lg text-sm">
                                ➕ เพิ่ม
                            </button>
                        </div>
                        <!-- Custom sub category input -->
                        <div id="custom-sub-category-input" class="mt-2 hidden">
                            <input type="text" id="new-sub-category" placeholder="พิมพ์ประเภทย่อยใหม่..."
                                   class="w-full border border-blue-300 rounded-lg p-2 focus:ring-2 focus:ring-blue-400">
                            <div class="text-xs text-blue-600 mt-1">💡 กด Enter เพื่อเพิ่มประเภทย่อยใหม่</div>
                        </div>
                    </div>
                </div>

                <!-- Combined Category Display -->
                <div class="bg-gray-50 p-3 rounded-lg border">
                    <label class="block font-semibold mb-2">📋 ประเภทที่เลือก</label>
                    <div class="flex items-center gap-2">
                        <span class="text-sm text-gray-600">ประเภทหลัก:</span>
                        <span id="selected-main-category" class="font-medium text-purple-600">-</span>
                        <span class="text-sm text-gray-600">|</span>
                        <span class="text-sm text-gray-600">ประเภทย่อย:</span>
                        <span id="selected-sub-category" class="font-medium text-blue-600">-</span>
                    </div>
                    <input type="hidden" id="combined-category" name="category" value="">
                </div>

                <!-- Income Amount (for income transactions) -->
                <div id="income-amount-section" class="hidden">
                    <label class="block font-semibold mb-2">💰 จำนวนเงิน</label>
                    <input type="number" id="income-amount" name="income_amount" step="0.01" placeholder="0.00"
                           class="w-full border rounded-lg p-3 focus:ring-2 focus:ring-blue-400 focus:border-transparent">
                </div>

                <!-- Items Section (for expense transactions) -->
                <div id="items-section" class="hidden">
                    <label class="block font-semibold mb-2">📦 รายการสินค้า</label>
                    <div class="border rounded-lg p-4 bg-gray-50">
                        <!-- Selected Items Display -->
                        <div id="selected-items" class="mb-4 mobile-items-container">
                            <div class="text-gray-500 text-center py-4">ยังไม่มีรายการสินค้า</div>
                        </div>

                        <!-- Add New Item - Mobile Optimized -->
                        <div class="border-t pt-4">
                            <div class="space-y-4">
                                <!-- Item Name -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">📝 ชื่อสินค้า</label>
                                    <input type="text" id="item-name" placeholder="เช่น: ขนมปัง, นม, ผักกาด"
                                           class="w-full border border-gray-300 rounded-lg p-3 text-base focus:ring-2 focus:ring-blue-500 focus:border-transparent mobile-input-touch transition-all duration-200 hover:border-gray-400">
                                </div>
                                
                                <!-- Price and Quantity Row -->
                                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">💰 ราคา (บาท)</label>
                                        <div class="relative">
                                            <input type="number" id="item-price" step="0.01" placeholder="0.00"
                                                   class="w-full border border-gray-300 rounded-lg p-3 text-base focus:ring-2 focus:ring-blue-500 focus:border-transparent mobile-input-touch transition-all duration-200 hover:border-gray-400">
                                            <div class="absolute inset-y-0 right-0 flex items-center pr-3">
                                                <span class="text-gray-500 text-sm">฿</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">📊 จำนวน</label>
                                        <input type="number" id="item-quantity" min="1" value="1"
                                               class="w-full border border-gray-300 rounded-lg p-3 text-base focus:ring-2 focus:ring-blue-500 focus:border-transparent mobile-input-touch transition-all duration-200 hover:border-gray-400">
                                    </div>
                                </div>
                                
                                <!-- Tag Selection -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">🏷️ แท็ก</label>
                                    <div class="flex flex-col lg:flex-row gap-3">
                                        <select id="item-tag" class="flex-1 border border-gray-300 rounded-lg p-3 text-base focus:ring-2 focus:ring-blue-500 focus:border-transparent mobile-input-touch transition-all duration-200 hover:border-gray-400" onchange="updateTagEmoji()">
                                            <option value="">--เลือกแท็ก--</option>
                                            <option value="อาหาร">🍽️ อาหาร</option>
                                            <option value="เครื่องดื่ม">🥤 เครื่องดื่ม</option>
                                            <option value="ของใช้">🛍️ ของใช้</option>
                                            <option value="ยา">💊 ยา</option>
                                            <option value="ขนม">🍪 ขนม</option>
                                            <option value="ผลไม้">🍎 ผลไม้</option>
                                            <option value="ผัก">🥬 ผัก</option>
                                            <option value="เนื้อสัตว์">🥩 เนื้อสัตว์</option>
                                            <option value="นม">🥛 นม</option>
                                            <option value="ขนมปัง">🍞 ขนมปัง</option>
                                        </select>
                                        <div class="flex gap-2">
                                            <button type="button" id="emoji-picker-btn"
                                                    class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-3 rounded-lg text-lg mobile-button-touch transition-all duration-200 hover:shadow-lg" onclick="showEmojiPicker()">
                                                😊
                                            </button>
                                            <button type="button" id="add-tag-btn"
                                                    class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-3 rounded-lg text-lg mobile-button-touch transition-all duration-200 hover:shadow-lg">
                                                ➕
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Emoji Picker Modal -->
                                <div id="emoji-picker-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
                                    <div class="bg-white rounded-lg p-6 max-w-sm w-full max-h-96 overflow-y-auto">
                                        <div class="flex justify-between items-center mb-4">
                                            <h3 class="text-lg font-semibold">เลือกอิโมจิ</h3>
                                            <button onclick="closeEmojiPicker()" class="text-gray-500 hover:text-gray-700 text-xl">
                                                ✕
                                            </button>
                                        </div>
                                        <div id="emoji-grid" class="grid grid-cols-8 gap-3">
                                            <!-- Emojis will be populated here -->
                                        </div>
                                        <div class="mt-4 text-center">
                                            <button onclick="closeEmojiPicker()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg">
                                                ปิด
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Add Item Button -->
                                <div>
                                    <button type="button" id="add-item-btn"
                                            class="w-full bg-green-500 hover:bg-green-600 text-white py-4 px-6 rounded-lg font-semibold text-lg mobile-button-touch transition-all duration-200 hover:shadow-lg transform hover:scale-105">
                                        ➕ เพิ่มรายการสินค้า
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Custom Tag Input -->
                            <div id="custom-tag-input" class="mt-2 hidden">
                                <div class="flex gap-2">
                                    <input type="text" id="new-tag" placeholder="พิมพ์แท็กใหม่..."
                                           class="flex-1 border border-purple-300 rounded-lg p-2 focus:ring-2 focus:ring-purple-400">
                                    <button type="button" onclick="addCustomTag()"
                                            class="btn-animate bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg">
                                        เพิ่มแท็ก
                                    </button>
                                    <button type="button" onclick="cancelAddTag()"
                                            class="btn-animate bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg">
                                        ยกเลิก
                                    </button>
                                </div>
                                <div class="text-xs text-purple-600 mt-1">💡 กด Enter เพื่อเพิ่มแท็กใหม่</div>
                            </div>
                        </div>

                        <!-- Total Display -->
                        <div class="mt-4 pt-4 border-t">
                            <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-4">
                                <div class="flex flex-wrap gap-2">
                                    <span class="font-semibold text-gray-700">จำนวนรายการ: <span id="total-items" class="text-blue-600">0</span></span>
                                    <button type="button" onclick="clearAllItems()" 
                                            class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm font-semibold transition-all duration-200 hover:shadow-lg">
                                        🗑️ ล้างทั้งหมด
                                    </button>
                                    <button type="button" onclick="showItemsSummary()" 
                                            class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-semibold transition-all duration-200 hover:shadow-lg">
                                        📋 สรุปรายการ
                                    </button>
                                    <button type="button" onclick="showTagFilter()" 
                                            class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg text-sm font-semibold transition-all duration-200 hover:shadow-lg">
                                        🏷️ กรองแท็ก
                                    </button>
                                </div>
                                <div class="bg-green-50 border border-green-200 rounded-lg px-6 py-3">
                                    <span class="font-bold text-lg text-green-800">ยอดรวม: <span id="total-amount" class="text-green-600">0.00</span> บาท</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Vendor Section (for expense transactions) -->
                <div id="vendor-section" class="hidden">
                    <label class="block font-semibold mb-2">🏪 ร้านค้า</label>
                    <div class="flex gap-2">
                        <select id="vendor-select" name="vendor" 
                                class="flex-1 border rounded-lg p-3 focus:ring-2 focus:ring-blue-400 focus:border-transparent">
                            <option value="">--เลือกร้านค้า--</option>
                            <option value="ร้านยายจ่อย">ร้านยายจ่อย</option>
                            <option value="ร้านผัก">ร้านผัก</option>
                            <option value="เจ้นัน">เจ้นัน</option>
                            <option value="7-Eleven">7-Eleven</option>
                            <option value="เงินสด">เงินสด</option>
<option value="none">ไม่เลือก</option>
                        </select>
                        <button type="button" id="add-vendor-btn"
                                class="btn-animate bg-green-500 hover:bg-green-600 text-white px-3 py-2 rounded-lg text-sm">
                            ➕ เพิ่ม
                        </button>
                    </div>
                    <!-- Custom vendor input -->
                    <div id="custom-vendor-input" class="mt-2 hidden">
                        <input type="text" id="new-vendor" placeholder="พิมพ์ชื่อร้านค้าใหม่..."
                               class="w-full border border-green-300 rounded-lg p-2 focus:ring-2 focus:ring-green-400">
                        <div class="text-xs text-green-600 mt-1">💡 กด Enter เพื่อเพิ่มร้านค้าใหม่</div>
                    </div>
                </div>

                <!-- Hidden inputs for form submission -->
                <input type="hidden" id="items-data" name="items_data">
                <input type="hidden" id="calculated-total" name="amount">
                <input type="hidden" id="description" name="description">

                <!-- Submit Button -->
                <div class="flex justify-center lg:justify-end pt-4">
                    <button type="submit" 
                            class="btn-animate bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white px-8 py-3 rounded-full font-semibold shadow-lg">
                        <span class="text-xl mr-2">💾</span>
                        บันทึก
                    </button>
                </div>
            </form>
        </div>

        <!-- Month Selection and Export -->
        <div class="bg-white p-4 lg:p-6 rounded-lg shadow-md mb-6">
            <div class="p-4 lg:p-6 border-b">
                <h2 class="text-lg lg:text-xl font-semibold text-gray-800 mb-2">📅 เลือกเดือนที่ต้องการดู</h2>
                <p class="text-sm text-gray-600">เลือกเดือนเพื่อดูข้อมูลรายรับ-รายจ่าย</p>
            </div>
            <div class="p-4 lg:p-6">
                <div class="flex flex-col lg:flex-row items-start lg:items-center gap-4 mb-6">
                    <div class="flex items-center gap-3">
                        <label class="font-semibold text-gray-700">📅 เดือน:</label>
                        <select id="month-select" class="border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white" onchange="changeMonth(this.value)">
                            {% for month in available_months %}
                                <option value="{{ month.month }}" {% if month.month == selected_month %}selected{% endif %}>
                                    {{ month.display }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="bg-gray-50 border border-gray-200 rounded-lg px-4 py-2">
                        <div class="text-sm text-gray-700">
                            <span class="font-medium">📊 สถานะ:</span> แสดงข้อมูล รายรับ-รายจ่าย ประจำเดือน 
                            <span class="font-bold text-gray-900">{{ selected_month.split('-')[1] }}/{{ selected_month.split('-')[0] }}</span>
                            <span class="text-gray-600">({{ total_records }} รายการ)</span>
                        </div>
                    </div>
                </div>
            
            <!-- Export Buttons -->
            <div class="border-t pt-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">📊 ส่งออกข้อมูล</h3>
                <div class="flex flex-wrap gap-2">
                    <button onclick="exportData('all', '{{ selected_month }}')" 
                            class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium">
                        📄 ส่งออกทั้งหมด
                    </button>
                    <button onclick="exportData('income', '{{ selected_month }}')" 
                            class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-medium">
                        💰 ส่งออกรายรับ
                    </button>
                    <button onclick="exportData('expense', '{{ selected_month }}')" 
                            class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm font-medium">
                        💸 ส่งออกรายจ่าย
                    </button>
                    <button onclick="showMonthlySummary()" 
                            class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg text-sm font-medium">
                        📋 สรุปประจำเดือน
                    </button>
                    <button onclick="showYearlyView()" 
                            class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-lg text-sm font-medium">
                        📅 ดูรายปี
                    </button>
                    <button onclick="exportYearData('{{ selected_month.split('-')[0] }}')" 
                            class="bg-indigo-500 hover:bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-medium">
                        📊 ส่งออกรายปี
                    </button>
                </div>
            </div>
        </div>

        <!-- Summary Cards -->
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-4 mb-6">
            <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200">
                <div class="flex items-center justify-between mb-2">
                    <div class="text-green-600 text-xl">💰</div>
                    <div class="text-gray-600 text-sm">รายรับ</div>
                </div>
                <div class="text-green-700 font-bold text-xl mb-1">{{ "%.2f"|format(monthly_total_income) }}</div>
                <div class="text-gray-500 text-sm">บาท</div>
            </div>
            <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200">
                <div class="flex items-center justify-between mb-2">
                    <div class="text-red-600 text-xl">💸</div>
                    <div class="text-gray-600 text-sm">รายจ่าย</div>
                </div>
                <div class="text-red-700 font-bold text-xl mb-1">{{ "%.2f"|format(monthly_total_expense) }}</div>
                <div class="text-gray-500 text-sm">บาท</div>
            </div>
            <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200">
                <div class="flex items-center justify-between mb-2">
                    <div class="text-blue-600 text-xl">📊</div>
                    <div class="text-gray-600 text-sm">คงเหลือ</div>
                </div>
                <div class="text-blue-700 font-bold text-xl mb-1">{{ "%.2f"|format(monthly_total_income - monthly_total_expense) }}</div>
                <div class="text-gray-500 text-sm">บาท</div>
            </div>
            <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200">
                <div class="flex items-center justify-between mb-2">
                    <div class="text-gray-600 text-xl">📝</div>
                    <div class="text-gray-600 text-sm">รายการ</div>
                </div>
                <div class="text-gray-700 font-bold text-xl mb-1">{{ total_records }}</div>
                <div class="text-gray-500 text-sm">รายการ</div>
            </div>
        </div>

        <!-- Records Table -->
        <div class="bg-white rounded-lg shadow-md overflow-hidden">
            <div class="p-4 lg:p-6 border-b">
                <h2 class="text-lg lg:text-xl font-semibold text-gray-800">📊 รายการทั้งหมด</h2>
                <p class="text-sm text-gray-600 mt-1">แสดงรายการรายรับ-รายจ่ายทั้งหมดในเดือนที่เลือก</p>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full border-collapse">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700 border-b border-gray-200">📅 วันที่</th>
                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700 border-b border-gray-200">📝 รายละเอียด</th>
                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700 border-b border-gray-200">💰 จำนวน (บาท)</th>
                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700 border-b border-gray-200">🏪 ร้านค้า</th>
                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700 border-b border-gray-200">🏷️ ประเภท</th>
                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700 border-b border-gray-200">⚙️ จัดการ</th>
                        </tr>
                    </thead>
                    <tbody id="records-tbody">
                        {% if records %}
                            {% for record in records %}
                                <tr class="border-b border-gray-100 hover:bg-gray-50 transition-colors duration-200">
                                    <td class="px-4 py-4 text-sm text-gray-700 font-medium">
                                        <div class="flex items-center gap-2">
                                            <span class="text-gray-400">📅</span>
                                            {{ record.date }}
                                        </div>
                                    </td>
                                    <td class="px-4 py-4 text-sm text-gray-800">
                                        <div class="max-w-xs truncate" title="{{ record.description }}">
                                            {{ record.description }}
                                        </div>
                                    </td>
                                    <td class="px-4 py-4 text-sm font-bold {% if record.category == 'income' %}text-green-600{% else %}text-red-600{% endif %}">
                                        <div class="flex items-center gap-1">
                                            <span>{% if record.category == 'income' %}💰{% else %}💸{% endif %}</span>
                                            {{ "%.2f"|format(record.amount) }}
                                        </div>
                                    </td>
                                    <td class="px-4 py-4 text-sm text-gray-600">
                                        <div class="flex items-center gap-1">
                                            <span class="text-gray-400">🏪</span>
                                            {{ record.vendor or '-' }}
                                        </div>
                                    </td>
                                    <td class="px-4 py-4 text-sm">
                                        <span class="px-3 py-1 rounded-full text-xs font-medium {% if record.category == 'income' %}bg-green-100 text-green-700 border border-green-200{% else %}bg-red-100 text-red-700 border border-red-200{% endif %}">
                                            {% if record.category == 'income' %}💰 รายรับ{% else %}💸 รายจ่าย{% endif %}
                                        </span>
                                    </td>
                                    <td class="px-4 py-4 text-sm">
                                        <div class="flex gap-2">
                                            <a href="/edit-income-expense/{{ record.id }}" 
                                               class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded-lg text-xs font-medium transition-all duration-200 hover:shadow-md">
                                                ✏️ แก้ไข
                                            </a>
                                            <form method="POST" action="/delete-income-expense/{{ record.id }}" 
                                                  class="inline" onsubmit="return confirm('ต้องการลบรายการนี้หรือไม่?')">
                                                <button type="submit" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded-lg text-xs font-medium transition-all duration-200 hover:shadow-md">
                                                    🗑️ ลบ
                                                </button>
                                            </form>
                                        </div>
                                    </td>
                                </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="6" class="px-4 py-12 text-center">
                                    <div class="flex flex-col items-center justify-center">
                                        <div class="text-6xl mb-4 text-gray-300">📭</div>
                                        <div class="text-lg font-medium text-gray-500 mb-2">ไม่มีข้อมูลในเดือนนี้</div>
                                        <div class="text-sm text-gray-400">ลองเพิ่มรายการใหม่หรือเลือกเดือนอื่น</div>
                                        <div class="mt-4 flex gap-2">
                                            <button onclick="document.getElementById('transaction-type').focus()" 
                                                    class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-all duration-200">
                                                ➕ เพิ่มรายการใหม่
                                            </button>
                                            <button onclick="document.getElementById('month-select').focus()" 
                                                    class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-all duration-200">
                                                📅 เลือกเดือนอื่น
                                            </button>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
            
            <!-- Table Footer -->
            {% if records %}
            <div class="p-4 lg:p-6 border-t bg-gray-50">
                <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-4">
                    <div class="text-sm text-gray-600">
                        แสดง {{ records|length }} รายการ จากทั้งหมด {{ total_records }} รายการ
                    </div>
                    <div class="flex gap-2">
                        <button onclick="exportData('all', '{{ selected_month }}')" 
                                class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium">
                            📄 ส่งออกทั้งหมด
                        </button>
                        <button onclick="showMonthlySummary()" 
                                class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg text-sm font-medium">
                            📋 สรุปข้อมูล
                        </button>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <script>
        // Application State
        let selectedItems = [];
        let itemCounter = 0;
        let availableTags = [
            'อาหาร', 'เครื่องดื่ม', 'ของใช้', 'ยา', 'ขนม', 
            'ผลไม้', 'ผัก', 'เนื้อสัตว์', 'นม', 'ขนมปัง'
        ];
        
        // Emoji data
        const emojiData = {
            'อาหาร': ['🍽️', '🍜', '🍕', '🍔', '🍟', '🌮', '🌯', '🥪', '🍱', '🍛'],
            'เครื่องดื่ม': ['🥤', '☕', '🧃', '🍺', '🍷', '🥛', '🧋', '🍹', '🥤', '💧'],
            'ของใช้': ['🛍️', '🧴', '🧻', '🧽', '👕', '👖', '👟', '👜', '💄', '🪞'],
            'ยา': ['💊', '🏥', '🩺', '🩹', '🩻', '💉', '🩸', '🧬', '🔬', '📋'],
            'ขนม': ['🍪', '🍩', '🍰', '🧁', '🍦', '🍨', '🍭', '🍫', '🍬', '🍡'],
            'ผลไม้': ['🍎', '🍌', '🍊', '🍇', '🍓', '🍑', '🥭', '🍍', '🥥', '🥝'],
            'ผัก': ['🥬', '🥕', '🥦', '🥒', '🍅', '🌽', '🥑', '🥒', '🧅', '🧄'],
            'เนื้อสัตว์': ['🥩', '🍗', '🍖', '🥓', '🍖', '🐟', '🦐', '🦑', '🦞', '🦀'],
            'นม': ['🥛', '🧀', '🍦', '🍨', '🥛', '🧈', '🥛', '🍼', '🥛', '🥛'],
            'ขนมปัง': ['🍞', '🥖', '🥨', '🥯', '🥐', '🥪', '🍞', '🥖', '🥨', '🥯']
        };
        
        // Default emoji for each tag
        const defaultEmojis = {
            'อาหาร': '🍽️',
            'เครื่องดื่ม': '🥤',
            'ของใช้': '🛍️',
            'ยา': '💊',
            'ขนม': '🍪',
            'ผลไม้': '🍎',
            'ผัก': '🥬',
            'เนื้อสัตว์': '🥩',
            'นม': '🥛',
            'ขนมปัง': '🍞'
        };
        
        // Category data structure
        const categoryData = {
            income: {
                '💰 เงินเดือน': ['💼 เงินเดือนประจำ', '🎯 โบนัส', '📈 เงินเพิ่ม'],
                '💼 งานพิเศษ': ['🖥️ งานออนไลน์', '✍️ งานเขียน', '🎨 งานออกแบบ'],
                '🎁 ของขวัญ': ['🎂 วันเกิด', '💝 วันคริสต์มาส', '🎊 วันปีใหม่'],
                '🏦 ดอกเบี้ย': ['💰 เงินฝาก', '📊 เงินลงทุน', '🏠 เงินกู้'],
                '📈 เงินลงทุน': ['📊 หุ้น', '🏠 อสังหาริมทรัพย์', '💰 คริปโต'],
                '🔄 เงินคืน': ['🛒 เงินคืนสินค้า', '💳 เงินคืนบัตร', '🏦 เงินคืนธนาคาร']
            },
            expense: {
                '🍽️ อาหาร': ['🍚 อาหารหลัก', '🍜 ก๋วยเตี๋ยว', '🍕 อาหารฟาสต์ฟู้ด', '☕ เครื่องดื่ม'],
                '🛍️ ของใช้': ['🧴 สบู่/แชมพู', '🧻 กระดาษชำระ', '🧽 ของใช้ในบ้าน', '👕 เสื้อผ้า'],
                '🥤 เครื่องดื่ม': ['☕ กาแฟ', '🥤 น้ำอัดลม', '🧃 น้ำผลไม้', '🍺 เครื่องดื่มแอลกอฮอล์'],
                '🚗 ค่าเดินทาง': ['⛽ น้ำมัน', '🚌 รถเมล์', '🚕 แท็กซี่', '🚇 รถไฟฟ้า'],
                '💊 ยา': ['💊 ยารักษาโรค', '💊 ยาเสริม', '🏥 ค่าหมอ', '💊 ยาแก้ปวด'],
                '🎮 ความบันเทิง': ['🎬 ดูหนัง', '🎮 เล่นเกม', '🎵 ฟังเพลง', '📚 อ่านหนังสือ']
            }
        };
        
        // DOM Elements
        const mobileMenuBtn = document.getElementById('mobile-menu-btn');
        const mobileMenu = document.getElementById('mobile-menu');
        const transactionTypeSelect = document.getElementById('transaction-type');
        const mainCategorySelect = document.getElementById('main-category');
        const subCategorySelect = document.getElementById('sub-category');
        const incomeAmountSection = document.getElementById('income-amount-section');
        const itemsSection = document.getElementById('items-section');
        const vendorSection = document.getElementById('vendor-section');
        const selectedItemsDiv = document.getElementById('selected-items');
        const totalItemsSpan = document.getElementById('total-items');
        const totalAmountSpan = document.getElementById('total-amount');

        // Mobile Menu Toggle
        mobileMenuBtn.addEventListener('click', () => {
            mobileMenu.classList.toggle('hidden');
        });

        // Close mobile menu when clicking outside
        document.addEventListener('click', (e) => {
            if (!mobileMenuBtn.contains(e.target) && !mobileMenu.contains(e.target)) {
                mobileMenu.classList.add('hidden');
            }
        });

        // Transaction Type Change Handler
        transactionTypeSelect.addEventListener('change', function() {
            const type = this.value;
            
            // Clear category options
            mainCategorySelect.innerHTML = '<option value="">--เลือกประเภทหลัก--</option>';
            subCategorySelect.innerHTML = '<option value="">--เลือกประเภทย่อย--</option>';
            updateCategoryDisplay();
            
            if (type === 'income') {
                // Show income amount section, hide items and vendor sections
                incomeAmountSection.classList.remove('hidden');
                itemsSection.classList.add('hidden');
                vendorSection.classList.add('hidden');
                
                // Add income main categories
                Object.keys(categoryData.income).forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    mainCategorySelect.appendChild(option);
                });
                
            } else if (type === 'expense') {
                // Show items and vendor sections, hide income amount section
                incomeAmountSection.classList.add('hidden');
                itemsSection.classList.remove('hidden');
                vendorSection.classList.remove('hidden');
                
                // Add expense main categories
                Object.keys(categoryData.expense).forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    mainCategorySelect.appendChild(option);
                });
            } else {
                // Hide all conditional sections
                incomeAmountSection.classList.add('hidden');
                itemsSection.classList.add('hidden');
                vendorSection.classList.add('hidden');
            }
        });

        // Main Category Change Handler
        mainCategorySelect.addEventListener('change', function() {
            const mainCategory = this.value;
            const transactionType = transactionTypeSelect.value;
            
            // Clear sub category options
            subCategorySelect.innerHTML = '<option value="">--เลือกประเภทย่อย--</option>';
            
            if (mainCategory && transactionType) {
                const subCategories = categoryData[transactionType][mainCategory] || [];
                subCategories.forEach(subCategory => {
                    const option = document.createElement('option');
                    option.value = subCategory;
                    option.textContent = subCategory;
                    subCategorySelect.appendChild(option);
                });
            }
            
            updateCategoryDisplay();
        });

        // Sub Category Change Handler
        subCategorySelect.addEventListener('change', function() {
            updateCategoryDisplay();
        });

        // Update Category Display Function
        function updateCategoryDisplay() {
            const mainCategory = mainCategorySelect.value;
            const subCategory = subCategorySelect.value;
            
            document.getElementById('selected-main-category').textContent = mainCategory || '-';
            document.getElementById('selected-sub-category').textContent = subCategory || '-';
            
            // Update combined category for form submission
            const combinedCategory = mainCategory && subCategory ? `${mainCategory} > ${subCategory}` : '';
            document.getElementById('combined-category').value = combinedCategory;
        }

        // Add Item Function
        document.getElementById('add-item-btn').addEventListener('click', function() {
            addNewItem();
        });

                // Add New Item Function
        function addNewItem() {
            const name = document.getElementById('item-name').value.trim();
            const price = parseFloat(document.getElementById('item-price').value) || 0;
            const quantity = parseInt(document.getElementById('item-quantity').value) || 1;
            const tag = document.getElementById('item-tag').value;
            const emojiBtn = document.getElementById('emoji-picker-btn');
            const emoji = emojiBtn.textContent;
            
            if (!name) {
                alert('กรุณากรอกชื่อสินค้า');
                document.getElementById('item-name').focus();
                return;
            }

            if (price <= 0) {
                alert('กรุณากรอกราคาที่มากกว่า 0');
                document.getElementById('item-price').focus();
                return;
            }
            
            const item = {
                id: ++itemCounter,
                name: name,
                tag: tag,
                emoji: emoji,
                price: price,
                quantity: quantity,
                total: price * quantity
            };
            
            selectedItems.push(item);
            updateItemsDisplay();
            
            // Clear inputs
            document.getElementById('item-name').value = '';
            document.getElementById('item-price').value = '';
            document.getElementById('item-quantity').value = '1';
            document.getElementById('item-tag').value = '';
            emojiBtn.textContent = '😊';
            
            // Focus back to item name for next entry
            document.getElementById('item-name').focus();
            
            // Show success feedback
            const addBtn = document.getElementById('add-item-btn');
            const originalText = addBtn.innerHTML;
            addBtn.innerHTML = '✅ เพิ่มแล้ว';
            addBtn.classList.add('bg-green-600');
            setTimeout(() => {
                addBtn.innerHTML = originalText;
                addBtn.classList.remove('bg-green-600');
            }, 1000);
        }

        // Enter key handler for item inputs
        document.getElementById('item-name').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                document.getElementById('item-price').focus();
            }
        });

        document.getElementById('item-price').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                document.getElementById('item-quantity').focus();
            }
        });

        document.getElementById('item-quantity').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                addNewItem();
            }
        });

        // Update Items Display
        function updateItemsDisplay() {
            if (selectedItems.length === 0) {
                selectedItemsDiv.innerHTML = '<div class="text-gray-500 text-center py-4">ยังไม่มีรายการสินค้า</div>';
                totalItemsSpan.textContent = '0';
                totalAmountSpan.textContent = '0.00';
                return;
            }
            
            let totalAmount = 0;
            
            // Check if mobile view
            const isMobile = window.innerWidth <= 768;
            
            if (isMobile) {
                // Mobile card view - easier to edit on mobile
                let html = '<div class="space-y-3">';
                
                selectedItems.forEach((item, index) => {
                    totalAmount += item.total;
                    html += `
                        <div class="bg-white border rounded-lg p-4 shadow-sm">
                            <!-- Item Header -->
                            <div class="flex items-center justify-between mb-3">
                                <div class="flex items-center gap-2">
                                    <div class="w-6 h-6 bg-blue-500 text-white rounded-full flex items-center justify-center text-xs font-bold">
                                        ${index + 1}
                                    </div>
                                    <span class="text-lg">${item.emoji || '😊'}</span>
                                    <span class="font-medium text-gray-800">${item.name}</span>
                                </div>
                                <div class="flex gap-1">
                                    <button onclick="moveItemUp(${item.id})" 
                                            class="text-gray-500 hover:text-blue-600 p-1 ${index === 0 ? 'opacity-50 cursor-not-allowed' : ''}" 
                                            title="เลื่อนขึ้น" ${index === 0 ? 'disabled' : ''}>
                                        ⬆️
                                    </button>
                                    <button onclick="moveItemDown(${item.id})" 
                                            class="text-gray-500 hover:text-blue-600 p-1 ${index === selectedItems.length - 1 ? 'opacity-50 cursor-not-allowed' : ''}" 
                                            title="เลื่อนลง" ${index === selectedItems.length - 1 ? 'disabled' : ''}>
                                        ⬇️
                                    </button>
                                </div>
                            </div>
                            
                                                            <!-- Item Name -->
                                <div class="mb-3">
                                    <label class="block text-xs font-medium text-gray-700 mb-1">📝 ชื่อสินค้า</label>
                                    <input type="text" value="${item.name}" 
                                           onchange="updateItemName(${item.id}, this.value)"
                                           class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent mobile-input-touch">
                                </div>
                            
                            <!-- Price and Quantity Row -->
                            <div class="grid grid-cols-2 gap-3 mb-3">
                                <div>
                                    <label class="block text-xs font-medium text-gray-700 mb-1">💰 ราคา (บาท)</label>
                                    <div class="flex items-center gap-1">
                                                                            <button onclick="decreasePrice(${item.id})" 
                                            class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-sm mobile-button-touch">-</button>
                                        <input type="number" value="${item.price}" step="0.01" min="0"
                                               onchange="updateItemPrice(${item.id}, this.value)"
                                               class="flex-1 border border-gray-300 rounded-lg p-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent mobile-input-touch">
                                        <button onclick="increasePrice(${item.id})" 
                                                class="bg-green-500 hover:bg-green-600 text-white px-2 py-1 rounded text-sm mobile-button-touch">+</button>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-700 mb-1">📊 จำนวน</label>
                                    <div class="flex items-center gap-1">
                                                                            <button onclick="decreaseQuantity(${item.id})" 
                                            class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-sm mobile-button-touch">-</button>
                                        <input type="number" value="${item.quantity}" min="1"
                                               onchange="updateItemQuantity(${item.id}, this.value)"
                                               class="flex-1 border border-gray-300 rounded-lg p-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent mobile-input-touch">
                                        <button onclick="increaseQuantity(${item.id})" 
                                                class="bg-green-500 hover:bg-green-600 text-white px-2 py-1 rounded text-sm mobile-button-touch">+</button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Tag Selection -->
                            <div class="mb-3">
                                <label class="block text-xs font-medium text-gray-700 mb-1">🏷️ แท็ก</label>
                                <select onchange="updateItemTag(${item.id}, this.value)" 
                                        class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent mobile-input-touch">
                                    <option value="">--เลือกแท็ก--</option>
                                    <option value="อาหาร" ${item.tag === 'อาหาร' ? 'selected' : ''}>🍽️ อาหาร</option>
                                    <option value="เครื่องดื่ม" ${item.tag === 'เครื่องดื่ม' ? 'selected' : ''}>🥤 เครื่องดื่ม</option>
                                    <option value="ของใช้" ${item.tag === 'ของใช้' ? 'selected' : ''}>🛍️ ของใช้</option>
                                    <option value="ยา" ${item.tag === 'ยา' ? 'selected' : ''}>💊 ยา</option>
                                    <option value="ขนม" ${item.tag === 'ขนม' ? 'selected' : ''}>🍪 ขนม</option>
                                    <option value="ผลไม้" ${item.tag === 'ผลไม้' ? 'selected' : ''}>🍎 ผลไม้</option>
                                    <option value="ผัก" ${item.tag === 'ผัก' ? 'selected' : ''}>🥬 ผัก</option>
                                    <option value="เนื้อสัตว์" ${item.tag === 'เนื้อสัตว์' ? 'selected' : ''}>🥩 เนื้อสัตว์</option>
                                    <option value="นม" ${item.tag === 'นม' ? 'selected' : ''}>🥛 นม</option>
                                    <option value="ขนมปัง" ${item.tag === 'ขนมปัง' ? 'selected' : ''}>🍞 ขนมปัง</option>
                                </select>
                            </div>
                            
                            <!-- Item Total and Actions -->
                            <div class="flex items-center justify-between pt-2 border-t">
                                <div class="text-sm">
                                    <span class="text-gray-600">รวม:</span>
                                    <span class="font-bold text-green-600 ml-1">${item.total.toFixed(2)} บาท</span>
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="duplicateItem(${item.id})" 
                                            class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm mobile-button-touch" title="คัดลอก">
                                        📋 คัดลอก
                                    </button>
                                    <button onclick="removeItem(${item.id})" 
                                            class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm mobile-button-touch" title="ลบรายการ">
                                        🗑️ ลบ
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                // Add total summary
                html += `
                    <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                        <div class="flex justify-between items-center">
                            <span class="font-semibold text-green-800">ยอดรวมทั้งหมด:</span>
                            <span class="font-bold text-green-600 text-lg">${totalAmount.toFixed(2)} บาท</span>
                        </div>
                    </div>
                </div>
                `;
                
                selectedItemsDiv.innerHTML = html;
            } else {
                // Desktop table view
                let html = `
                    <div class="overflow-x-auto">
                        <table class="items-table w-full border-collapse border border-gray-300">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="border border-gray-300 px-4 py-3 text-left text-sm font-semibold text-gray-700">ลำดับ</th>
                                    <th class="border border-gray-300 px-4 py-3 text-left text-sm font-semibold text-gray-700">ชื่อสินค้า</th>
                                    <th class="border border-gray-300 px-4 py-3 text-left text-sm font-semibold text-gray-700">แท็ก</th>
                                    <th class="border border-gray-300 px-4 py-3 text-left text-sm font-semibold text-gray-700">ราคา (บาท)</th>
                                    <th class="border border-gray-300 px-4 py-3 text-left text-sm font-semibold text-gray-700">จำนวน</th>
                                    <th class="border border-gray-300 px-4 py-3 text-left text-sm font-semibold text-gray-700">รวม (บาท)</th>
                                    <th class="border border-gray-300 px-4 py-3 text-left text-sm font-semibold text-gray-700">จัดการ</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                selectedItems.forEach((item, index) => {
                    totalAmount += item.total;
                    html += `
                        <tr class="hover:bg-gray-50">
                            <td class="border border-gray-300 px-4 py-3 text-center">
                                <div class="flex flex-col items-center gap-2">
                                    <div class="w-8 h-8 bg-blue-500 text-white rounded-full flex items-center justify-center text-sm font-bold">
                                        ${index + 1}
                                    </div>
                                    <div class="flex gap-1">
                                        <button onclick="moveItemUp(${item.id})" 
                                                class="text-gray-500 hover:text-blue-600 text-sm px-2 py-1 rounded hover:bg-blue-50 ${index === 0 ? 'opacity-50 cursor-not-allowed' : ''}" 
                                                title="เลื่อนขึ้น" ${index === 0 ? 'disabled' : ''}>
                                            ⬆️
                                        </button>
                                        <button onclick="moveItemDown(${item.id})" 
                                                class="text-gray-500 hover:text-blue-600 text-sm px-2 py-1 rounded hover:bg-blue-50 ${index === selectedItems.length - 1 ? 'opacity-50 cursor-not-allowed' : ''}" 
                                                title="เลื่อนลง" ${index === selectedItems.length - 1 ? 'disabled' : ''}>
                                            ⬇️
                                        </button>
                                    </div>
                                </div>
                            </td>
                            <td class="border border-gray-300 px-4 py-3">
                                <input type="text" value="${item.name}" 
                                       onchange="updateItemName(${item.id}, this.value)"
                                       class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </td>
                            <td class="border border-gray-300 px-4 py-3">
                                <div class="flex items-center gap-3">
                                    <span class="text-2xl">${item.emoji || '😊'}</span>
                                    <select onchange="updateItemTag(${item.id}, this.value)" 
                                            class="flex-1 border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                        <option value="">--เลือกแท็ก--</option>
                                        <option value="อาหาร" ${item.tag === 'อาหาร' ? 'selected' : ''}>🍽️ อาหาร</option>
                                        <option value="เครื่องดื่ม" ${item.tag === 'เครื่องดื่ม' ? 'selected' : ''}>🥤 เครื่องดื่ม</option>
                                        <option value="ของใช้" ${item.tag === 'ของใช้' ? 'selected' : ''}>🛍️ ของใช้</option>
                                        <option value="ยา" ${item.tag === 'ยา' ? 'selected' : ''}>💊 ยา</option>
                                        <option value="ขนม" ${item.tag === 'ขนม' ? 'selected' : ''}>🍪 ขนม</option>
                                        <option value="ผลไม้" ${item.tag === 'ผลไม้' ? 'selected' : ''}>🍎 ผลไม้</option>
                                        <option value="ผัก" ${item.tag === 'ผัก' ? 'selected' : ''}>🥬 ผัก</option>
                                        <option value="เนื้อสัตว์" ${item.tag === 'เนื้อสัตว์' ? 'selected' : ''}>🥩 เนื้อสัตว์</option>
                                        <option value="นม" ${item.tag === 'นม' ? 'selected' : ''}>🥛 นม</option>
                                        <option value="ขนมปัง" ${item.tag === 'ขนมปัง' ? 'selected' : ''}>🍞 ขนมปัง</option>
                                    </select>
                                </div>
                            </td>
                            <td class="border border-gray-300 px-4 py-3">
                                <div class="flex items-center gap-2">
                                    <button onclick="decreasePrice(${item.id})" 
                                            class="bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded-lg text-sm font-semibold">-</button>
                                    <input type="number" value="${item.price}" step="0.01" min="0"
                                           onchange="updateItemPrice(${item.id}, this.value)"
                                           class="flex-1 border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <button onclick="increasePrice(${item.id})" 
                                            class="bg-green-500 hover:bg-green-600 text-white px-3 py-2 rounded-lg text-sm font-semibold">+</button>
                                </div>
                            </td>
                            <td class="border border-gray-300 px-4 py-3">
                                <div class="flex items-center gap-2">
                                    <button onclick="decreaseQuantity(${item.id})" 
                                            class="bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded-lg text-sm font-semibold">-</button>
                                    <input type="number" value="${item.quantity}" min="1"
                                           onchange="updateItemQuantity(${item.id}, this.value)"
                                           class="flex-1 border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <button onclick="increaseQuantity(${item.id})" 
                                            class="bg-green-500 hover:bg-green-600 text-white px-3 py-2 rounded-lg text-sm font-semibold">+</button>
                                </div>
                            </td>
                            <td class="border border-gray-300 px-4 py-3 text-center">
                                <div class="text-lg font-bold text-green-600">${item.total.toFixed(2)}</div>
                            </td>
                            <td class="border border-gray-300 px-4 py-3 text-center">
                                <div class="flex gap-2 justify-center">
                                    <button onclick="duplicateItem(${item.id})" 
                                            class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-semibold" title="คัดลอก">
                                        📋 คัดลอก
                                    </button>
                                    <button onclick="removeItem(${item.id})" 
                                            class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm font-semibold" title="ลบรายการ">
                                        🗑️ ลบ
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
                
                // Add total row
                html += `
                            <tr class="bg-green-50">
                                <td colspan="5" class="border border-gray-300 px-4 py-3 text-right font-semibold text-gray-700">ยอดรวมทั้งหมด:</td>
                                <td class="border border-gray-300 px-4 py-3 text-center font-bold text-green-600 text-lg">${totalAmount.toFixed(2)}</td>
                                <td class="border border-gray-300 px-4 py-3"></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                `;
                
                selectedItemsDiv.innerHTML = html;
            }
            
            totalItemsSpan.textContent = selectedItems.length.toString();
            totalAmountSpan.textContent = totalAmount.toFixed(2);
            
            // Update hidden inputs
            document.getElementById('items-data').value = JSON.stringify(selectedItems);
            document.getElementById('calculated-total').value = totalAmount.toFixed(2);
            
            // Create description
            const descriptions = selectedItems.map(item => 
                `${item.name} x${item.quantity}`
            );
            document.getElementById('description').value = descriptions.join(', ');
        }

        // Update Item Name Function
        function updateItemName(itemId, newName) {
            const item = selectedItems.find(item => item.id === itemId);
            if (item && newName.trim()) {
                item.name = newName.trim();
                updateItemsDisplay();
            }
        }

        // Update Item Price Function
        function updateItemPrice(itemId, newPrice) {
            const item = selectedItems.find(item => item.id === itemId);
            const price = parseFloat(newPrice);
            if (item && !isNaN(price) && price >= 0) {
                item.price = price;
                item.total = item.price * item.quantity;
                updateItemsDisplay();
            }
        }

        // Update Item Quantity Function
        function updateItemQuantity(itemId, newQuantity) {
            const item = selectedItems.find(item => item.id === itemId);
            const quantity = parseInt(newQuantity);
            if (item && !isNaN(quantity) && quantity > 0) {
                item.quantity = quantity;
                item.total = item.price * item.quantity;
                updateItemsDisplay();
            }
        }

        // Increase/Decrease Price Functions
        function increasePrice(itemId) {
            const item = selectedItems.find(item => item.id === itemId);
            if (item) {
                item.price += 1;
                item.total = item.price * item.quantity;
                updateItemsDisplay();
            }
        }

        function decreasePrice(itemId) {
            const item = selectedItems.find(item => item.id === itemId);
            if (item && item.price > 0) {
                item.price = Math.max(0, item.price - 1);
                item.total = item.price * item.quantity;
                updateItemsDisplay();
            }
        }

        // Increase/Decrease Quantity Functions
        function increaseQuantity(itemId) {
            const item = selectedItems.find(item => item.id === itemId);
            if (item) {
                item.quantity += 1;
                item.total = item.price * item.quantity;
                updateItemsDisplay();
            }
        }

        function decreaseQuantity(itemId) {
            const item = selectedItems.find(item => item.id === itemId);
            if (item && item.quantity > 1) {
                item.quantity = Math.max(1, item.quantity - 1);
                item.total = item.price * item.quantity;
                updateItemsDisplay();
            }
        }

        // Duplicate Item Function
        function duplicateItem(itemId) {
            const originalItem = selectedItems.find(item => item.id === itemId);
            if (originalItem) {
                const newItem = {
                    id: ++itemCounter,
                    name: originalItem.name + ' (คัดลอก)',
                    tag: originalItem.tag,
                    emoji: originalItem.emoji,
                    price: originalItem.price,
                    quantity: originalItem.quantity,
                    total: originalItem.price * originalItem.quantity
                };
                
                selectedItems.push(newItem);
                updateItemsDisplay();
                
                // Show feedback
                const duplicateBtn = document.querySelector(`[onclick="duplicateItem(${itemId})"]`);
                if (duplicateBtn) {
                    duplicateBtn.style.transform = 'scale(1.2)';
                    setTimeout(() => {
                        duplicateBtn.style.transform = 'scale(1)';
                    }, 200);
                }
            }
        }

        // Remove Item Function
        function removeItem(itemId) {
            if (confirm('ต้องการลบรายการนี้หรือไม่?')) {
                selectedItems = selectedItems.filter(item => item.id !== itemId);
                updateItemsDisplay();
                
                // Show feedback
                const itemElement = document.querySelector(`[onclick="removeItem(${itemId})"]`);
                if (itemElement) {
                    itemElement.style.backgroundColor = '#fef2f2';
                    itemElement.style.borderColor = '#ef4444';
                    setTimeout(() => {
                        itemElement.style.backgroundColor = '';
                        itemElement.style.borderColor = '';
                    }, 300);
                }
            }
        }

        // Clear All Items Function
        function clearAllItems() {
            if (selectedItems.length > 0 && confirm('ต้องการล้างรายการทั้งหมดหรือไม่?')) {
                selectedItems = [];
                updateItemsDisplay();
                alert('ล้างรายการทั้งหมดเรียบร้อยแล้ว');
            }
        }

        // Move Item Up Function
        function moveItemUp(itemId) {
            const index = selectedItems.findIndex(item => item.id === itemId);
            if (index > 0) {
                const temp = selectedItems[index];
                selectedItems[index] = selectedItems[index - 1];
                selectedItems[index - 1] = temp;
                updateItemsDisplay();
            }
        }

        // Move Item Down Function
        function moveItemDown(itemId) {
            const index = selectedItems.findIndex(item => item.id === itemId);
            if (index < selectedItems.length - 1) {
                const temp = selectedItems[index];
                selectedItems[index] = selectedItems[index + 1];
                selectedItems[index + 1] = temp;
                updateItemsDisplay();
            }
        }

        // Show Items Summary Function
        function showItemsSummary() {
            if (selectedItems.length === 0) {
                alert('ไม่มีรายการสินค้าให้แสดงสรุป');
                return;
            }

            let summary = '📋 สรุปรายการสินค้า\n\n';
            let totalAmount = 0;

            selectedItems.forEach((item, index) => {
                summary += `${index + 1}. ${item.emoji || '😊'} ${item.name}`;
                if (item.tag) {
                    summary += ` [${item.tag}]`;
                }
                summary += `\n`;
                summary += `   ราคา: ${item.price.toFixed(2)} บาท × ${item.quantity} = ${item.total.toFixed(2)} บาท\n\n`;
                totalAmount += item.total;
            });

            summary += `💰 ยอดรวมทั้งหมด: ${totalAmount.toFixed(2)} บาท`;
            summary += `\n📊 จำนวนรายการ: ${selectedItems.length} รายการ`;

            alert(summary);
        }

        // Add Tag Button Handler
        document.getElementById('add-tag-btn').addEventListener('click', function() {
            const customInput = document.getElementById('custom-tag-input');
            const newTagInput = document.getElementById('new-tag');
            
            if (customInput.classList.contains('hidden')) {
                customInput.classList.remove('hidden');
                newTagInput.focus();
            } else {
                addCustomTag();
            }
        });

        // Add Custom Tag Function
        function addCustomTag() {
            const newTagInput = document.getElementById('new-tag');
            const tagName = newTagInput.value.trim();
            
            if (!tagName) {
                alert('กรุณาใส่ชื่อแท็ก');
                return;
            }
            
            if (availableTags.includes(tagName)) {
                alert('แท็กนี้มีอยู่แล้ว');
                return;
            }
            
            // Add to available tags
            availableTags.push(tagName);
            
            // Add to select options
            const tagSelect = document.getElementById('item-tag');
            const option = document.createElement('option');
            option.value = tagName;
            option.textContent = tagName;
            tagSelect.appendChild(option);
            
            // Select the new tag
            tagSelect.value = tagName;
            
            // Hide input and clear
            document.getElementById('custom-tag-input').classList.add('hidden');
            newTagInput.value = '';
            
            alert(`เพิ่มแท็ก "${tagName}" เรียบร้อยแล้ว`);
        }

        // Cancel Add Tag Function
        function cancelAddTag() {
            document.getElementById('custom-tag-input').classList.add('hidden');
            document.getElementById('new-tag').value = '';
        }

        // Update Item Tag Function
        function updateItemTag(itemId, newTag) {
            const item = selectedItems.find(item => item.id === itemId);
            if (item) {
                item.tag = newTag;
                updateItemsDisplay();
            }
        }

        // Enter key handler for custom tag
        document.getElementById('new-tag').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                addCustomTag();
            }
        });

        // Show Emoji Picker Function
        function showEmojiPicker() {
            const modal = document.getElementById('emoji-picker-modal');
            const grid = document.getElementById('emoji-grid');
            const selectedTag = document.getElementById('item-tag').value;
            
            // Clear previous emojis
            grid.innerHTML = '';
            
            if (selectedTag && emojiData[selectedTag]) {
                // Show emojis for selected tag
                emojiData[selectedTag].forEach(emoji => {
                    const button = document.createElement('button');
                    button.className = 'text-2xl p-2 hover:bg-gray-100 rounded';
                    button.textContent = emoji;
                    button.onclick = () => selectEmoji(emoji);
                    grid.appendChild(button);
                });
            } else {
                // Show all emojis
                const allEmojis = [
                    '😀', '😃', '😄', '😁', '😆', '😅', '😂', '🤣', '😊', '😇',
                    '🙂', '🙃', '😉', '😌', '😍', '🥰', '😘', '😗', '😙', '😚',
                    '😋', '😛', '😝', '😜', '🤪', '🤨', '🧐', '🤓', '😎', '🤩',
                    '🥳', '😏', '😒', '😞', '😔', '😟', '😕', '🙁', '☹️', '😣',
                    '😖', '😫', '😩', '🥺', '😢', '😭', '😤', '😠', '😡', '🤬',
                    '🤯', '😳', '🥵', '🥶', '😱', '😨', '😰', '😥', '😓', '🤗',
                    '🤔', '🤭', '🤫', '🤥', '😶', '😐', '😑', '😯', '😦', '😧',
                    '😮', '😲', '🥱', '😴', '🤤', '😪', '😵', '🤐', '🥴', '🤢',
                    '🤮', '🤧', '😷', '🤒', '🤕', '🤑', '🤠', '💩', '🤡', '👹',
                    '👺', '👻', '👽', '👾', '🤖', '😺', '😸', '😹', '😻', '😼',
                    '😽', '🙀', '😿', '😾', '🙈', '🙉', '🙊', '💌', '💘', '💝',
                    '💖', '💗', '💓', '💞', '💕', '💟', '❣️', '💔', '❤️', '🧡',
                    '💛', '💚', '💙', '💜', '🖤', '🤍', '🤎', '💯', '💢', '💥',
                    '💫', '💦', '💨', '🕳️', '💬', '🗨️', '🗯️', '💭', '💤', '👋',
                    '🤚', '🖐️', '✋', '🖖', '👌', '🤌', '🤏', '✌️', '🤞', '🤟',
                    '🤘', '🤙', '👈', '👉', '👆', '🖕', '👇', '☝️', '👍', '👎',
                    '✊', '👊', '🤛', '🤜', '👏', '🙌', '👐', '🤲', '🤝', '🙏',
                    '✍️', '💪', '🦾', '🦿', '🦵', '🦶', '👂', '🦻', '👃', '🧠',
                    '🫀', '🫁', '🦷', '🦴', '👀', '👁️', '👅', '👄', '💋', '🩸',
                    '🍽️', '🍜', '🍕', '🍔', '🍟', '🌮', '🌯', '🥪', '🍱', '🍛',
                    '🥤', '☕', '🧃', '🍺', '🍷', '🥛', '🧋', '🍹', '🥤', '💧',
                    '🛍️', '🧴', '🧻', '🧽', '👕', '👖', '👟', '👜', '💄', '🪞',
                    '💊', '🏥', '🩺', '🩹', '🩻', '💉', '🩸', '🧬', '🔬', '📋',
                    '🍪', '🍩', '🍰', '🧁', '🍦', '🍨', '🍭', '🍫', '🍬', '🍡',
                    '🍎', '🍌', '🍊', '🍇', '🍓', '🍑', '🥭', '🍍', '🥥', '🥝',
                    '🥬', '🥕', '🥦', '🥒', '🍅', '🌽', '🥑', '🥒', '🧅', '🧄',
                    '🥩', '🍗', '🍖', '🥓', '🍖', '🐟', '🦐', '🦑', '🦞', '🦀',
                    '🥛', '🧀', '🍦', '🍨', '🥛', '🧈', '🥛', '🍼', '🥛', '🥛',
                    '🍞', '🥖', '🥨', '🥯', '🥐', '🥪', '🍞', '🥖', '🥨', '🥯'
                ];
                
                allEmojis.forEach(emoji => {
                    const button = document.createElement('button');
                    button.className = 'text-2xl p-2 hover:bg-gray-100 rounded';
                    button.textContent = emoji;
                    button.onclick = () => selectEmoji(emoji);
                    grid.appendChild(button);
                });
            }
            
            modal.classList.remove('hidden');
        }

        // Close Emoji Picker Function
        function closeEmojiPicker() {
            document.getElementById('emoji-picker-modal').classList.add('hidden');
        }

        // Select Emoji Function
        function selectEmoji(emoji) {
            const selectedTag = document.getElementById('item-tag').value;
            const emojiBtn = document.getElementById('emoji-picker-btn');
            
            // Update emoji button
            emojiBtn.textContent = emoji;
            
            // Store selected emoji for the current tag
            if (selectedTag) {
                if (!window.selectedEmojis) {
                    window.selectedEmojis = {};
                }
                window.selectedEmojis[selectedTag] = emoji;
            }
            
            closeEmojiPicker();
        }

        // Update Tag Emoji Function
        function updateTagEmoji() {
            const selectedTag = document.getElementById('item-tag').value;
            const emojiBtn = document.getElementById('emoji-picker-btn');
            
            if (selectedTag) {
                // Use stored emoji or default
                const storedEmoji = window.selectedEmojis && window.selectedEmojis[selectedTag];
                const defaultEmoji = defaultEmojis[selectedTag];
                emojiBtn.textContent = storedEmoji || defaultEmoji || '😊';
            } else {
                emojiBtn.textContent = '😊';
            }
        }

        // Show Tag Filter Function
        function showTagFilter() {
            if (selectedItems.length === 0) {
                alert('ไม่มีรายการสินค้าให้กรอง');
                return;
            }

            // Get unique tags from items
            const itemTags = selectedItems.map(item => item.tag).filter(tag => tag);
            const uniqueTags = [...new Set(itemTags)];

            if (uniqueTags.length === 0) {
                alert('ไม่มีแท็กในรายการสินค้า');
                return;
            }

            let filterOptions = '🏷️ เลือกแท็กที่ต้องการกรอง:\n\n';
            uniqueTags.forEach((tag, index) => {
                const count = selectedItems.filter(item => item.tag === tag).length;
                filterOptions += `${index + 1}. ${tag} (${count} รายการ)\n`;
            });
            filterOptions += '\n0. แสดงทั้งหมด';

            const choice = prompt(filterOptions + '\n\nกรุณาใส่หมายเลขที่ต้องการ:');
            
            if (choice === null) return; // User cancelled
            
            const choiceNum = parseInt(choice);
            if (choiceNum === 0) {
                // Show all items
                updateItemsDisplay();
                alert('แสดงรายการทั้งหมด');
            } else if (choiceNum >= 1 && choiceNum <= uniqueTags.length) {
                // Filter by selected tag
                const selectedTag = uniqueTags[choiceNum - 1];
                const filteredItems = selectedItems.filter(item => item.tag === selectedTag);
                
                if (filteredItems.length > 0) {
                    let summary = `🏷️ รายการสินค้าที่มีแท็ก "${selectedTag}":\n\n`;
                    let totalAmount = 0;

                    filteredItems.forEach((item, index) => {
                        summary += `${index + 1}. ${item.emoji || '😊'} ${item.name}\n`;
                        summary += `   ราคา: ${item.price.toFixed(2)} บาท × ${item.quantity} = ${item.total.toFixed(2)} บาท\n\n`;
                        totalAmount += item.total;
                    });

                    summary += `💰 ยอดรวม: ${totalAmount.toFixed(2)} บาท`;
                    summary += `\n📊 จำนวนรายการ: ${filteredItems.length} รายการ`;

                    alert(summary);
                }
            } else {
                alert('กรุณาเลือกหมายเลขที่ถูกต้อง');
            }
        }

        // Form Submit Handler
        document.getElementById('transaction-form').addEventListener('submit', function(e) {
            const transactionType = transactionTypeSelect.value;
            const mainCategory = mainCategorySelect.value;
            const subCategory = subCategorySelect.value;
            
            if (!transactionType) {
                e.preventDefault();
                alert('กรุณาเลือกประเภทรายการ');
                return;
            }
            
            if (!mainCategory) {
                e.preventDefault();
                alert('กรุณาเลือกประเภทหลัก');
                return;
            }
            
            if (!subCategory) {
                e.preventDefault();
                alert('กรุณาเลือกประเภทย่อย');
                return;
            }
            
            if (transactionType === 'income') {
                const incomeAmount = parseFloat(document.getElementById('income-amount').value) || 0;
                if (incomeAmount <= 0) {
                    e.preventDefault();
                    alert('กรุณากรอกจำนวนเงินสำหรับรายรับ');
                    return;
                }
                
                // Set values for income
                document.getElementById('calculated-total').value = incomeAmount.toFixed(2);
                document.getElementById('description').value = `รายรับ: ${mainCategory} > ${subCategory}`;
                document.getElementById('items-data').value = '';
                
            } else if (transactionType === 'expense') {
                if (selectedItems.length === 0) {
                    e.preventDefault();
                    alert('กรุณาเพิ่มรายการสินค้าอย่างน้อย 1 รายการ');
                    return;
                }
                
                const vendor = document.getElementById('vendor-select').value;
                if (!vendor) {
                    e.preventDefault();
                    alert('กรุณาเลือกร้านค้า');
                    return;
                }
            }
        });

        // Add Main Category Button Handler
        document.getElementById('add-main-category-btn').addEventListener('click', function() {
            const customInput = document.getElementById('custom-main-category-input');
            const newCategoryInput = document.getElementById('new-main-category');
            
            if (customInput.classList.contains('hidden')) {
                customInput.classList.remove('hidden');
                newCategoryInput.focus();
            } else {
                addCustomMainCategory();
            }
        });

        // Add Custom Main Category Function
        function addCustomMainCategory() {
            const newCategoryInput = document.getElementById('new-main-category');
            const categoryName = newCategoryInput.value.trim();
            const transactionType = transactionTypeSelect.value;
            
            if (!categoryName) {
                alert('กรุณาใส่ชื่อประเภทหลัก');
                return;
            }
            
            if (!transactionType) {
                alert('กรุณาเลือกประเภทรายการก่อน');
                return;
            }
            
            // Add to category data structure
            if (!categoryData[transactionType][categoryName]) {
                categoryData[transactionType][categoryName] = [];
            }
            
            // Add to select options
            const option = document.createElement('option');
            option.value = categoryName;
            option.textContent = categoryName;
            mainCategorySelect.appendChild(option);
            
            // Select the new category
            mainCategorySelect.value = categoryName;
            
            // Hide input and clear
            document.getElementById('custom-main-category-input').classList.add('hidden');
            newCategoryInput.value = '';
            
            // Clear sub categories
            subCategorySelect.innerHTML = '<option value="">--เลือกประเภทย่อย--</option>';
            updateCategoryDisplay();
            
            alert(`เพิ่มประเภทหลัก "${categoryName}" เรียบร้อยแล้ว`);
        }

        // Enter key handler for custom main category
        document.getElementById('new-main-category').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                addCustomMainCategory();
            }
        });

        // Add Sub Category Button Handler
        document.getElementById('add-sub-category-btn').addEventListener('click', function() {
            const customInput = document.getElementById('custom-sub-category-input');
            const newCategoryInput = document.getElementById('new-sub-category');
            
            if (customInput.classList.contains('hidden')) {
                customInput.classList.remove('hidden');
                newCategoryInput.focus();
            } else {
                addCustomSubCategory();
            }
        });

        // Add Custom Sub Category Function
        function addCustomSubCategory() {
            const newCategoryInput = document.getElementById('new-sub-category');
            const subCategoryName = newCategoryInput.value.trim();
            const mainCategory = mainCategorySelect.value;
            const transactionType = transactionTypeSelect.value;
            
            if (!subCategoryName) {
                alert('กรุณาใส่ชื่อประเภทย่อย');
                return;
            }
            
            if (!mainCategory) {
                alert('กรุณาเลือกประเภทหลักก่อน');
                return;
            }
            
            // Add to category data structure
            if (!categoryData[transactionType][mainCategory]) {
                categoryData[transactionType][mainCategory] = [];
            }
            
            if (categoryData[transactionType][mainCategory].includes(subCategoryName)) {
                alert('ประเภทย่อยนี้มีอยู่แล้ว');
                return;
            }
            
            categoryData[transactionType][mainCategory].push(subCategoryName);
            
            // Add to select options
            const option = document.createElement('option');
            option.value = subCategoryName;
            option.textContent = subCategoryName;
            subCategorySelect.appendChild(option);
            
            // Select the new sub category
            subCategorySelect.value = subCategoryName;
            
            // Hide input and clear
            document.getElementById('custom-sub-category-input').classList.add('hidden');
            newCategoryInput.value = '';
            
            updateCategoryDisplay();
            
            alert(`เพิ่มประเภทย่อย "${subCategoryName}" เรียบร้อยแล้ว`);
        }

        // Enter key handler for custom sub category
        document.getElementById('new-sub-category').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                addCustomSubCategory();
            }
        });

        // Add Vendor Button Handler
        document.getElementById('add-vendor-btn').addEventListener('click', function() {
            const customInput = document.getElementById('custom-vendor-input');
            const newVendorInput = document.getElementById('new-vendor');
            
            if (customInput.classList.contains('hidden')) {
                customInput.classList.remove('hidden');
                newVendorInput.focus();
            } else {
                addCustomVendor();
            }
        });

        // Add Custom Vendor Function
        function addCustomVendor() {
            const newVendorInput = document.getElementById('new-vendor');
            const vendorName = newVendorInput.value.trim();
            
            if (!vendorName) {
                alert('กรุณาใส่ชื่อร้านค้า');
                return;
            }
            
            const vendorSelect = document.getElementById('vendor-select');
            
            // Check if vendor already exists
            const existingOptions = Array.from(vendorSelect.options);
            const exists = existingOptions.some(option => option.value === vendorName);
            
            if (exists) {
                alert('ร้านค้านี้มีอยู่แล้ว');
                return;
            }
            
            // Add new option
            const option = document.createElement('option');
            option.value = vendorName;
            option.textContent = vendorName;
            vendorSelect.appendChild(option);
            
            // Select the new vendor
            vendorSelect.value = vendorName;
            
            // Hide input and clear
            document.getElementById('custom-vendor-input').classList.add('hidden');
            newVendorInput.value = '';
            
            alert(`เพิ่มร้านค้า "${vendorName}" เรียบร้อยแล้ว`);
        }

        // Enter key handler for custom vendor
        document.getElementById('new-vendor').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                addCustomVendor();
            }
        });

        // Change Month Function
        function changeMonth(month) {
            window.location.href = `/income-expense?month=${month}`;
        }

        // Export Data Function
        function exportData(category, yearMonth) {
            const url = `/export-${category}/${yearMonth}`;
            window.open(url, '_blank');
        }

        // Export Year Data Function
        function exportYearData(year) {
            const url = `/export-all/${year}`;
            window.open(url, '_blank');
        }

        // Show Monthly Summary Function
        function showMonthlySummary() {
            const selectedMonth = document.getElementById('month-select').value;
            const monthDisplay = document.getElementById('month-select').options[document.getElementById('month-select').selectedIndex].text;
            
            // Get summary data from the page
            const totalIncome = parseFloat('{{ monthly_total_income }}') || 0;
            const totalExpense = parseFloat('{{ monthly_total_expense }}') || 0;
            const balance = totalIncome - totalExpense;
            const totalRecords = parseInt('{{ total_records }}') || 0;
            
            let summary = `📋 สรุปประจำเดือน: ${monthDisplay}\n\n`;
            summary += `💰 รายรับรวม: ${totalIncome.toFixed(2)} บาท\n`;
            summary += `💸 รายจ่ายรวม: ${totalExpense.toFixed(2)} บาท\n`;
            summary += `📊 ยอดคงเหลือ: ${balance.toFixed(2)} บาท\n`;
            summary += `📝 จำนวนรายการ: ${totalRecords} รายการ\n\n`;
            
            if (balance > 0) {
                summary += `✅ สถานะ: มีเงินเหลือ (กำไร)\n`;
            } else if (balance < 0) {
                summary += `⚠️ สถานะ: ใช้เงินเกิน (ขาดทุน)\n`;
            } else {
                summary += `⚖️ สถานะ: เงินเท่ากับรายจ่าย\n`;
            }
            
            // Add percentage analysis
            if (totalIncome > 0) {
                const expensePercentage = ((totalExpense / totalIncome) * 100).toFixed(1);
                summary += `📈 อัตราส่วนรายจ่ายต่อรายรับ: ${expensePercentage}%\n`;
            }
            
            alert(summary);
        }

        // Show Yearly View Function
        function showYearlyView() {
            const currentYear = new Date().getFullYear();
            const selectedMonth = document.getElementById('month-select').value;
            const year = selectedMonth.split('-')[0];
            
            // Redirect to yearly view or show year selection
            const choice = confirm(`ต้องการดูข้อมูลรายปี ${year} หรือไม่?\n\nกด "ตกลง" เพื่อดูข้อมูลรายปี\nกด "ยกเลิก" เพื่อเลือกปีอื่น`);
            
            if (choice) {
                // Redirect to yearly view (you can create this route)
                window.location.href = `/income-expense/year/${year}`;
            } else {
                // Show year selection
                const newYear = prompt('กรุณาใส่ปีที่ต้องการดู (เช่น 2025):', year);
                if (newYear && /^\d{4}$/.test(newYear)) {
                    window.location.href = `/income-expense/year/${newYear}`;
                }
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Set today's date as default
            const today = new Date().toISOString().split('T')[0];
            document.querySelector('input[name="date"]').value = today;
            
            // Auto refresh after form submission
            if (window.location.search.includes('success=true')) {
                setTimeout(() => {
                    window.location.href = window.location.pathname;
                }, 2000);
            }
            
            // Handle window resize for responsive design
            window.addEventListener('resize', function() {
                if (selectedItems.length > 0) {
                    updateItemsDisplay();
                }
            });
        });
    </script>
</body>
</html>